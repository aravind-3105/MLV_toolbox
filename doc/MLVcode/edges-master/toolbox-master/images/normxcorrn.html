<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of normxcorrn</title>
  <meta name="keywords" content="normxcorrn">
  <meta name="description" content="Normalized n-dimensional cross-correlation.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">MLVcode</a> &gt; <a href="../../index.html">edges-master</a> &gt; <a href="#">toolbox-master</a> &gt; <a href="index.html">images</a> &gt; normxcorrn.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for MLVcode\edges-master\toolbox-master\images&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>normxcorrn
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Normalized n-dimensional cross-correlation.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function C = normxcorrn( T, A, shape, Tm ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Normalized n-dimensional cross-correlation.

 For 2 dimensional inputs this function is exactly the same as normxcorr2,
 but also works in higher dimensions.   For more information see help on
 normxcorr2.m.  Also see Forsyth &amp; Ponce 11.3.1 (p241).

 Also, it can take an additional argument that specifies a figure ground
 mask for the T.  That is Tm must be of the same dimensions as T, with
 each entry being 0 or 1, where zero specifies regions to ignore (the
 ground) and 1 specifies interesting regions (the figure).  Essentially Tm
 specifies regions in T that are interesting and should be taken into
 account when doing normalized cross correlation. This allows for
 templates of arbitrary shape, and not just squares. Note: with a mask,
 this function is approximately 3 times slower because it cannot use the
 trick of precomputing running sums.

 USAGE
  C = normxcorrn( T, A, [shape], [Tm] )

 INPUTS
  T           - template to correlate to each window in A
  A           - matrix to correlate T to
  shape       - ['full'] 'valid', 'full', or 'same', see convnFast help
  Tm          - [] figure/ground mask for the template

 OUTPUTS
  C           - correlation matrix

 EXAMPLE
  T=gaussSmooth(rand(20),2); A=repmat(T,[3 3]);  Tm=ones(size(T));
  C1=normxcorrn(T,A);  C2=normxcorr2(T,A);  C3=normxcorrn(T,A,[],Tm);
  figure(1); im(C1);  figure(2); im(C2);  figure(3); im(C3);
  figure(4); im(abs(C1-C2));  figure(5); im(abs(C2-C3));

 See also <a href="xeucn.html" class="code" title="function C = xeucn( A, T, shape )">XEUCN</a>, <a href="xcorrn.html" class="code" title="function C = xcorrn( A, T, shape )">XCORRN</a>, <a href="convnFast.html" class="code" title="function C = convnFast( A, B, shape )">CONVNFAST</a>

 Piotr's Computer Vision Matlab Toolbox      Version 2.0
 Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]
 Licensed under the Simplified BSD License [see external/bsd.txt]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="convnFast.html" class="code" title="function C = convnFast( A, B, shape )">convnFast</a>	Fast convolution, replacement for both conv2 and convn.</li><li><a href="localSum.html" class="code" title="function I = localSum( I, dims, shape, op )">localSum</a>	Fast routine for box, max and min filtering.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function C = normxcorrn( T, A, shape, Tm )</a>
0002 <span class="comment">% Normalized n-dimensional cross-correlation.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% For 2 dimensional inputs this function is exactly the same as normxcorr2,</span>
0005 <span class="comment">% but also works in higher dimensions.   For more information see help on</span>
0006 <span class="comment">% normxcorr2.m.  Also see Forsyth &amp; Ponce 11.3.1 (p241).</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Also, it can take an additional argument that specifies a figure ground</span>
0009 <span class="comment">% mask for the T.  That is Tm must be of the same dimensions as T, with</span>
0010 <span class="comment">% each entry being 0 or 1, where zero specifies regions to ignore (the</span>
0011 <span class="comment">% ground) and 1 specifies interesting regions (the figure).  Essentially Tm</span>
0012 <span class="comment">% specifies regions in T that are interesting and should be taken into</span>
0013 <span class="comment">% account when doing normalized cross correlation. This allows for</span>
0014 <span class="comment">% templates of arbitrary shape, and not just squares. Note: with a mask,</span>
0015 <span class="comment">% this function is approximately 3 times slower because it cannot use the</span>
0016 <span class="comment">% trick of precomputing running sums.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% USAGE</span>
0019 <span class="comment">%  C = normxcorrn( T, A, [shape], [Tm] )</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% INPUTS</span>
0022 <span class="comment">%  T           - template to correlate to each window in A</span>
0023 <span class="comment">%  A           - matrix to correlate T to</span>
0024 <span class="comment">%  shape       - ['full'] 'valid', 'full', or 'same', see convnFast help</span>
0025 <span class="comment">%  Tm          - [] figure/ground mask for the template</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% OUTPUTS</span>
0028 <span class="comment">%  C           - correlation matrix</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% EXAMPLE</span>
0031 <span class="comment">%  T=gaussSmooth(rand(20),2); A=repmat(T,[3 3]);  Tm=ones(size(T));</span>
0032 <span class="comment">%  C1=normxcorrn(T,A);  C2=normxcorr2(T,A);  C3=normxcorrn(T,A,[],Tm);</span>
0033 <span class="comment">%  figure(1); im(C1);  figure(2); im(C2);  figure(3); im(C3);</span>
0034 <span class="comment">%  figure(4); im(abs(C1-C2));  figure(5); im(abs(C2-C3));</span>
0035 <span class="comment">%</span>
0036 <span class="comment">% See also XEUCN, XCORRN, CONVNFAST</span>
0037 <span class="comment">%</span>
0038 <span class="comment">% Piotr's Computer Vision Matlab Toolbox      Version 2.0</span>
0039 <span class="comment">% Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]</span>
0040 <span class="comment">% Licensed under the Simplified BSD License [see external/bsd.txt]</span>
0041 
0042 <span class="keyword">if</span>( nargin&lt;3 || isempty(shape)); shape=<span class="string">'full'</span>; <span class="keyword">end</span>
0043 <span class="keyword">if</span>( nargin&lt;4 || isempty(Tm)); Tm=[]; <span class="keyword">end</span>
0044 nd = ndims(T);  
0045 <span class="keyword">if</span>(nd~=ndims(A)); error(<span class="string">'normxcorrn: T and A must have same ndims'</span>); <span class="keyword">end</span>;
0046 
0047 
0048 <span class="keyword">if</span>(isempty(Tm)) <span class="comment">%%% no mask specified</span>
0049   <span class="comment">%if( any(size(T)&gt;size(A)) ) error('T must be smaller than A.'); end;</span>
0050 
0051   <span class="comment">% flip for conv purposes</span>
0052   <span class="keyword">if</span>(nd==2);  T=rot90(T,2);  <span class="keyword">else</span>  <span class="keyword">for</span> d=1:nd; T=flipdim(T,d); <span class="keyword">end</span>;  <span class="keyword">end</span>
0053 
0054   <span class="comment">% center T on 0 and normalize magnitued to 1</span>
0055   n = numel(T);
0056   TN = T - sum(T(:)) / n;  
0057   TN = TN / norm( TN(:) );
0058 
0059   <span class="comment">% Eexpression for normxcorr is between a window Aw of A and T is:</span>
0060   <span class="comment">%  NormXCorr(Aw,T) = sum(AwN .* TN) / mag( AwN ) / mag( TN );</span>
0061   <span class="comment">% Where AwN=Aw-AwAve  and  TN=T-TAve.  The template T is constant, so we</span>
0062   <span class="comment">% normalize TN so that mag( TN )=1.  Also sum(AwN .* TN) = sum(Aw .* TN),</span>
0063   <span class="comment">% since sum(const*TN )=0. Together This gives us:</span>
0064   <span class="comment">%   NormXCorr(Aw,T) = sum(Aw .* TN) / mag( AwN )</span>
0065   <span class="comment">% To get mag(AwN) we exploit the fact that: E[(X-EX)^2]= E[X^2]-E[X]^2:</span>
0066   <span class="comment">%   sqrt(sum((Aw-AwAve).^2)) = sqrt(sum( Aw.^2 ) - n*AwAve^2);</span>
0067   AwAve = <a href="localSum.html" class="code" title="function I = localSum( I, dims, shape, op )">localSum</a>( A, size(T), shape ) / n; <span class="comment">% average of A in each window</span>
0068   AwMag = real(sqrt(<a href="localSum.html" class="code" title="function I = localSum( I, dims, shape, op )">localSum</a>(A.*A,size(T),shape)-n*(AwAve.*AwAve)));
0069   
0070   <span class="comment">% mag of Aw per win</span>
0071   C = <a href="convnFast.html" class="code" title="function C = convnFast( A, B, shape )">convnFast</a>(A,TN,shape) ./ (AwMag+eps);  <span class="comment">% normxcorr in each window</span>
0072   C( AwMag&lt;.00001 ) = 0;                     <span class="comment">% prevent numerical errors</span>
0073 
0074 <span class="keyword">else</span> <span class="comment">%%% mask specified</span>
0075 
0076   n = sum(Tm(:));
0077   <span class="keyword">if</span>(nd~=ndims(Tm)); error(<span class="string">'normxcorrn: T / Tm must have same ndims'</span>); <span class="keyword">end</span>;
0078   <span class="keyword">if</span>(any(size(T)~=size(Tm))); error(<span class="string">'T and Tm must have same dims'</span>); <span class="keyword">end</span>;
0079   <span class="keyword">if</span>(~all(Tm==0 | Tm==1)); error(<span class="string">'elem of Tm must be either 0 or 1'</span>); <span class="keyword">end</span>;
0080   <span class="keyword">if</span>(n==0); error(<span class="string">'Tm must have some nonzero values'</span>); <span class="keyword">end</span>;
0081 
0082   <span class="comment">% center T on 0 and normalize magnitued to 1, excluding ground</span>
0083   <span class="comment">% T= (T-Tav) / ||(T-Tav)||</span>
0084   T(Tm==0)=0;  T = T - sum(T(:)) / n;
0085   T(Tm==0)=0;  T = T / norm( T(:) );
0086 
0087   <span class="comment">% flip for conv purposes</span>
0088   <span class="keyword">if</span>(nd==2); T=rot90(T,2); <span class="keyword">else</span> <span class="keyword">for</span> d=1:nd; T=flipdim(T,d); <span class="keyword">end</span>; <span class="keyword">end</span>
0089   <span class="keyword">if</span>(nd==2); Tm=rot90(Tm,2); <span class="keyword">else</span> <span class="keyword">for</span> d=1:nd; Tm=flipdim(Tm,d); <span class="keyword">end</span>; <span class="keyword">end</span>
0090 
0091   <span class="comment">% get average over each window over A</span>
0092   Aav = <a href="convnFast.html" class="code" title="function C = convnFast( A, B, shape )">convnFast</a>( A, Tm/n, shape );
0093 
0094   <span class="comment">% get magnitude over each window over A &quot;mag(WA-WAav)&quot;</span>
0095   <span class="comment">% We can rewrite the above as &quot;sqrt(SUM(WAi^2)-n*WAav^2)&quot;. so:</span>
0096   Amag = <a href="convnFast.html" class="code" title="function C = convnFast( A, B, shape )">convnFast</a>( A.*A, Tm, shape ) - n * Aav .* Aav;
0097   Amag = sqrt(Amag);  Amag(Amag&lt;.000001)=1;
0098 
0099   <span class="comment">% finally get C.  in each image window, we will now do:</span>
0100   <span class="comment">% &quot;dot(T,(WA-WAav)) / mag(WA-WAav)&quot;</span>
0101   C = <a href="convnFast.html" class="code" title="function C = convnFast( A, B, shape )">convnFast</a>(A,T,shape) - Aav*sum(T(:));
0102   C = C ./ Amag;
0103 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 05-May-2022 14:52:24 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>