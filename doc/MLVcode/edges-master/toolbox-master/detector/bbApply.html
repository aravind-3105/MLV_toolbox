<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of bbApply</title>
  <meta name="keywords" content="bbApply">
  <meta name="description" content="Functions for manipulating bounding boxes (bb).">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">MLVcode</a> &gt; <a href="../../index.html">edges-master</a> &gt; <a href="#">toolbox-master</a> &gt; <a href="index.html">detector</a> &gt; bbApply.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for MLVcode\edges-master\toolbox-master\detector&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>bbApply
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Functions for manipulating bounding boxes (bb).</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function varargout = bbApply( action, varargin ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Functions for manipulating bounding boxes (bb).

 A bounding box (bb) is also known as a position vector or a rectangle
 object. It is a four element vector with the fields: [x y w h]. A set of
 n bbs can be stores as an [nx4] array, most funcitons below can handle
 either a single or multiple bbs. In addtion, typically [nxm] inputs with
 m&gt;4 are ok (with the additional columns ignored/copied to the output).

 bbApply contains a number of utility functions for working with bbs. The
 format for accessing the various utility functions is:
  outputs = bbApply( 'action', inputs );
 The list of functions and help for each is given below. Also, help on
 individual subfunctions can be accessed by: &quot;help bbApply&gt;action&quot;.

 Compute area of bbs.
   bb = bbApply( 'area', bb )
 Shift center of bbs.
   bb = bbApply( 'shift', bb, xdel, ydel )
 Get center of bbs.
   cen = bbApply( 'getCenter', bb )
 Get bb at intersection of bb1 and bb2 (may be empty).
   bb = bbApply( 'intersect', bb1, bb2 )
 Get bb that is union of bb1 and bb2 (smallest bb containing both).
   bb = bbApply( 'union', bb1, bb2 )
 Resize the bbs (without moving their centers).
   bb = bbApply( 'resize', bb, hr, wr, [ar] )
 Fix bb aspect ratios (without moving the bb centers).
   bbr = bbApply( 'squarify', bb, flag, [ar] )
 Draw single or multiple bbs to image (calls rectangle()).
   hs = bbApply( 'draw', bb, [col], [lw], [ls], [prop], [ids] )
 Embed single or multiple bbs directly into image.
  I = bbApply( 'embed', I, bb, [varargin] )
 Crop image regions from I encompassed by bbs.
   [patches, bbs] = bbApply('crop',I,bb,[padEl],[dims])
 Convert bb relative to absolute coordinates and vice-versa.
   bb = bbApply( 'convert', bb, bbRef, isAbs )
 Randomly generate bbs that fall in a specified region.
   bbs =  bbApply( 'random', pRandom )
 Convert weighted mask to bbs.
   bbs = bbApply('frMask',M,bbw,bbh,[thr])
 Create weighted mask encoding bb centers (or extent).
   M = bbApply('toMask',bbs,w,h,[fill],[bgrd])

 USAGE
  varargout = bbApply( action, varargin );

 INPUTS
  action     - string specifying action
  varargin   - depends on action, see above

 OUTPUTS
  varargout  - depends on action, see above

 EXAMPLE

 See also bbApply&gt;area bbApply&gt;shift bbApply&gt;getCenter bbApply&gt;intersect
 bbApply&gt;union bbApply&gt;resize bbApply&gt;squarify bbApply&gt;draw bbApply&gt;crop
 bbApply&gt;convert bbApply&gt;random bbApply&gt;frMask bbApply&gt;toMask

 Piotr's Computer Vision Matlab Toolbox      Version 3.30
 Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]
 Licensed under the Simplified BSD License [see external/bsd.txt]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="acfDemoCal.html" class="code" title="">acfDemoCal</a>	Demo for aggregate channel features object detector on Caltech dataset.</li><li><a href="acfDemoInria.html" class="code" title="">acfDemoInria</a>	Demo for aggregate channel features object detector on Inria dataset.</li><li><a href="acfTrain.html" class="code" title="function detector = acfTrain( varargin )">acfTrain</a>	Train aggregate channel features object detector.</li><li><a href="bbGt.html" class="code" title="function varargout = bbGt( action, varargin )">bbGt</a>	Bounding box (bb) annotations struct, evaluation and sampling routines.</li><li><a href="bbNms.html" class="code" title="function bbs = bbNms( bbs, varargin )">bbNms</a>	Bounding box (bb) non-maximal suppression (nms).</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function a = area( bb )</a></li><li><a href="#_sub2" class="code">function bb = shift( bb, xdel, ydel )</a></li><li><a href="#_sub3" class="code">function cen = getCenter( bb )</a></li><li><a href="#_sub4" class="code">function bb = intersect( bb1, bb2 )</a></li><li><a href="#_sub5" class="code">function bb = union( bb1, bb2 )</a></li><li><a href="#_sub6" class="code">function bb = resize( bb, hr, wr, ar )</a></li><li><a href="#_sub7" class="code">function bbr = squarify( bb, flag, ar )</a></li><li><a href="#_sub8" class="code">function hs = draw( bb, col, lw, ls, prop, ids )</a></li><li><a href="#_sub9" class="code">function I = embed( I, bb, varargin )</a></li><li><a href="#_sub10" class="code">function [patches, bbs] = crop( I, bbs, padEl, dims )</a></li><li><a href="#_sub11" class="code">function [patch, bb] = crop1( bb )</a></li><li><a href="#_sub12" class="code">function bb = convert( bb, bbRef, isAbs )</a></li><li><a href="#_sub13" class="code">function bbs = random( varargin )</a></li><li><a href="#_sub14" class="code">function bbs = frMask( M, bbw, bbh, thr )</a></li><li><a href="#_sub15" class="code">function M = toMask( bbs, w, h, fill, bgrd )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = bbApply( action, varargin )</a>
0002 <span class="comment">% Functions for manipulating bounding boxes (bb).</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% A bounding box (bb) is also known as a position vector or a rectangle</span>
0005 <span class="comment">% object. It is a four element vector with the fields: [x y w h]. A set of</span>
0006 <span class="comment">% n bbs can be stores as an [nx4] array, most funcitons below can handle</span>
0007 <span class="comment">% either a single or multiple bbs. In addtion, typically [nxm] inputs with</span>
0008 <span class="comment">% m&gt;4 are ok (with the additional columns ignored/copied to the output).</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% bbApply contains a number of utility functions for working with bbs. The</span>
0011 <span class="comment">% format for accessing the various utility functions is:</span>
0012 <span class="comment">%  outputs = bbApply( 'action', inputs );</span>
0013 <span class="comment">% The list of functions and help for each is given below. Also, help on</span>
0014 <span class="comment">% individual subfunctions can be accessed by: &quot;help bbApply&gt;action&quot;.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Compute area of bbs.</span>
0017 <span class="comment">%   bb = bbApply( 'area', bb )</span>
0018 <span class="comment">% Shift center of bbs.</span>
0019 <span class="comment">%   bb = bbApply( 'shift', bb, xdel, ydel )</span>
0020 <span class="comment">% Get center of bbs.</span>
0021 <span class="comment">%   cen = bbApply( 'getCenter', bb )</span>
0022 <span class="comment">% Get bb at intersection of bb1 and bb2 (may be empty).</span>
0023 <span class="comment">%   bb = bbApply( 'intersect', bb1, bb2 )</span>
0024 <span class="comment">% Get bb that is union of bb1 and bb2 (smallest bb containing both).</span>
0025 <span class="comment">%   bb = bbApply( 'union', bb1, bb2 )</span>
0026 <span class="comment">% Resize the bbs (without moving their centers).</span>
0027 <span class="comment">%   bb = bbApply( 'resize', bb, hr, wr, [ar] )</span>
0028 <span class="comment">% Fix bb aspect ratios (without moving the bb centers).</span>
0029 <span class="comment">%   bbr = bbApply( 'squarify', bb, flag, [ar] )</span>
0030 <span class="comment">% Draw single or multiple bbs to image (calls rectangle()).</span>
0031 <span class="comment">%   hs = bbApply( 'draw', bb, [col], [lw], [ls], [prop], [ids] )</span>
0032 <span class="comment">% Embed single or multiple bbs directly into image.</span>
0033 <span class="comment">%  I = bbApply( 'embed', I, bb, [varargin] )</span>
0034 <span class="comment">% Crop image regions from I encompassed by bbs.</span>
0035 <span class="comment">%   [patches, bbs] = bbApply('crop',I,bb,[padEl],[dims])</span>
0036 <span class="comment">% Convert bb relative to absolute coordinates and vice-versa.</span>
0037 <span class="comment">%   bb = bbApply( 'convert', bb, bbRef, isAbs )</span>
0038 <span class="comment">% Randomly generate bbs that fall in a specified region.</span>
0039 <span class="comment">%   bbs =  bbApply( 'random', pRandom )</span>
0040 <span class="comment">% Convert weighted mask to bbs.</span>
0041 <span class="comment">%   bbs = bbApply('frMask',M,bbw,bbh,[thr])</span>
0042 <span class="comment">% Create weighted mask encoding bb centers (or extent).</span>
0043 <span class="comment">%   M = bbApply('toMask',bbs,w,h,[fill],[bgrd])</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% USAGE</span>
0046 <span class="comment">%  varargout = bbApply( action, varargin );</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% INPUTS</span>
0049 <span class="comment">%  action     - string specifying action</span>
0050 <span class="comment">%  varargin   - depends on action, see above</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% OUTPUTS</span>
0053 <span class="comment">%  varargout  - depends on action, see above</span>
0054 <span class="comment">%</span>
0055 <span class="comment">% EXAMPLE</span>
0056 <span class="comment">%</span>
0057 <span class="comment">% See also bbApply&gt;area bbApply&gt;shift bbApply&gt;getCenter bbApply&gt;intersect</span>
0058 <span class="comment">% bbApply&gt;union bbApply&gt;resize bbApply&gt;squarify bbApply&gt;draw bbApply&gt;crop</span>
0059 <span class="comment">% bbApply&gt;convert bbApply&gt;random bbApply&gt;frMask bbApply&gt;toMask</span>
0060 <span class="comment">%</span>
0061 <span class="comment">% Piotr's Computer Vision Matlab Toolbox      Version 3.30</span>
0062 <span class="comment">% Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]</span>
0063 <span class="comment">% Licensed under the Simplified BSD License [see external/bsd.txt]</span>
0064 
0065 <span class="comment">%#ok&lt;*DEFNU&gt;</span>
0066 varargout = cell(1,max(1,nargout));
0067 [varargout{:}] = feval(action,varargin{:});
0068 <span class="keyword">end</span>
0069 
0070 <a name="_sub1" href="#_subfunctions" class="code">function a = area( bb )</a>
0071 <span class="comment">% Compute area of bbs.</span>
0072 <span class="comment">%</span>
0073 <span class="comment">% USAGE</span>
0074 <span class="comment">%  bb = bbApply( 'area', bb )</span>
0075 <span class="comment">%</span>
0076 <span class="comment">% INPUTS</span>
0077 <span class="comment">%  bb     - [nx4] original bbs</span>
0078 <span class="comment">%</span>
0079 <span class="comment">% OUTPUTS</span>
0080 <span class="comment">%  a      - [nx1] area of each bb</span>
0081 <span class="comment">%</span>
0082 <span class="comment">% EXAMPLE</span>
0083 <span class="comment">%  a = bbApply('area', [0 0 10 10])</span>
0084 <span class="comment">%</span>
0085 <span class="comment">% See also bbApply</span>
0086 a=prod(bb(:,3:4),2);
0087 <span class="keyword">end</span>
0088 
0089 <a name="_sub2" href="#_subfunctions" class="code">function bb = shift( bb, xdel, ydel )</a>
0090 <span class="comment">% Shift center of bbs.</span>
0091 <span class="comment">%</span>
0092 <span class="comment">% USAGE</span>
0093 <span class="comment">%  bb = bbApply( 'shift', bb, xdel, ydel )</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% INPUTS</span>
0096 <span class="comment">%  bb     - [nx4] original bbs</span>
0097 <span class="comment">%  xdel   - amount to shift x coord of each bb left</span>
0098 <span class="comment">%  ydel   - amount to shift y coord of each bb up</span>
0099 <span class="comment">%</span>
0100 <span class="comment">% OUTPUTS</span>
0101 <span class="comment">%  bb     - [nx4] shifted bbs</span>
0102 <span class="comment">%</span>
0103 <span class="comment">% EXAMPLE</span>
0104 <span class="comment">%  bb = bbApply('shift', [0 0 10 10], 1, 2)</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% See also bbApply</span>
0107 bb(:,1)=bb(:,1)-xdel; bb(:,2)=bb(:,2)-ydel;
0108 <span class="keyword">end</span>
0109 
0110 <a name="_sub3" href="#_subfunctions" class="code">function cen = getCenter( bb )</a>
0111 <span class="comment">% Get center of bbs.</span>
0112 <span class="comment">%</span>
0113 <span class="comment">% USAGE</span>
0114 <span class="comment">%  cen = bbApply( 'getCenter', bb )</span>
0115 <span class="comment">%</span>
0116 <span class="comment">% INPUTS</span>
0117 <span class="comment">%  bb     - [nx4] original bbs</span>
0118 <span class="comment">%</span>
0119 <span class="comment">% OUTPUTS</span>
0120 <span class="comment">%  cen    - [nx1] centers of bbs</span>
0121 <span class="comment">%</span>
0122 <span class="comment">% EXAMPLE</span>
0123 <span class="comment">%  cen = bbApply('getCenter', [0 0 10 10])</span>
0124 <span class="comment">%</span>
0125 <span class="comment">% See also bbApply</span>
0126 cen=bb(:,1:2)+bb(:,3:4)/2;
0127 <span class="keyword">end</span>
0128 
0129 <a name="_sub4" href="#_subfunctions" class="code">function bb = intersect( bb1, bb2 )</a>
0130 <span class="comment">% Get bb at intersection of bb1 and bb2 (may be empty).</span>
0131 <span class="comment">%</span>
0132 <span class="comment">% USAGE</span>
0133 <span class="comment">%  bb = bbApply( 'intersect', bb1, bb2 )</span>
0134 <span class="comment">%</span>
0135 <span class="comment">% INPUTS</span>
0136 <span class="comment">%  bb1    - [nx4] first set of bbs</span>
0137 <span class="comment">%  bb2    - [nx4] second set of bbs</span>
0138 <span class="comment">%</span>
0139 <span class="comment">% OUTPUTS</span>
0140 <span class="comment">%  bb     - [nx4] intersection of bbs</span>
0141 <span class="comment">%</span>
0142 <span class="comment">% EXAMPLE</span>
0143 <span class="comment">%  bb = bbApply('intersect', [0 0 10 10], [5 5 10 10])</span>
0144 <span class="comment">%</span>
0145 <span class="comment">% See also bbApply bbApply&gt;union</span>
0146 n1=size(bb1,1); n2=size(bb2,1);
0147 <span class="keyword">if</span>(n1==0 || n2==0), bb=zeros(0,4); <span class="keyword">return</span>, <span class="keyword">end</span>
0148 <span class="keyword">if</span>(n1==1 &amp;&amp; n2&gt;1), bb1=repmat(bb1,n2,1); n1=n2; <span class="keyword">end</span>
0149 <span class="keyword">if</span>(n2==1 &amp;&amp; n1&gt;1), bb2=repmat(bb2,n1,1); n2=n1; <span class="keyword">end</span>
0150 assert(n1==n2);
0151 lcsE=min(bb1(:,1:2)+bb1(:,3:4),bb2(:,1:2)+bb2(:,3:4));
0152 lcsS=max(bb1(:,1:2),bb2(:,1:2)); empty=any(lcsE&lt;lcsS,2);
0153 bb=[lcsS lcsE-lcsS]; bb(empty,:)=0;
0154 <span class="keyword">end</span>
0155 
0156 <a name="_sub5" href="#_subfunctions" class="code">function bb = union( bb1, bb2 )</a>
0157 <span class="comment">% Get bb that is union of bb1 and bb2 (smallest bb containing both).</span>
0158 <span class="comment">%</span>
0159 <span class="comment">% USAGE</span>
0160 <span class="comment">%  bb = bbApply( 'union', bb1, bb2 )</span>
0161 <span class="comment">%</span>
0162 <span class="comment">% INPUTS</span>
0163 <span class="comment">%  bb1    - [nx4] first set of bbs</span>
0164 <span class="comment">%  bb2    - [nx4] second set of bbs</span>
0165 <span class="comment">%</span>
0166 <span class="comment">% OUTPUTS</span>
0167 <span class="comment">%  bb     - [nx4] intersection of bbs</span>
0168 <span class="comment">%</span>
0169 <span class="comment">% EXAMPLE</span>
0170 <span class="comment">%  bb = bbApply('union', [0 0 10 10], [5 5 10 10])</span>
0171 <span class="comment">%</span>
0172 <span class="comment">% See also bbApply bbApply&gt;intersect</span>
0173 n1=size(bb1,1); n2=size(bb2,1);
0174 <span class="keyword">if</span>(n1==0 || n2==0), bb=zeros(0,4); <span class="keyword">return</span>, <span class="keyword">end</span>
0175 <span class="keyword">if</span>(n1==1 &amp;&amp; n2&gt;1), bb1=repmat(bb1,n2,1); n1=n2; <span class="keyword">end</span>
0176 <span class="keyword">if</span>(n2==1 &amp;&amp; n1&gt;1), bb2=repmat(bb2,n1,1); n2=n1; <span class="keyword">end</span>
0177 assert(n1==n2);
0178 lcsE=max(bb1(:,1:2)+bb1(:,3:4),bb2(:,1:2)+bb2(:,3:4));
0179 lcsS=min(bb1(:,1:2),bb2(:,1:2));
0180 bb=[lcsS lcsE-lcsS];
0181 <span class="keyword">end</span>
0182 
0183 <a name="_sub6" href="#_subfunctions" class="code">function bb = resize( bb, hr, wr, ar )</a>
0184 <span class="comment">% Resize the bbs (without moving their centers).</span>
0185 <span class="comment">%</span>
0186 <span class="comment">% If wr&gt;0 or hr&gt;0, the w/h of each bb is adjusted in the following order:</span>
0187 <span class="comment">%  if(hr~=0), h=h*hr; end</span>
0188 <span class="comment">%  if(wr~=0), w=w*wr; end</span>
0189 <span class="comment">%  if(hr==0), h=w/ar; end</span>
0190 <span class="comment">%  if(wr==0), w=h*ar; end</span>
0191 <span class="comment">% Only one of hr/wr may be set to 0, and then only if ar&gt;0. If, however,</span>
0192 <span class="comment">% hr=wr=0 and ar&gt;0 then resizes bbs such that areas and centers are</span>
0193 <span class="comment">% preserved but aspect ratio becomes ar.</span>
0194 <span class="comment">%</span>
0195 <span class="comment">% USAGE</span>
0196 <span class="comment">%  bb = bbApply( 'resize', bb, hr, wr, [ar] )</span>
0197 <span class="comment">%</span>
0198 <span class="comment">% INPUTS</span>
0199 <span class="comment">%  bb     - [nx4] original bbs</span>
0200 <span class="comment">%  hr     - ratio by which to multiply height (or 0)</span>
0201 <span class="comment">%  wr     - ratio by which to multiply width (or 0)</span>
0202 <span class="comment">%  ar     - [0] target aspect ratio (used only if hr=0 or wr=0)</span>
0203 <span class="comment">%</span>
0204 <span class="comment">% OUTPUT</span>
0205 <span class="comment">%  bb    - [nx4] the output resized bbs</span>
0206 <span class="comment">%</span>
0207 <span class="comment">% EXAMPLE</span>
0208 <span class="comment">%  bb = bbApply('resize',[0 0 1 1],1.2,0,.5) % h'=1.2*h; w'=h'/2;</span>
0209 <span class="comment">%</span>
0210 <span class="comment">% See also bbApply, bbApply&gt;squarify</span>
0211 <span class="keyword">if</span>(nargin&lt;4), ar=0; <span class="keyword">end</span>; assert(size(bb,2)&gt;=4);
0212 assert((hr&gt;0&amp;&amp;wr&gt;0)||ar&gt;0);
0213 <span class="comment">% preserve area and center, set aspect ratio</span>
0214 <span class="keyword">if</span>(hr==0 &amp;&amp; wr==0), a=sqrt(bb(:,3).*bb(:,4)); ar=sqrt(ar);
0215   d=a*ar-bb(:,3); bb(:,1)=bb(:,1)-d/2; bb(:,3)=bb(:,3)+d;
0216   d=a/ar-bb(:,4); bb(:,2)=bb(:,2)-d/2; bb(:,4)=bb(:,4)+d; <span class="keyword">return</span>;
0217 <span class="keyword">end</span>
0218 <span class="comment">% possibly adjust h/w based on hr/wr</span>
0219 <span class="keyword">if</span>(hr~=0), d=(hr-1)*bb(:,4); bb(:,2)=bb(:,2)-d/2; bb(:,4)=bb(:,4)+d; <span class="keyword">end</span>
0220 <span class="keyword">if</span>(wr~=0), d=(wr-1)*bb(:,3); bb(:,1)=bb(:,1)-d/2; bb(:,3)=bb(:,3)+d; <span class="keyword">end</span>
0221 <span class="comment">% possibly adjust h/w based on ar and NEW h/w</span>
0222 <span class="keyword">if</span>(~hr), d=bb(:,3)/ar-bb(:,4); bb(:,2)=bb(:,2)-d/2; bb(:,4)=bb(:,4)+d; <span class="keyword">end</span>
0223 <span class="keyword">if</span>(~wr), d=bb(:,4)*ar-bb(:,3); bb(:,1)=bb(:,1)-d/2; bb(:,3)=bb(:,3)+d; <span class="keyword">end</span>
0224 <span class="keyword">end</span>
0225 
0226 <a name="_sub7" href="#_subfunctions" class="code">function bbr = squarify( bb, flag, ar )</a>
0227 <span class="comment">% Fix bb aspect ratios (without moving the bb centers).</span>
0228 <span class="comment">%</span>
0229 <span class="comment">% The w or h of each bb is adjusted so that w/h=ar.</span>
0230 <span class="comment">% The parameter flag controls whether w or h should change:</span>
0231 <span class="comment">%  flag==0: expand bb to given ar</span>
0232 <span class="comment">%  flag==1: shrink bb to given ar</span>
0233 <span class="comment">%  flag==2: use original w, alter h</span>
0234 <span class="comment">%  flag==3: use original h, alter w</span>
0235 <span class="comment">%  flag==4: preserve area, alter w and h</span>
0236 <span class="comment">% If ar==1 (the default), always converts bb to a square, hence the name.</span>
0237 <span class="comment">%</span>
0238 <span class="comment">% USAGE</span>
0239 <span class="comment">%  bbr = bbApply( 'squarify', bb, flag, [ar] )</span>
0240 <span class="comment">%</span>
0241 <span class="comment">% INPUTS</span>
0242 <span class="comment">%  bb     - [nx4] original bbs</span>
0243 <span class="comment">%  flag   - controls whether w or h should change</span>
0244 <span class="comment">%  ar     - [1] desired aspect ratio</span>
0245 <span class="comment">%</span>
0246 <span class="comment">% OUTPUT</span>
0247 <span class="comment">%  bbr    - the output 'squarified' bbs</span>
0248 <span class="comment">%</span>
0249 <span class="comment">% EXAMPLE</span>
0250 <span class="comment">%  bbr = bbApply('squarify',[0 0 1 2],0)</span>
0251 <span class="comment">%</span>
0252 <span class="comment">% See also bbApply, bbApply&gt;resize</span>
0253 <span class="keyword">if</span>(nargin&lt;3 || isempty(ar)), ar=1; <span class="keyword">end</span>; bbr=bb;
0254 <span class="keyword">if</span>(flag==4), bbr=<a href="#_sub6" class="code" title="subfunction bb = resize( bb, hr, wr, ar )">resize</a>(bb,0,0,ar); <span class="keyword">return</span>; <span class="keyword">end</span>
0255 <span class="keyword">for</span> i=1:size(bb,1), p=bb(i,1:4);
0256   usew = (flag==0 &amp;&amp; p(3)&gt;p(4)*ar) || (flag==1 &amp;&amp; p(3)&lt;p(4)*ar) || flag==2;
0257   <span class="keyword">if</span>(usew), p=<a href="#_sub6" class="code" title="subfunction bb = resize( bb, hr, wr, ar )">resize</a>(p,0,1,ar); <span class="keyword">else</span> p=<a href="#_sub6" class="code" title="subfunction bb = resize( bb, hr, wr, ar )">resize</a>(p,1,0,ar); <span class="keyword">end</span>; bbr(i,1:4)=p;
0258 <span class="keyword">end</span>
0259 <span class="keyword">end</span>
0260 
0261 <a name="_sub8" href="#_subfunctions" class="code">function hs = draw( bb, col, lw, ls, prop, ids )</a>
0262 <span class="comment">% Draw single or multiple bbs to image (calls rectangle()).</span>
0263 <span class="comment">%</span>
0264 <span class="comment">% To draw bbs aligned with pixel boundaries, subtract .5 from the x and y</span>
0265 <span class="comment">% coordinates (since pixel centers are located at integer locations).</span>
0266 <span class="comment">%</span>
0267 <span class="comment">% USAGE</span>
0268 <span class="comment">%  hs = bbApply( 'draw', bb, [col], [lw], [ls], [prop], [ids] )</span>
0269 <span class="comment">%</span>
0270 <span class="comment">% INPUTS</span>
0271 <span class="comment">%  bb     - [nx4] standard bbs or [nx5] weighted bbs</span>
0272 <span class="comment">%  col    - ['g'] color or [kx1] array of colors</span>
0273 <span class="comment">%  lw     - [2] LineWidth for rectangle</span>
0274 <span class="comment">%  ls     - ['-'] LineStyle for rectangle</span>
0275 <span class="comment">%  prop   - [] other properties for rectangle</span>
0276 <span class="comment">%  ids    - [ones(1,n)] id in [1,k] for each bb into colors array</span>
0277 <span class="comment">%</span>
0278 <span class="comment">% OUTPUT</span>
0279 <span class="comment">%  hs     - [nx1] handles to drawn rectangles (and labels)</span>
0280 <span class="comment">%</span>
0281 <span class="comment">% EXAMPLE</span>
0282 <span class="comment">%  im(rand(3)); bbApply('draw',[1.5 1.5 1 1 .5],'g');</span>
0283 <span class="comment">%</span>
0284 <span class="comment">% See also bbApply, bbApply&gt;embed, rectangle</span>
0285 [n,m]=size(bb); <span class="keyword">if</span>(n==0), hs=[]; <span class="keyword">return</span>; <span class="keyword">end</span>
0286 <span class="keyword">if</span>(nargin&lt;2 || isempty(col)), col=[]; <span class="keyword">end</span>
0287 <span class="keyword">if</span>(nargin&lt;3 || isempty(lw)), lw=2; <span class="keyword">end</span>
0288 <span class="keyword">if</span>(nargin&lt;4 || isempty(ls)), ls=<span class="string">'-'</span>; <span class="keyword">end</span>
0289 <span class="keyword">if</span>(nargin&lt;5 || isempty(prop)), prop={}; <span class="keyword">end</span>
0290 <span class="keyword">if</span>(nargin&lt;6 || isempty(ids)), ids=ones(1,n); <span class="keyword">end</span>
0291 <span class="comment">% prepare display properties</span>
0292 prop=[<span class="string">'LineWidth'</span> lw <span class="string">'LineStyle'</span> ls prop <span class="string">'EdgeColor'</span>];
0293 tProp={<span class="string">'FontSize'</span>,10,<span class="string">'color'</span>,<span class="string">'w'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
0294   <span class="string">'VerticalAlignment'</span>,<span class="string">'bottom'</span>}; k=max(ids);
0295 <span class="keyword">if</span>(isempty(col)), <span class="keyword">if</span>(k==1), col=<span class="string">'g'</span>; <span class="keyword">else</span> col=hsv(k); <span class="keyword">end</span>; <span class="keyword">end</span>
0296 <span class="keyword">if</span>(size(col,1)&lt;k), ids=ones(1,n); <span class="keyword">end</span>; hs=zeros(1,n);
0297 <span class="comment">% draw rectangles and optionally labels</span>
0298 <span class="keyword">for</span> b=1:n, hs(b)=rectangle(<span class="string">'Position'</span>,bb(b,1:4),prop{:},col(ids(b),:)); <span class="keyword">end</span>
0299 <span class="keyword">if</span>(m==4), <span class="keyword">return</span>; <span class="keyword">end</span>; hs=[hs zeros(1,n)]; bb=double(bb);
0300 <span class="keyword">for</span> b=1:n, hs(b+n)=text(bb(b,1),bb(b,2),num2str(bb(b,5),4),tProp{:}); <span class="keyword">end</span>
0301 <span class="keyword">end</span>
0302 
0303 <a name="_sub9" href="#_subfunctions" class="code">function I = embed( I, bb, varargin )</a>
0304 <span class="comment">% Embed single or multiple bbs directly into image.</span>
0305 <span class="comment">%</span>
0306 <span class="comment">% USAGE</span>
0307 <span class="comment">%  I = bbApply( 'embed', I, bb, varargin )</span>
0308 <span class="comment">%</span>
0309 <span class="comment">% INPUTS</span>
0310 <span class="comment">%  I      - input image</span>
0311 <span class="comment">%  bb     - [nx4] or [nx5] input bbs</span>
0312 <span class="comment">%  varargin   - additional params (struct or name/value pairs)</span>
0313 <span class="comment">%    .col       - [0 255 0] color for rectangle or nx3 array of colors</span>
0314 <span class="comment">%    .lw        - [3] width for rectangle in pixels</span>
0315 <span class="comment">%    .fh        - [35] font height (if displaying weight), may be 0</span>
0316 <span class="comment">%    .fcol      - [255 0 0] font color or nx3 array of colors</span>
0317 <span class="comment">%</span>
0318 <span class="comment">% OUTPUT</span>
0319 <span class="comment">%  I      - output image</span>
0320 <span class="comment">%</span>
0321 <span class="comment">% EXAMPLE</span>
0322 <span class="comment">%  I=imResample(imread('cameraman.tif'),2); bb=[200 70 70 90 0.25];</span>
0323 <span class="comment">%  J=bbApply('embed',I,bb,'col',[0 0 255],'lw',8,'fh',30); figure(1); im(J)</span>
0324 <span class="comment">%  K=bbApply('embed',J,bb,'col',[0 255 0],'lw',2,'fh',30); figure(2); im(K)</span>
0325 <span class="comment">%</span>
0326 <span class="comment">% See also bbApply, bbApply&gt;draw, char2img</span>
0327 
0328 <span class="comment">% get additional parameters</span>
0329 dfs={<span class="string">'col'</span>,[0 255 0],<span class="string">'lw'</span>,3,<span class="string">'fh'</span>,35,<span class="string">'fcol'</span>,[255 0 0]};
0330 [col,lw,fh,fcol]=getPrmDflt(varargin,dfs,1);
0331 n=size(bb,1); bb(:,1:4)=round(bb(:,1:4));
0332 <span class="keyword">if</span>(size(col,1)==1), col=col(ones(1,n),:); <span class="keyword">end</span>
0333 <span class="keyword">if</span>(size(fcol,1)==1), fcol=fcol(ones(1,n),:); <span class="keyword">end</span>
0334 <span class="keyword">if</span>( ismatrix(I) ), I=I(:,:,[1 1 1]); <span class="keyword">end</span>
0335 <span class="comment">% embed each bb</span>
0336 x0=bb(:,1); x1=x0+bb(:,3)-1; y0=bb(:,2); y1=y0+bb(:,4)-1;
0337 j0=floor((lw-1)/2); j1=ceil((lw-1)/2); h=size(I,1); w=size(I,2);
0338 x00=max(1,x0-j0); x01=min(x0+j1,w); x10=max(1,x1-j0); x11=min(x1+j1,w);
0339 y00=max(1,y0-j0); y01=min(y0+j1,h); y10=max(1,y1-j0); y11=min(y1+j1,h);
0340 <span class="keyword">for</span> b=1:n
0341   <span class="keyword">for</span> c=1:3, I([y00(b):y01(b) y10(b):y11(b)],x00(b):x11(b),c)=col(b,c); <span class="keyword">end</span>
0342   <span class="keyword">for</span> c=1:3, I(y00(b):y11(b),[x00(b):x01(b) x10(b):x11(b)],c)=col(b,c); <span class="keyword">end</span>
0343 <span class="keyword">end</span>
0344 <span class="comment">% embed text displaying bb score (inside upper-left bb corner)</span>
0345 <span class="keyword">if</span>(size(bb,2)&lt;5 || fh==0), <span class="keyword">return</span>; <span class="keyword">end</span>
0346 bb(:,1:4)=<a href="#_sub4" class="code" title="subfunction bb = intersect( bb1, bb2 )">intersect</a>(bb(:,1:4),[1 1 w h]);
0347 <span class="keyword">for</span> b=1:n
0348   M=char2img(sprintf(<span class="string">'%.4g'</span>,bb(b,5)),fh); M=M{1}==0; [h,w]=size(M);
0349   y0=bb(b,2); y1=y0+h-1; x0=bb(b,1); x1=x0+w-1;
0350   <span class="keyword">if</span>( x0&gt;=1 &amp;&amp; y0&gt;=1 &amp;&amp; x1&lt;=size(I,2) &amp;&amp; y1&lt;=size(I,1))
0351     Ir=I(y0:y1,x0:x1,1); Ig=I(y0:y1,x0:x1,2); Ib=I(y0:y1,x0:x1,3);
0352     Ir(M)=fcol(b,1); Ig(M)=fcol(b,2); Ib(M)=fcol(b,3);
0353     I(y0:y1,x0:x1,:)=cat(3,Ir,Ig,Ib);
0354   <span class="keyword">end</span>
0355 <span class="keyword">end</span>
0356 <span class="keyword">end</span>
0357 
0358 <a name="_sub10" href="#_subfunctions" class="code">function [patches, bbs] = crop( I, bbs, padEl, dims )</a>
0359 <span class="comment">% Crop image regions from I encompassed by bbs.</span>
0360 <span class="comment">%</span>
0361 <span class="comment">% The only subtlety is that a pixel centered at location (i,j) would have a</span>
0362 <span class="comment">% bb of [j-1/2,i-1/2,1,1].  The -1/2 is because pixels are located at</span>
0363 <span class="comment">% integer locations. This is a Matlab convention, to confirm use:</span>
0364 <span class="comment">%  im(rand(3)); bbApply('draw',[1.5 1.5 1 1],'g')</span>
0365 <span class="comment">% If bb contains all integer entries cropping is straightforward. If</span>
0366 <span class="comment">% entries are not integers, x=round(x+.499) is used, eg 1.2 actually goes</span>
0367 <span class="comment">% to 2 (since it is closer to 1.5 then .5), and likewise for y.</span>
0368 <span class="comment">%</span>
0369 <span class="comment">% If ~isempty(padEl), image is padded so can extract full bb region (no</span>
0370 <span class="comment">% actual padding is done, this is fast). Otherwise bb is intersected with</span>
0371 <span class="comment">% the image bb prior to cropping. If padEl is a string ('circular',</span>
0372 <span class="comment">% 'replicate', or 'symmetric'), uses padarray to do actual padding (slow).</span>
0373 <span class="comment">%</span>
0374 <span class="comment">% USAGE</span>
0375 <span class="comment">%  [patches, bbs] = bbApply('crop',I,bb,[padEl],[dims])</span>
0376 <span class="comment">%</span>
0377 <span class="comment">% INPUTS</span>
0378 <span class="comment">%  I        - image from which to crop patches</span>
0379 <span class="comment">%  bbs      - bbs that indicate regions to crop</span>
0380 <span class="comment">%  padEl    - [0] value to pad I or [] to indicate no padding (see above)</span>
0381 <span class="comment">%  dims     - [] if specified resize each cropped patch to [w h]</span>
0382 <span class="comment">%</span>
0383 <span class="comment">% OUTPUTS</span>
0384 <span class="comment">%  patches  - [1xn] cell of cropped image regions</span>
0385 <span class="comment">%  bbs      - actual integer-valued bbs used to crop</span>
0386 <span class="comment">%</span>
0387 <span class="comment">% EXAMPLE</span>
0388 <span class="comment">%  I=imread('cameraman.tif'); bb=[-10 -10 100 100];</span>
0389 <span class="comment">%  p1=bbApply('crop',I,bb); p2=bbApply('crop',I,bb,'replicate');</span>
0390 <span class="comment">%  figure(1); im(I); figure(2); im(p1{1}); figure(3); im(p2{1});</span>
0391 <span class="comment">%</span>
0392 <span class="comment">% See also bbApply, ARRAYCROP, PADARRAY, IMRESAMPLE</span>
0393 
0394 <span class="comment">% get padEl, bound bb to visible region if empty</span>
0395 <span class="keyword">if</span>( nargin&lt;3 ), padEl=0; <span class="keyword">end</span>; h=size(I,1); w=size(I,2);
0396 <span class="keyword">if</span>( nargin&lt;4 ), dims=[]; <span class="keyword">end</span>;
0397 <span class="keyword">if</span>(isempty(padEl)), bbs=<a href="#_sub4" class="code" title="subfunction bb = intersect( bb1, bb2 )">intersect</a>([.5 .5 w h],bbs); <span class="keyword">end</span>
0398 <span class="comment">% crop each patch in turn</span>
0399 n=size(bbs,1); patches=cell(1,n);
0400 <span class="keyword">for</span> i=1:n, [patches{i},bbs(i,1:4)]=<a href="#_sub11" class="code" title="subfunction [patch, bb] = crop1( bb )">crop1</a>(bbs(i,1:4)); <span class="keyword">end</span>
0401 
0402   <a name="_sub11" href="#_subfunctions" class="code">function [patch, bb] = crop1( bb )</a>
0403     <span class="comment">% crop single patch (use arrayCrop only if necessary)</span>
0404     lcsS=round(bb([2 1])+.5-.001); lcsE=lcsS+round(bb([4 3]))-1;
0405     <span class="keyword">if</span>( any(lcsS&lt;1) || lcsE(1)&gt;h || lcsE(2)&gt;w )
0406       <span class="keyword">if</span>( ischar(padEl) )
0407         pt=max(0,1-lcsS(1)); pb=max(0,lcsE(1)-h);
0408         pl=max(0,1-lcsS(2)); pr=max(0,lcsE(2)-w);
0409         lcsS1=max(1,lcsS); lcsE1=min(lcsE,[h w]);
0410         patch = I(lcsS1(1):lcsE1(1),lcsS1(2):lcsE1(2),:);
0411         patch = padarray(patch,[pt pl],padEl,<span class="string">'pre'</span>);
0412         patch = padarray(patch,[pb pr],padEl,<span class="string">'post'</span>);
0413       <span class="keyword">else</span>
0414         <span class="keyword">if</span>(ndims(I)==3); lcsS=[lcsS 1]; lcsE=[lcsE 3]; <span class="keyword">end</span>
0415         patch = arrayCrop(I,lcsS,lcsE,padEl);
0416       <span class="keyword">end</span>
0417     <span class="keyword">else</span>
0418       patch = I(lcsS(1):lcsE(1),lcsS(2):lcsE(2),:);
0419     <span class="keyword">end</span>
0420     bb = [lcsS([2 1]) lcsE([2 1])-lcsS([2 1])+1];
0421     <span class="keyword">if</span>(~isempty(dims)), patch=imResample(patch,[dims(2),dims(1)]); <span class="keyword">end</span>
0422   <span class="keyword">end</span>
0423 <span class="keyword">end</span>
0424 
0425 <a name="_sub12" href="#_subfunctions" class="code">function bb = convert( bb, bbRef, isAbs )</a>
0426 <span class="comment">% Convert bb relative to absolute coordinates and vice-versa.</span>
0427 <span class="comment">%</span>
0428 <span class="comment">% If isAbs==1, bb is assumed to be given in absolute coords, and the output</span>
0429 <span class="comment">% is given in coords relative to bbRef. Otherwise, if isAbs==0, bb is</span>
0430 <span class="comment">% assumed to be given in coords relative to bbRef and the output is given</span>
0431 <span class="comment">% in absolute coords.</span>
0432 <span class="comment">%</span>
0433 <span class="comment">% USAGE</span>
0434 <span class="comment">%  bb = bbApply( 'convert', bb, bbRef, isAbs )</span>
0435 <span class="comment">%</span>
0436 <span class="comment">% INPUTS</span>
0437 <span class="comment">%  bb     - original bb, either in abs or rel coords</span>
0438 <span class="comment">%  bbRef  - reference bb</span>
0439 <span class="comment">%  isAbs  - 1: bb is in abs coords, 0: bb is in rel coords</span>
0440 <span class="comment">%</span>
0441 <span class="comment">% OUTPUTS</span>
0442 <span class="comment">%  bb     - converted bb</span>
0443 <span class="comment">%</span>
0444 <span class="comment">% EXAMPLE</span>
0445 <span class="comment">%  bbRef=[5 5 15 15]; bba=[10 10 5 5];</span>
0446 <span class="comment">%  bbr = bbApply( 'convert', bba, bbRef, 1 )</span>
0447 <span class="comment">%  bba2 = bbApply( 'convert', bbr, bbRef, 0 )</span>
0448 <span class="comment">%</span>
0449 <span class="comment">% See also bbApply</span>
0450 <span class="keyword">if</span>( isAbs )
0451   bb(1:2)=bb(1:2)-bbRef(1:2);
0452   bb=bb./bbRef([3 4 3 4]);
0453 <span class="keyword">else</span>
0454   bb=bb.*bbRef([3 4 3 4]);
0455   bb(1:2)=bb(1:2)+bbRef(1:2);
0456 <span class="keyword">end</span>
0457 <span class="keyword">end</span>
0458 
0459 <a name="_sub13" href="#_subfunctions" class="code">function bbs = random( varargin )</a>
0460 <span class="comment">% Randomly generate bbs that fall in a specified region.</span>
0461 <span class="comment">%</span>
0462 <span class="comment">% The vector dims defines the region in which bbs are generated. Specify</span>
0463 <span class="comment">% dims=[height width] to generate bbs=[x y w h] such that: 1&lt;=x&lt;=width,</span>
0464 <span class="comment">% 1&lt;=y&lt;=height, x+w-1&lt;=width, y+h-1&lt;=height. The biggest bb generated can</span>
0465 <span class="comment">% be bb=[1 1 width height]. If dims is a three element vector the third</span>
0466 <span class="comment">% coordinate is the depth, in this case bbs=[x y w h d] where 1&lt;=d&lt;=depth.</span>
0467 <span class="comment">%</span>
0468 <span class="comment">% A number of constraints can be specified that control the size and other</span>
0469 <span class="comment">% characteristics of the generated bbs. Note that if incompatible</span>
0470 <span class="comment">% constraints are specified (e.g. if the maximum width and height are both</span>
0471 <span class="comment">% 5 while the minimum area is 100) no bbs will be generated. More</span>
0472 <span class="comment">% generally, if fewer than n bbs are generated a warning is displayed.</span>
0473 <span class="comment">%</span>
0474 <span class="comment">% USAGE</span>
0475 <span class="comment">%  bbs =  bbApply( 'random', pRandom )</span>
0476 <span class="comment">%</span>
0477 <span class="comment">% INPUTS</span>
0478 <span class="comment">%  pRandom    - parameters (struct or name/value pairs)</span>
0479 <span class="comment">%   .n          - ['REQ'] number of bbs to generate</span>
0480 <span class="comment">%   .dims       - ['REQ'] region in which to generate bbs [height,width]</span>
0481 <span class="comment">%   .wRng       - [1 inf] range for width of bbs (or scalar value)</span>
0482 <span class="comment">%   .hRng       - [1 inf] range for height of bbs (or scalar value)</span>
0483 <span class="comment">%   .aRng       - [1 inf] range for area of bbs</span>
0484 <span class="comment">%   .arRng      - [0 inf] range for aspect ratio (width/height) of bbs</span>
0485 <span class="comment">%   .unique     - [1] if true generate unique bbs</span>
0486 <span class="comment">%   .maxOverlap - [1] max overlap (intersection/union) between bbs</span>
0487 <span class="comment">%   .maxIter    - [100] max iterations to go w/o changes before giving up</span>
0488 <span class="comment">%   .show       - [0] if true show sample generated bbs</span>
0489 <span class="comment">%</span>
0490 <span class="comment">% OUTPUTS</span>
0491 <span class="comment">%  bbs        - [nx4] array of randomly generated integer bbs</span>
0492 <span class="comment">%</span>
0493 <span class="comment">% EXAMPLE</span>
0494 <span class="comment">%  bbs=bbApply('random','n',50,'dims',[20 20],'arRng',[.5 .5],'show',1);</span>
0495 <span class="comment">%</span>
0496 <span class="comment">% See also bbApply</span>
0497 
0498 <span class="comment">% get parameters</span>
0499 rng=[1 inf]; dfs={ <span class="string">'n'</span>,<span class="string">'REQ'</span>, <span class="string">'dims'</span>,<span class="string">'REQ'</span>, <span class="string">'wRng'</span>,rng, <span class="string">'hRng'</span>,rng, <span class="keyword">...</span>
0500   <span class="string">'aRng'</span>,rng, <span class="string">'arRng'</span>,[0 inf], <span class="string">'unique'</span>,1, <span class="string">'maxOverlap'</span>,1, <span class="keyword">...</span>
0501   <span class="string">'maxIter'</span>,100, <span class="string">'show'</span>,0 };
0502 [n,dims,wRng,hRng,aRng,arRng,uniqueOnly,maxOverlap,maxIter,show] <span class="keyword">...</span>
0503   = getPrmDflt(varargin,dfs,1);
0504 <span class="keyword">if</span>(length(hRng)==1), hRng=[hRng hRng]; <span class="keyword">end</span>
0505 <span class="keyword">if</span>(length(wRng)==1), wRng=[wRng wRng]; <span class="keyword">end</span>
0506 <span class="keyword">if</span>(length(dims)==3), d=5; <span class="keyword">else</span> d=4; <span class="keyword">end</span>
0507 
0508 <span class="comment">% generate random bbs satisfying constraints</span>
0509 bbs=zeros(0,d); ids=zeros(0,1); n1=min(n*10,1000);
0510 M=max(dims)+1; M=M.^(0:d-1); iter=0; k=0;
0511 tid=ticStatus(<span class="string">'generating random bbs'</span>,1,2);
0512 <span class="keyword">while</span>( k&lt;n &amp;&amp; iter&lt;maxIter )
0513   ys=1+floor(rand(2,n1)*dims(1)); ys0=min(ys); ys1=max(ys); hs=ys1-ys0+1;
0514   xs=1+floor(rand(2,n1)*dims(2)); xs0=min(xs); xs1=max(xs); ws=xs1-xs0+1;
0515   <span class="keyword">if</span>(d==5), ds=1+floor(rand(1,n1)*dims(3)); <span class="keyword">else</span> ds=zeros(0,n1); <span class="keyword">end</span>
0516   <span class="keyword">if</span>(arRng(1)==arRng(2)), ws=hs.*arRng(1); <span class="keyword">end</span>
0517   ars=ws./hs; ws=round(ws); xs1=xs0+ws-1; as=ws.*hs;
0518   kp = ys0&gt;0 &amp; xs0&gt;0 &amp; ys1&lt;=dims(1) &amp; xs1&lt;=dims(2) &amp; <span class="keyword">...</span>
0519     hs&gt;=hRng(1) &amp; hs&lt;=hRng(2) &amp; ws&gt;=wRng(1) &amp; ws&lt;=wRng(2) &amp; <span class="keyword">...</span>
0520     as&gt;=aRng(1) &amp; as&lt;=aRng(2) &amp; ars&gt;=arRng(1) &amp; ars&lt;=arRng(2);
0521   bbs1=[xs0' ys0' ws' hs' ds']; bbs1=bbs1(kp,:);
0522   k0=k; bbs=[bbs; bbs1]; k=size(bbs,1); <span class="comment">%#ok&lt;AGROW&gt;</span>
0523   <span class="keyword">if</span>( maxOverlap&lt;1 &amp;&amp; k ), bbs=bbs(1:k0,:);
0524     <span class="keyword">for</span> j=1:size(bbs1,1), bbs0=bbs; bb=bbs1(j,:);
0525       <span class="keyword">if</span>(d==5), bbs=bbs(bbs(:,5)==bb(5),:); <span class="keyword">end</span>
0526       <span class="keyword">if</span>(isempty(bbs)), bbs=[bbs0; bb]; <span class="keyword">continue</span>; <span class="keyword">end</span>
0527       ws1=min(bbs(:,1)+bbs(:,3),bb(1)+bb(3))-max(bbs(:,1),bb(1));
0528       hs1=min(bbs(:,2)+bbs(:,4),bb(2)+bb(4))-max(bbs(:,2),bb(2));
0529       o=max(0,ws1).*max(0,hs1); o=o./(bbs(:,3).*bbs(:,4)+bb(3).*bb(4)-o);
0530       <span class="keyword">if</span>(max(o)&lt;=maxOverlap), bbs=[bbs0; bb]; <span class="keyword">else</span> bbs=bbs0; <span class="keyword">end</span>
0531     <span class="keyword">end</span>
0532   <span class="keyword">elseif</span>( uniqueOnly &amp;&amp; k )
0533     ids=[ids; sum(bbs1.*M(ones(1,size(bbs1,1)),:),2)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0534     [ids,o]=sort(ids); bbs=bbs(o,:); kp=[ids(1:end-1)~=ids(2:end); true];
0535     bbs=bbs(kp,:); ids=ids(kp,:);
0536   <span class="keyword">end</span>
0537   k=size(bbs,1); <span class="keyword">if</span>(k0==k), iter=iter+1; <span class="keyword">else</span> iter=0; <span class="keyword">end</span>
0538   <span class="keyword">if</span>(k&gt;n), bbs=bbs(randSample(k,n),:); k=n; <span class="keyword">end</span>;
0539   tocStatus(tid,max(k/n,iter/maxIter));
0540 <span class="keyword">end</span>
0541 <span class="keyword">if</span>( k&lt;n ), warning(<span class="string">'only generated %i of %i bbs'</span>,k,n); n=k; <span class="keyword">end</span> <span class="comment">%#ok&lt;WNTAG&gt;</span>
0542 
0543 <span class="comment">% optionally display a few bbs</span>
0544 <span class="keyword">if</span>( show )
0545   k=8; figure(show); im(zeros(dims)); cs=uniqueColors(1,k,0,0);
0546   <span class="keyword">if</span>(n&gt;k), bbs1=bbs(randsample(n,k),:); <span class="keyword">else</span> bbs1=bbs; <span class="keyword">end</span>
0547   bbs1(:,1:2)=bbs1(:,1:2)-.5;
0548   <span class="keyword">for</span> i=1:min(k,n), rectangle(<span class="string">'Position'</span>,bbs1(i,:),<span class="keyword">...</span>
0549       <span class="string">'EdgeColor'</span>,cs(i,:),<span class="string">'LineStyle'</span>,<span class="string">'--'</span>); <span class="keyword">end</span>
0550 <span class="keyword">end</span>
0551 
0552 <span class="keyword">end</span>
0553 
0554 <a name="_sub14" href="#_subfunctions" class="code">function bbs = frMask( M, bbw, bbh, thr )</a>
0555 <span class="comment">% Convert weighted mask to bbs.</span>
0556 <span class="comment">%</span>
0557 <span class="comment">% Pixels in mask above given threshold (thr) indicate bb centers.</span>
0558 <span class="comment">%</span>
0559 <span class="comment">% USAGE</span>
0560 <span class="comment">%  bbs = bbApply('frMask',M,bbw,bbh,[thr])</span>
0561 <span class="comment">%</span>
0562 <span class="comment">% INPUTS</span>
0563 <span class="comment">%  M      - mask</span>
0564 <span class="comment">%  bbw    - bb target width</span>
0565 <span class="comment">%  bbh    - bb target height</span>
0566 <span class="comment">%  thr    - [0] mask threshold</span>
0567 <span class="comment">%</span>
0568 <span class="comment">% OUTPUTS</span>
0569 <span class="comment">%  bbs    - bounding boxes</span>
0570 <span class="comment">%</span>
0571 <span class="comment">% EXAMPLE</span>
0572 <span class="comment">%  w=20; h=10; bbw=5; bbh=8; M=double(rand(h,w)); M(M&lt;.95)=0;</span>
0573 <span class="comment">%  bbs=bbApply('frMask',M,bbw,bbh); M2=bbApply('toMask',bbs,w,h);</span>
0574 <span class="comment">%  sum(abs(M(:)-M2(:)))</span>
0575 <span class="comment">%</span>
0576 <span class="comment">% See also bbApply, bbApply&gt;toMask</span>
0577 <span class="keyword">if</span>(nargin&lt;4), thr=0; <span class="keyword">end</span>
0578 ids=find(M&gt;thr); ids=ids(:); h=size(M,1);
0579 <span class="keyword">if</span>(isempty(ids)), bbs=zeros(0,5); <span class="keyword">return</span>; <span class="keyword">end</span>
0580 xs=floor((ids-1)/h); ys=ids-xs*h; xs=xs+1;
0581 bbs=[xs-floor(bbw/2) ys-floor(bbh/2)];
0582 bbs(:,3)=bbw; bbs(:,4)=bbh; bbs(:,5)=M(ids);
0583 <span class="keyword">end</span>
0584 
0585 <a name="_sub15" href="#_subfunctions" class="code">function M = toMask( bbs, w, h, fill, bgrd )</a>
0586 <span class="comment">% Create weighted mask encoding bb centers (or extent).</span>
0587 <span class="comment">%</span>
0588 <span class="comment">% USAGE</span>
0589 <span class="comment">%  M = bbApply('toMask',bbs,w,h,[fill],[bgrd])</span>
0590 <span class="comment">%</span>
0591 <span class="comment">% INPUTS</span>
0592 <span class="comment">%  bbs    - bounding boxes</span>
0593 <span class="comment">%  w      - mask target width</span>
0594 <span class="comment">%  h      - mask target height</span>
0595 <span class="comment">%  fill   - [0] if 1 encodes extent of bbs</span>
0596 <span class="comment">%  bgrd   - [0] default value for background pixels</span>
0597 <span class="comment">%</span>
0598 <span class="comment">% OUTPUTS</span>
0599 <span class="comment">%  M      - hxw mask</span>
0600 <span class="comment">%</span>
0601 <span class="comment">% EXAMPLE</span>
0602 <span class="comment">%</span>
0603 <span class="comment">% See also bbApply, bbApply&gt;frMask</span>
0604 <span class="keyword">if</span>(nargin&lt;4||isempty(fill)), fill=0; <span class="keyword">end</span>
0605 <span class="keyword">if</span>(nargin&lt;5||isempty(bgrd)), bgrd=0; <span class="keyword">end</span>
0606 <span class="keyword">if</span>(size(bbs,2)==4), bbs(:,5)=1; <span class="keyword">end</span>
0607 M=zeros(h,w); B=true(h,w); n=size(bbs,1);
0608 <span class="keyword">if</span>( fill==0 )
0609   p=floor(<a href="#_sub3" class="code" title="subfunction cen = getCenter( bb )">getCenter</a>(bbs)); p=sub2ind([h w],p(:,2),p(:,1));
0610   <span class="keyword">for</span> i=1:n, M(p(i))=M(p(i))+bbs(i,5); <span class="keyword">end</span>
0611   <span class="keyword">if</span>(bgrd~=0), B(p)=0; <span class="keyword">end</span>
0612 <span class="keyword">else</span>
0613   bbs=[<a href="#_sub4" class="code" title="subfunction bb = intersect( bb1, bb2 )">intersect</a>(round(bbs),[1 1 w h]) bbs(:,5)]; n=size(bbs,1);
0614   x0=bbs(:,1); x1=x0+bbs(:,3)-1; y0=bbs(:,2); y1=y0+bbs(:,4)-1;
0615   <span class="keyword">for</span> i=1:n, y=y0(i):y1(i); x=x0(i):x1(i);
0616     M(y,x)=M(y,x)+bbs(i,5); B(y,x)=0; <span class="keyword">end</span>
0617 <span class="keyword">end</span>
0618 <span class="keyword">if</span>(bgrd~=0), M(B)=bgrd; <span class="keyword">end</span>
0619 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 05-May-2022 15:20:21 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>