<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of seqReaderPlugin</title>
  <meta name="keywords" content="seqReaderPlugin">
  <meta name="description" content="Plugin for seqIo and videoIO to allow reading of seq files.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">MLVcode</a> &gt; <a href="../../index.html">edges-master</a> &gt; <a href="#">toolbox-master</a> &gt; <a href="index.html">videos</a> &gt; seqReaderPlugin.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for MLVcode\edges-master\toolbox-master\videos&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>seqReaderPlugin
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Plugin for seqIo and videoIO to allow reading of seq files.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function varargout = seqReaderPlugin( cmd, h, varargin ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Plugin for seqIo and videoIO to allow reading of seq files.

 Do not call directly, use as plugin for seqIo or videoIO instead.
 The following is a list of commands available (srp=seqReaderPlugin):
  h = srp('open',h,fName)    % Open a seq file for reading (h ignored).
  h = srp('close',h);        % Close seq file (output h is -1).
  [I,ts] =srp('getframe',h)  % Get current frame (returns [] if invalid).
  [I,ts] =srp('getframeb',h) % Get current frame with no decoding.
  ts = srp('getts',h)        % Return timestamps for all frames.
  info = srp('getinfo',h)    % Return struct with info about video.
  [I,ts] =srp('getnext',h)   % Shortcut for 'next' followed by 'getframe'.
  out = srp('next',h)        % Go to next frame (out=0 on fail).
  out = srp('seek',h,frame)  % Go to specified frame (out=0 on fail).
  out = srp('step',h,delta)  % Go to current frame+delta (out=0 on fail).

 USAGE
  varargout = seqReaderPlugin( cmd, h, varargin )

 INPUTS
  cmd        - string indicating operation to perform
  h          - unique identifier for open seq file
  varargin   - additional options (vary according to cmd)

 OUTPUTS
  varargout  - output (varies according to cmd)

 EXAMPLE

 See also <a href="seqIo.html" class="code" title="function out = seqIo( fName, action, varargin )">SEQIO</a>, <a href="seqWriterPlugin.html" class="code" title="function varargout = seqWriterPlugin( cmd, h, varargin )">SEQWRITERPLUGIN</a>

 Piotr's Computer Vision Matlab Toolbox      Version 3.10
 Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]
 Licensed under the Simplified BSD License [see external/bsd.txt]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="seqIo.html" class="code" title="function out = seqIo( fName, action, varargin )">seqIo</a>	Utilities for reading and writing seq files.</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function chk(nIn,nMin,nMax)</a></li><li><a href="#_sub2" class="code">function success = getImgFile( fName )</a></li><li><a href="#_sub3" class="code">function [info, fid, tNm] = open( fName, info )</a></li><li><a href="#_sub4" class="code">function [frame,v] = valid( frame, info )</a></li><li><a href="#_sub5" class="code">function [I,ts] = getFrame( frame, fid, info, tNm, decode )</a></li><li><a href="#_sub6" class="code">function ts = getTs( frames, fid, info )</a></li><li><a href="#_sub7" class="code">function info = readHeader( fid )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = seqReaderPlugin( cmd, h, varargin )</a>
0002 <span class="comment">% Plugin for seqIo and videoIO to allow reading of seq files.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Do not call directly, use as plugin for seqIo or videoIO instead.</span>
0005 <span class="comment">% The following is a list of commands available (srp=seqReaderPlugin):</span>
0006 <span class="comment">%  h = srp('open',h,fName)    % Open a seq file for reading (h ignored).</span>
0007 <span class="comment">%  h = srp('close',h);        % Close seq file (output h is -1).</span>
0008 <span class="comment">%  [I,ts] =srp('getframe',h)  % Get current frame (returns [] if invalid).</span>
0009 <span class="comment">%  [I,ts] =srp('getframeb',h) % Get current frame with no decoding.</span>
0010 <span class="comment">%  ts = srp('getts',h)        % Return timestamps for all frames.</span>
0011 <span class="comment">%  info = srp('getinfo',h)    % Return struct with info about video.</span>
0012 <span class="comment">%  [I,ts] =srp('getnext',h)   % Shortcut for 'next' followed by 'getframe'.</span>
0013 <span class="comment">%  out = srp('next',h)        % Go to next frame (out=0 on fail).</span>
0014 <span class="comment">%  out = srp('seek',h,frame)  % Go to specified frame (out=0 on fail).</span>
0015 <span class="comment">%  out = srp('step',h,delta)  % Go to current frame+delta (out=0 on fail).</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% USAGE</span>
0018 <span class="comment">%  varargout = seqReaderPlugin( cmd, h, varargin )</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% INPUTS</span>
0021 <span class="comment">%  cmd        - string indicating operation to perform</span>
0022 <span class="comment">%  h          - unique identifier for open seq file</span>
0023 <span class="comment">%  varargin   - additional options (vary according to cmd)</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% OUTPUTS</span>
0026 <span class="comment">%  varargout  - output (varies according to cmd)</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% EXAMPLE</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% See also SEQIO, SEQWRITERPLUGIN</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% Piotr's Computer Vision Matlab Toolbox      Version 3.10</span>
0033 <span class="comment">% Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]</span>
0034 <span class="comment">% Licensed under the Simplified BSD License [see external/bsd.txt]</span>
0035 
0036 <span class="comment">% persistent variables to keep track of all loaded .seq files</span>
0037 <span class="keyword">persistent</span> h1 hs cs fids infos tNms;
0038 <span class="keyword">if</span>(isempty(h1)), h1=int32(now); hs=int32([]); infos={}; tNms={}; <span class="keyword">end</span>
0039 nIn=nargin-2; in=varargin; o2=[]; cmd=lower(cmd);
0040 
0041 <span class="comment">% open seq file</span>
0042 <span class="keyword">if</span>(strcmp(cmd,<span class="string">'open'</span>))
0043   <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,1,2); h=length(hs)+1; hs(h)=h1; varargout={h1}; h1=h1+1;
0044   [pth,name]=fileparts(in{1}); <span class="keyword">if</span>(isempty(pth)), pth=<span class="string">'.'</span>; <span class="keyword">end</span>
0045   <span class="keyword">if</span>(nIn==1), info=[]; <span class="keyword">else</span> info=in{2}; <span class="keyword">end</span>
0046   fName=[pth filesep name]; cs(h)=-1;
0047   [infos{h},fids(h),tNms{h}]=<a href="#_sub3" class="code" title="subfunction [info, fid, tNm] = open( fName, info )">open</a>(fName,info); <span class="keyword">return</span>;
0048 <span class="keyword">end</span>
0049 
0050 <span class="comment">% Get the handle for this instance</span>
0051 [v,h]=ismember(h,hs); <span class="keyword">if</span>(~v), error(<span class="string">'Invalid load plugin handle'</span>); <span class="keyword">end</span>
0052 c=cs(h); fid=fids(h); info=infos{h}; tNm=tNms{h};
0053 
0054 <span class="comment">% close seq file</span>
0055 <span class="keyword">if</span>(strcmp(cmd,<span class="string">'close'</span>))
0056   <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,0); varargout={-1}; fclose(fid); kp=[1:h-1 h+1:length(hs)];
0057   hs=hs(kp); cs=cs(kp); fids=fids(kp); infos=infos(kp);
0058   tNms=tNms(kp); <span class="keyword">if</span>(exist(tNm,<span class="string">'file'</span>)), delete(tNm); <span class="keyword">end</span>; <span class="keyword">return</span>;
0059 <span class="keyword">end</span>
0060 
0061 <span class="comment">% perform appropriate operation</span>
0062 <span class="keyword">switch</span>( cmd )
0063   <span class="keyword">case</span> <span class="string">'getframe'</span>,  <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,0); [o1,o2]=<a href="#_sub5" class="code" title="subfunction [I,ts] = getFrame( frame, fid, info, tNm, decode )">getFrame</a>(c,fid,info,tNm,1);
0064   <span class="keyword">case</span> <span class="string">'getframeb'</span>, <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,0); [o1,o2]=<a href="#_sub5" class="code" title="subfunction [I,ts] = getFrame( frame, fid, info, tNm, decode )">getFrame</a>(c,fid,info,tNm,0);
0065   <span class="keyword">case</span> <span class="string">'getts'</span>,     <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,0); o1=<a href="#_sub6" class="code" title="subfunction ts = getTs( frames, fid, info )">getTs</a>(0:info.numFrames-1,fid,info);
0066   <span class="keyword">case</span> <span class="string">'getinfo'</span>,   <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,0); o1=info; o1.curFrame=c;
0067   <span class="keyword">case</span> <span class="string">'getnext'</span>,   <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,0); c=c+1; [o1,o2]=<a href="#_sub5" class="code" title="subfunction [I,ts] = getFrame( frame, fid, info, tNm, decode )">getFrame</a>(c,fid,info,tNm,1);
0068   <span class="keyword">case</span> <span class="string">'next'</span>,      <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,0); [c,o1]=<a href="#_sub4" class="code" title="subfunction [frame,v] = valid( frame, info )">valid</a>(c+1,info);
0069   <span class="keyword">case</span> <span class="string">'seek'</span>,      <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,1); [c,o1]=<a href="#_sub4" class="code" title="subfunction [frame,v] = valid( frame, info )">valid</a>(in{1},info);
0070   <span class="keyword">case</span> <span class="string">'step'</span>,      <a href="#_sub1" class="code" title="subfunction chk(nIn,nMin,nMax)">chk</a>(nIn,1); [c,o1]=<a href="#_sub4" class="code" title="subfunction [frame,v] = valid( frame, info )">valid</a>(c+in{1},info);
0071   <span class="keyword">otherwise</span>,        error([<span class="string">'Unrecognized command: &quot;'</span> cmd <span class="string">'&quot;'</span>]);
0072 <span class="keyword">end</span>
0073 cs(h)=c; varargout={o1,o2};
0074 
0075 <span class="keyword">end</span>
0076 
0077 <a name="_sub1" href="#_subfunctions" class="code">function chk(nIn,nMin,nMax)</a>
0078 <span class="keyword">if</span>(nargin&lt;3), nMax=nMin; <span class="keyword">end</span>
0079 <span class="keyword">if</span>(nIn&gt;0 &amp;&amp; nMin==0 &amp;&amp; nMax==0), error([<span class="string">'&quot;'</span> cmd <span class="string">'&quot; takes no args.'</span>]); <span class="keyword">end</span>
0080 <span class="keyword">if</span>(nIn&lt;nMin||nIn&gt;nMax), error([<span class="string">'Incorrect num args for &quot;'</span> cmd <span class="string">'&quot;.'</span>]); <span class="keyword">end</span>
0081 <span class="keyword">end</span>
0082 
0083 <a name="_sub2" href="#_subfunctions" class="code">function success = getImgFile( fName )</a>
0084 <span class="comment">% create local copy of fName which is in a imagesci/private</span>
0085 fName = [fName <span class="string">'.'</span> mexext]; s = filesep; success = 1;
0086 sName = [fileparts(which(<span class="string">'imread.m'</span>)) s <span class="string">'private'</span> s fName];
0087 tName = [fileparts(mfilename(<span class="string">'fullpath'</span>)) s <span class="string">'private'</span> s fName];
0088 <span class="keyword">if</span>(~exist(tName,<span class="string">'file'</span>)), success=copyfile(sName,tName); <span class="keyword">end</span>
0089 <span class="keyword">end</span>
0090 
0091 <a name="_sub3" href="#_subfunctions" class="code">function [info, fid, tNm] = open( fName, info )</a>
0092 <span class="comment">% open video for reading, get header</span>
0093 <span class="keyword">if</span>(exist([fName <span class="string">'.seq'</span>],<span class="string">'file'</span>)==0)
0094   error(<span class="string">'seq file not found: %s.seq'</span>,fName); <span class="keyword">end</span>
0095 fid=fopen([fName <span class="string">'.seq'</span>],<span class="string">'r'</span>,<span class="string">'l'</span>);
0096 <span class="keyword">if</span>(isempty(info)), info=<a href="#_sub7" class="code" title="subfunction info = readHeader( fid )">readHeader</a>(fid); <span class="keyword">else</span>
0097   info.numFrames=0; fseek(fid,1024,<span class="string">'bof'</span>); <span class="keyword">end</span>
0098 <span class="keyword">switch</span>(info.imageFormat)
0099   <span class="keyword">case</span> {100,200}, ext=<span class="string">'raw'</span>;
0100   <span class="keyword">case</span> {101    }, ext=<span class="string">'brgb8'</span>;
0101   <span class="keyword">case</span> {102,201}, ext=<span class="string">'jpg'</span>;
0102   <span class="keyword">case</span> {103    }, ext =<span class="string">'jbrgb'</span>;
0103   <span class="keyword">case</span> {001,002}, ext=<span class="string">'png'</span>;
0104   <span class="keyword">otherwise</span>, error(<span class="string">'unknown format'</span>);
0105 <span class="keyword">end</span>; info.ext=ext; s=1;
0106 <span class="keyword">if</span>(any(strcmp(ext,{<span class="string">'jpg'</span>,<span class="string">'jbrgb'</span>}))), s=<a href="#_sub2" class="code" title="subfunction success = getImgFile( fName )">getImgFile</a>(<span class="string">'rjpg8c'</span>); <span class="keyword">end</span>
0107 <span class="keyword">if</span>(strcmp(ext,<span class="string">'png'</span>)), s=<a href="#_sub2" class="code" title="subfunction success = getImgFile( fName )">getImgFile</a>(<span class="string">'png'</span>);
0108   <span class="keyword">if</span>(s), info.readImg=@(nm) png(<span class="string">'read'</span>,nm,[]); <span class="keyword">end</span>; <span class="keyword">end</span>
0109 <span class="keyword">if</span>(strcmp(ext,<span class="string">'png'</span>) &amp;&amp; ~s), s=<a href="#_sub2" class="code" title="subfunction success = getImgFile( fName )">getImgFile</a>(<span class="string">'pngreadc'</span>);
0110   <span class="keyword">if</span>(s), info.readImg=@(nm) pngreadc(nm,[],false); <span class="keyword">end</span>; <span class="keyword">end</span>
0111 <span class="keyword">if</span>(~s), error(<span class="string">'Cannot find Matlab''s source image reader'</span>); <span class="keyword">end</span>
0112 <span class="comment">% generate unique temporary name</span>
0113 [~,tNm]=fileparts(fName); t=clock; t=mod(t(end),1);
0114 tNm=sprintf(<span class="string">'tmp_%s_%15i.%s'</span>,tNm,round((t+rand)/2*1e15),ext);
0115 <span class="comment">% compute seek info for compressed images</span>
0116 <span class="keyword">if</span>(any(strcmp(ext,{<span class="string">'raw'</span>,<span class="string">'brgb8'</span>}))), assert(info.numFrames&gt;0); <span class="keyword">else</span>
0117   oName=[fName <span class="string">'-seek.mat'</span>]; n=info.numFrames; <span class="keyword">if</span>(n==0), n=10^7; <span class="keyword">end</span>
0118   <span class="keyword">if</span>(exist(oName,<span class="string">'file'</span>)==2), load(oName); info.seek=seek; <span class="keyword">else</span> <span class="comment">%#ok&lt;NODEF&gt;</span>
0119     tid=ticStatus(<span class="string">'loading seek info'</span>,.1,5); seek=zeros(n,1); seek(1)=1024;
0120     extra=8; <span class="comment">% extra bytes after image data (8 for ts, then 0 or 8 empty)</span>
0121     <span class="keyword">for</span> i=2:n
0122       s=seek(i-1)+fread(fid,1,<span class="string">'uint32'</span>)+extra; <a href="#_sub4" class="code" title="subfunction [frame,v] = valid( frame, info )">valid</a>=fseek(fid,s,<span class="string">'bof'</span>)==0;
0123       <span class="keyword">if</span>(i==2 &amp;&amp; <a href="#_sub4" class="code" title="subfunction [frame,v] = valid( frame, info )">valid</a>), <span class="keyword">if</span>(fread(fid,1,<span class="string">'uint32'</span>)~=0), fseek(fid,-4,<span class="string">'cof'</span>);
0124         <span class="keyword">else</span> extra=extra+8; s=s+8; <a href="#_sub4" class="code" title="subfunction [frame,v] = valid( frame, info )">valid</a>=fseek(fid,s,<span class="string">'bof'</span>)==0; <span class="keyword">end</span>; <span class="keyword">end</span>
0125       <span class="keyword">if</span>(<a href="#_sub4" class="code" title="subfunction [frame,v] = valid( frame, info )">valid</a>), seek(i)=s; tocStatus(tid,i/n);
0126       <span class="keyword">else</span> n=i-1; seek=seek(1:n); tocStatus(tid,1); <span class="keyword">break</span>; <span class="keyword">end</span>
0127     <span class="keyword">end</span>; <span class="keyword">if</span>(info.numFrames==0), info.numFrames=n; <span class="keyword">end</span>
0128     <span class="keyword">try</span> save(oName,<span class="string">'seek'</span>); <span class="keyword">catch</span>; <span class="keyword">end</span>; info.seek=seek; <span class="comment">%#ok&lt;CTCH&gt;</span>
0129   <span class="keyword">end</span>
0130 <span class="keyword">end</span>
0131 <span class="comment">% compute frame rate from timestamps as stored fps may be incorrect</span>
0132 n=min(100,info.numFrames); <span class="keyword">if</span>(n==1), <span class="keyword">return</span>; <span class="keyword">end</span>
0133 ts = <a href="#_sub6" class="code" title="subfunction ts = getTs( frames, fid, info )">getTs</a>( 0:(n-1), fid, info );
0134 ds=ts(2:end)-ts(1:end-1); ds=ds(abs(ds-median(ds))&lt;.005);
0135 <span class="keyword">if</span>(~isempty(ds)), info.fps=1/mean(ds); <span class="keyword">end</span>
0136 <span class="keyword">end</span>
0137 
0138 <a name="_sub4" href="#_subfunctions" class="code">function [frame,v] = valid( frame, info )</a>
0139 v=(frame&gt;=0 &amp;&amp; frame&lt;info.numFrames);
0140 <span class="keyword">end</span>
0141 
0142 <a name="_sub5" href="#_subfunctions" class="code">function [I,ts] = getFrame( frame, fid, info, tNm, decode )</a>
0143 <span class="comment">% get frame image (I) and timestamp (ts) at which frame was recorded</span>
0144 nCh=info.imageBitDepth/8; ext=info.ext;
0145 <span class="keyword">if</span>(frame&lt;0 || frame&gt;=info.numFrames), I=[]; ts=[]; <span class="keyword">return</span>; <span class="keyword">end</span>
0146 <span class="keyword">switch</span> ext
0147   <span class="keyword">case</span> {<span class="string">'raw'</span>,<span class="string">'brgb8'</span>}
0148     <span class="comment">% read in an uncompressed image (assume imageBitDepthReal==8)</span>
0149     fseek(fid,1024+frame*info.trueImageSize,<span class="string">'bof'</span>);
0150     I = fread(fid,info.imageSizeBytes,<span class="string">'*uint8'</span>);
0151     <span class="keyword">if</span>( decode )
0152       <span class="comment">% reshape appropriately for mxn or mxnx3 RGB image</span>
0153       siz = [info.height info.width nCh];
0154       <span class="keyword">if</span>(nCh==1), I=reshape(I,siz(2),siz(1))'; <span class="keyword">else</span>
0155         I = permute(reshape(I,siz(3),siz(2),siz(1)),[3,2,1]);
0156       <span class="keyword">end</span>
0157       <span class="keyword">if</span>(nCh==3), t=I(:,:,3); I(:,:,3)=I(:,:,1); I(:,:,1)=t; <span class="keyword">end</span>
0158       <span class="keyword">if</span>(strcmp(ext,<span class="string">'brgb8'</span>)), I=demosaic(I,<span class="string">'bggr'</span>); <span class="keyword">end</span>
0159     <span class="keyword">end</span>
0160   <span class="keyword">case</span> {<span class="string">'jpg'</span>,<span class="string">'jbrgb'</span>}
0161     fseek(fid,info.seek(frame+1),<span class="string">'bof'</span>); nBytes=fread(fid,1,<span class="string">'uint32'</span>);
0162     I = fread(fid,nBytes-4,<span class="string">'*uint8'</span>);
0163     <span class="keyword">if</span>( decode )
0164       <span class="comment">% write/read to/from temporary .jpg (not that much overhead)</span>
0165       assert(I(1)==255 &amp;&amp; I(2)==216 &amp;&amp; I(end-1)==255 &amp;&amp; I(end)==217); <span class="comment">% JPG</span>
0166       <span class="keyword">for</span> t=0:99, fw=fopen(tNm,<span class="string">'w'</span>); <span class="keyword">if</span>(fw&gt;=0), <span class="keyword">break</span>; <span class="keyword">end</span>; pause(.01); <span class="keyword">end</span>
0167       <span class="keyword">if</span>(fw==-1), error([<span class="string">'unable to write: '</span> tNm]); <span class="keyword">end</span>
0168       fwrite(fw,I); fclose(fw); I=rjpg8c(tNm);
0169       <span class="keyword">if</span>(strcmp(ext,<span class="string">'jbrgb'</span>)), I=demosaic(I,<span class="string">'bggr'</span>); <span class="keyword">end</span>
0170     <span class="keyword">end</span>
0171   <span class="keyword">case</span> <span class="string">'png'</span>
0172     fseek(fid,info.seek(frame+1),<span class="string">'bof'</span>); nBytes=fread(fid,1,<span class="string">'uint32'</span>);
0173     I = fread(fid,nBytes-4,<span class="string">'*uint8'</span>);
0174     <span class="keyword">if</span>( decode )
0175       <span class="comment">% write/read to/from temporary .png (not that much overhead)</span>
0176       <span class="keyword">for</span> t=0:99, fw=fopen(tNm,<span class="string">'w'</span>); <span class="keyword">if</span>(fw&gt;=0), <span class="keyword">break</span>; <span class="keyword">end</span>; pause(.01); <span class="keyword">end</span>
0177       <span class="keyword">if</span>(fw==-1), error([<span class="string">'unable to write: '</span> tNm]); <span class="keyword">end</span>
0178       fwrite(fw,I); fclose(fw); I=info.readImg(tNm);
0179       I=permute(I,ndims(I):-1:1);
0180     <span class="keyword">end</span>
0181   <span class="keyword">otherwise</span>, assert(false);
0182 <span class="keyword">end</span>
0183 <span class="keyword">if</span>(nargout==2), ts=fread(fid,1,<span class="string">'uint32'</span>)+fread(fid,1,<span class="string">'uint16'</span>)/1000; <span class="keyword">end</span>
0184 <span class="keyword">end</span>
0185 
0186 <a name="_sub6" href="#_subfunctions" class="code">function ts = getTs( frames, fid, info )</a>
0187 <span class="comment">% get timestamps (ts) at which frames were recorded</span>
0188 n=length(frames); ts=nan(1,n);
0189 <span class="keyword">for</span> i=1:n, frame=frames(i);
0190   <span class="keyword">if</span>(frame&lt;0 || frame&gt;=info.numFrames), <span class="keyword">continue</span>; <span class="keyword">end</span>
0191   <span class="keyword">switch</span> info.ext
0192     <span class="keyword">case</span> {<span class="string">'raw'</span>,<span class="string">'brgb8'</span>} <span class="comment">% uncompressed</span>
0193       fseek(fid,1024+frame*info.trueImageSize+info.imageSizeBytes,<span class="string">'bof'</span>);
0194     <span class="keyword">case</span> {<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'jbrgb'</span>} <span class="comment">% compressed</span>
0195       fseek(fid,info.seek(frame+1),<span class="string">'bof'</span>);
0196       fseek(fid,fread(fid,1,<span class="string">'uint32'</span>)-4,<span class="string">'cof'</span>);
0197     <span class="keyword">otherwise</span>, assert(false);
0198   <span class="keyword">end</span>
0199   ts(i)=fread(fid,1,<span class="string">'uint32'</span>)+fread(fid,1,<span class="string">'uint16'</span>)/1000;
0200 <span class="keyword">end</span>
0201 <span class="keyword">end</span>
0202 
0203 <a name="_sub7" href="#_subfunctions" class="code">function info = readHeader( fid )</a>
0204 <span class="comment">% see streampix manual for info on header</span>
0205 fseek(fid,0,<span class="string">'bof'</span>);
0206 <span class="comment">% check that header is not all 0's (a common error)</span>
0207 [tmp,n]=fread(fid,1024); <span class="keyword">if</span>(n&lt;1024), error(<span class="string">'no header'</span>); <span class="keyword">end</span>
0208 <span class="keyword">if</span>(all(tmp==0)), error(<span class="string">'fully empty header'</span>); <span class="keyword">end</span>; fseek(fid,0,<span class="string">'bof'</span>);
0209 <span class="comment">% first 4 bytes store OxFEED, next 24 store 'Norpix seq  '</span>
0210 <span class="keyword">if</span>( ~strcmp(sprintf(<span class="string">'%X'</span>,fread(fid,1,<span class="string">'uint32'</span>)),<span class="string">'FEED'</span>) || <span class="keyword">...</span>
0211     ~strcmp(char(fread(fid,10,<span class="string">'uint16'</span>))',<span class="string">'Norpix seq'</span>) ) <span class="comment">%#ok&lt;FREAD&gt;</span>
0212   error(<span class="string">'invalid header'</span>);
0213 <span class="keyword">end</span>; fseek(fid,4,<span class="string">'cof'</span>);
0214 <span class="comment">% next 8 bytes for version and header size (1024), then 512 for descr</span>
0215 version=fread(fid,1,<span class="string">'int32'</span>); assert(fread(fid,1,<span class="string">'uint32'</span>)==1024);
0216 descr=char(fread(fid,256,<span class="string">'uint16'</span>))'; <span class="comment">%#ok&lt;FREAD&gt;</span>
0217 <span class="comment">% read in more info</span>
0218 tmp=fread(fid,9,<span class="string">'uint32'</span>); assert(tmp(8)==0);
0219 fps = fread(fid,1,<span class="string">'float64'</span>); codec=[<span class="string">'imageFormat'</span> int2str2(tmp(6),3)];
0220 <span class="comment">% store information in info struct</span>
0221 info=struct( <span class="string">'width'</span>,tmp(1), <span class="string">'height'</span>,tmp(2), <span class="string">'imageBitDepth'</span>,tmp(3), <span class="keyword">...</span>
0222   <span class="string">'imageBitDepthReal'</span>,tmp(4), <span class="string">'imageSizeBytes'</span>,tmp(5), <span class="keyword">...</span>
0223   <span class="string">'imageFormat'</span>,tmp(6), <span class="string">'numFrames'</span>,tmp(7), <span class="string">'trueImageSize'</span>, tmp(9),<span class="keyword">...</span>
0224   <span class="string">'fps'</span>,fps, <span class="string">'seqVersion'</span>,version, <span class="string">'codec'</span>,codec, <span class="string">'descr'</span>,descr, <span class="keyword">...</span>
0225   <span class="string">'nHiddenFinalFrames'</span>,0 );
0226 assert(info.imageBitDepthReal==8);
0227 <span class="comment">% seek to end of header</span>
0228 fseek(fid,432,<span class="string">'cof'</span>);
0229 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 05-May-2022 15:20:21 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>