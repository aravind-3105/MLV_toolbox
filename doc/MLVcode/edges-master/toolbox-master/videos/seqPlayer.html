<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of seqPlayer</title>
  <meta name="keywords" content="seqPlayer">
  <meta name="description" content="Simple GUI to play seq files.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">MLVcode</a> &gt; <a href="../../index.html">edges-master</a> &gt; <a href="#">toolbox-master</a> &gt; <a href="index.html">videos</a> &gt; seqPlayer.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for MLVcode\edges-master\toolbox-master\videos&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>seqPlayer
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Simple GUI to play seq files.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function seqPlayer( fName, dispFunc ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Simple GUI to play seq files.

 Use arrow keys to play the video. Controls are as follows:
 (1) If stopped: [L] play backward, [R] play forward
 (2) If playing forward: [L] halve speed, [R] double speed, [U/D] stop
 (3) If playing backward: [L] double speed, [R] halve speed,[U/D] stop
 You can explicitly enter a frame or use the slider to jump in the video.

 One can pass in a function handle dispFunc, where &quot;hs=dispFunc(frame)&quot;
 performs additional custom display for the given frame (and returns the
 handles for any created objects).

 USAGE
  seqPlayer( [fName], [dispFunc] )

 INPUTS
  fName    - optional seq file to load at start
  dispFunc - allow custom display per frame

 OUTPUTS

 EXAMPLE
  load images; [h,w,n]=size(video);
  info=struct('height',h,'width',w,'codec','monojpg','fps',20);
  sw=seqIo('video','w',info); for t=1:n, sw.addframe(video(:,:,t)); end
  sw.close(); seqPlayer('video');

 See also <a href="seqIo.html" class="code" title="function out = seqIo( fName, action, varargin )">SEQIO</a>

 Piotr's Computer Vision Matlab Toolbox      Version 2.61
 Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]
 Licensed under the Simplified BSD License [see external/bsd.txt]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="seqIo.html" class="code" title="function out = seqIo( fName, action, varargin )">seqIo</a>	Utilities for reading and writing seq files.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function makeLayout()</a></li><li><a href="#_sub2" class="code">function keyPress( h, evnt )</a></li><li><a href="#_sub3" class="code">function figResized( h, evnt )</a></li><li><a href="#_sub4" class="code">function exitProg( h, evnt )</a></li><li><a href="#_sub5" class="code">function api = dispMakeApi()</a></li><li><a href="#_sub6" class="code">function setVid( sr1 )</a></li><li><a href="#_sub7" class="code">function setAud(y,fs,nb)</a></li><li><a href="#_sub8" class="code">function dispLoop()</a></li><li><a href="#_sub9" class="code">function setSpeedCb( flag )</a></li><li><a href="#_sub10" class="code">function setSpeed( speed1 )</a></li><li><a href="#_sub11" class="code">function setFrameCb( flag )</a></li><li><a href="#_sub12" class="code">function setFrame( curInd1, speed1 )</a></li><li><a href="#_sub13" class="code">function requestUpdate(), needUpdate=true; dispLoop(); end</a></li><li><a href="#_sub14" class="code">function info1 = getInfo(), info1=info; end</a></li><li><a href="#_sub15" class="code">function curInd1 = getFrame(), curInd1=round(curInd); end</a></li><li><a href="#_sub16" class="code">function api = menuMakeApi()</a></li><li><a href="#_sub17" class="code">function updateMenus()</a></li><li><a href="#_sub18" class="code">function vidClose()</a></li><li><a href="#_sub19" class="code">function vidOpen( flag )</a></li><li><a href="#_sub20" class="code">function vidInfo()</a></li><li><a href="#_sub21" class="code">function audOpen( fAud )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function seqPlayer( fName, dispFunc )</a>
0002 <span class="comment">% Simple GUI to play seq files.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Use arrow keys to play the video. Controls are as follows:</span>
0005 <span class="comment">% (1) If stopped: [L] play backward, [R] play forward</span>
0006 <span class="comment">% (2) If playing forward: [L] halve speed, [R] double speed, [U/D] stop</span>
0007 <span class="comment">% (3) If playing backward: [L] double speed, [R] halve speed,[U/D] stop</span>
0008 <span class="comment">% You can explicitly enter a frame or use the slider to jump in the video.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% One can pass in a function handle dispFunc, where &quot;hs=dispFunc(frame)&quot;</span>
0011 <span class="comment">% performs additional custom display for the given frame (and returns the</span>
0012 <span class="comment">% handles for any created objects).</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% USAGE</span>
0015 <span class="comment">%  seqPlayer( [fName], [dispFunc] )</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% INPUTS</span>
0018 <span class="comment">%  fName    - optional seq file to load at start</span>
0019 <span class="comment">%  dispFunc - allow custom display per frame</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% OUTPUTS</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% EXAMPLE</span>
0024 <span class="comment">%  load images; [h,w,n]=size(video);</span>
0025 <span class="comment">%  info=struct('height',h,'width',w,'codec','monojpg','fps',20);</span>
0026 <span class="comment">%  sw=seqIo('video','w',info); for t=1:n, sw.addframe(video(:,:,t)); end</span>
0027 <span class="comment">%  sw.close(); seqPlayer('video');</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% See also SEQIO</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% Piotr's Computer Vision Matlab Toolbox      Version 2.61</span>
0032 <span class="comment">% Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]</span>
0033 <span class="comment">% Licensed under the Simplified BSD License [see external/bsd.txt]</span>
0034 
0035 <span class="keyword">if</span>(nargin&lt;1), fName=[]; <span class="keyword">end</span>
0036 <span class="keyword">if</span>(nargin&lt;2), dispFunc=[]; <span class="keyword">end</span>
0037 
0038 <span class="comment">% handles to gui objects / other globals</span>
0039 [hFig,menu,pTop,pMid,dispApi] = deal([]);
0040 
0041 <span class="comment">% initialize all</span>
0042 <a href="#_sub1" class="code" title="subfunction makeLayout()">makeLayout</a>();
0043 menuApi = <a href="#_sub16" class="code" title="subfunction api = menuMakeApi()">menuMakeApi</a>();
0044 dispApi = <a href="#_sub5" class="code" title="subfunction api = dispMakeApi()">dispMakeApi</a>();
0045 menuApi.vidClose();
0046 
0047 <span class="comment">% open vid if given</span>
0048 <span class="keyword">if</span>(~isempty(fName)), menuApi.vidOpen(fName); <span class="keyword">end</span>
0049 
0050 
0051   <a name="_sub1" href="#_subfunctions" class="code">function makeLayout()</a>
0052     <span class="comment">% common properties</span>
0053     name = <span class="string">'Seq Player'</span>;
0054     bg=<span class="string">'BackgroundColor'</span>; fg=<span class="string">'ForegroundColor'</span>; ha=<span class="string">'HorizontalAlignment'</span>;
0055     units = {<span class="string">'Units'</span>,<span class="string">'pixels'</span>}; st=<span class="string">'String'</span>; ps=<span class="string">'Position'</span>; fs=<span class="string">'FontSize'</span>;
0056     
0057     <span class="comment">% initial figures size / pos</span>
0058     set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);  ss = get(0,<span class="string">'ScreenSize'</span>);
0059     <span class="keyword">if</span>( ss(3)&lt;800 || ss(4)&lt;600 ); error(<span class="string">'screen too small'</span>); <span class="keyword">end</span>;
0060     figPos = [(ss(3)-600)/2 (ss(4)-500)/2 600 500];
0061     
0062     <span class="comment">% create main figure</span>
0063     hFig = figure(<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="string">'Toolbar'</span>,<span class="string">'auto'</span>, <span class="string">'Color'</span>,<span class="string">'k'</span>, <span class="keyword">...</span>
0064       <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="string">'Visible'</span>,<span class="string">'off'</span>, ps,figPos, <span class="string">'Name'</span>,name );
0065     set(hFig,<span class="string">'DeleteFcn'</span>,@<a href="#_sub4" class="code" title="subfunction exitProg( h, evnt ) ">exitProg</a>,<span class="string">'ResizeFcn'</span>,@<a href="#_sub3" class="code" title="subfunction figResized( h, evnt ) ">figResized</a>);
0066     
0067     <span class="comment">% mid panel</span>
0068     pMid.hAx=axes(units{:},<span class="string">'Parent'</span>,hFig,<span class="string">'XTick'</span>,[],<span class="string">'YTick'</span>,[]);
0069     pMid.hSl=uicontrol(hFig,<span class="string">'Style'</span>,<span class="string">'slider'</span>,<span class="string">'Min'</span>,0,<span class="string">'Max'</span>,1,bg,<span class="string">'k'</span>);
0070     btnPrp=[units,{<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>, bg,[.9 .9 .9],fs,9,st}];
0071     pMid.hLf=uicontrol(hFig,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,btnPrp{:},<span class="string">'&lt;&lt;'</span>);
0072     pMid.hRt=uicontrol(hFig,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,btnPrp{:},<span class="string">'&gt;&gt;'</span>);
0073     imshow(0);
0074     
0075     <span class="comment">% top panel</span>
0076     pnlProp = [units {bg,[.1 .1 .1],<span class="string">'BorderType'</span>,<span class="string">'none'</span>}];
0077     txtPrp = {<span class="string">'Style'</span>,<span class="string">'text'</span>,fs,8,bg,[.1 .1 .1],fg,<span class="string">'w'</span>,ha};
0078     edtPrp = {<span class="string">'Style'</span>,<span class="string">'edit'</span>,fs,8,bg,[.1 .1 .1],fg,<span class="string">'w'</span>,ha};
0079     pTop.h = uipanel(pnlProp{:},<span class="string">'Parent'</span>,hFig);
0080     pTop.hFrmLbl=uicontrol(pTop.h,txtPrp{:},<span class="string">'Left'</span>,st,<span class="string">'frame:'</span>);
0081     pTop.hFrmInd=uicontrol(pTop.h,edtPrp{:},<span class="string">'Right'</span>);
0082     pTop.hTmLbl=uicontrol(pTop.h,txtPrp{:},<span class="string">'Left'</span>,st,<span class="string">'time:'</span>);
0083     pTop.hTmVal=uicontrol(pTop.h,txtPrp{:},<span class="string">'Left'</span>);
0084     pTop.hFrmNum=uicontrol(pTop.h,txtPrp{:},<span class="string">'Left'</span>);
0085     pTop.hPlyLbl=uicontrol(pTop.h,txtPrp{:},<span class="string">'Left'</span>,st,<span class="string">'speed:'</span>);
0086     pTop.hPlySpd=uicontrol(pTop.h,txtPrp{:},<span class="string">'Left'</span>,st,<span class="string">'0x'</span>);
0087     
0088     <span class="comment">% set the keyPressFcn for all focusable components (except popupmenus)</span>
0089     set( [hFig pMid.hSl pMid.hLf pMid.hRt], <span class="string">'keyPressFcn'</span>,@<a href="#_sub2" class="code" title="subfunction keyPress( h, evnt ) ">keyPress</a> );
0090     
0091     <span class="comment">% create menus</span>
0092     menu.hVid = uimenu(hFig,<span class="string">'Label'</span>,<span class="string">'Video'</span>);
0093     menu.hVidOpn = uimenu(menu.hVid,<span class="string">'Label'</span>,<span class="string">'Open'</span>);
0094     menu.hVidsOpn = uimenu(menu.hVid,<span class="string">'Label'</span>,<span class="string">'Open dual'</span>);
0095     menu.hVidCls = uimenu(menu.hVid,<span class="string">'Label'</span>,<span class="string">'Close'</span>);
0096     menu.hVidInfo = uimenu(menu.hVid,<span class="string">'Label'</span>,<span class="string">'Info'</span>);
0097     menu.hVidAud = uimenu(menu.hVid,<span class="string">'Label'</span>,<span class="string">'Audio'</span>);
0098     
0099     <span class="comment">% set hFig to visible upon completion</span>
0100     set(hFig,<span class="string">'Visible'</span>,<span class="string">'on'</span>); drawnow;
0101     
0102     
0103     <a name="_sub2" href="#_subfunctions" class="code">function keyPress( h, evnt ) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0104       char=int8(evnt.Character); <span class="keyword">if</span>(isempty(char)), char=0; <span class="keyword">end</span>;
0105       <span class="keyword">if</span>( char&gt;=28 &amp;&amp; char&lt;=31 ) <span class="comment">% L/R/U/D = 28/29/30/31</span>
0106         <span class="keyword">if</span>(char&gt;=30), flag=0; <span class="keyword">else</span> flag=double(char-28)*2-1; <span class="keyword">end</span>
0107         dispApi.setSpeedCb(flag);
0108       <span class="keyword">end</span>
0109     <span class="keyword">end</span>
0110     
0111     <a name="_sub3" href="#_subfunctions" class="code">function figResized( h, evnt ) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
0112       <span class="comment">% aspect ratio of video</span>
0113       <span class="keyword">if</span>(isempty(dispApi)), info=[]; <span class="keyword">else</span> info=dispApi.getInfo(); <span class="keyword">end</span>
0114       <span class="keyword">if</span>(isempty(info)), ar=4/3; <span class="keyword">else</span> ar=info.width/info.height; <span class="keyword">end</span>
0115       <span class="comment">% enforce minimum size (min width=500+pad*2)</span>
0116       pos=get(hFig,ps); pad=8; htSl=20; htTop=20;
0117       mWd=500+pad*2; mHt=round(500/ar+htSl+htTop+pad*2);
0118       <span class="keyword">persistent</span> posPrv;
0119       <span class="keyword">if</span>(pos(3)&lt;mWd || pos(4)&lt;mHt &amp;&amp; ~isempty(posPrv))
0120         set(hFig,ps,[posPrv(1:2) mWd mHt]); <a href="#_sub3" class="code" title="subfunction figResized( h, evnt ) ">figResized</a>(); <span class="keyword">return</span>;
0121       <span class="keyword">end</span>; posPrv=pos;
0122       <span class="comment">% overall layout</span>
0123       wd=pos(3)-2*pad; ht=pos(4)-2*pad-htSl-htTop;
0124       wd=min(wd,ht*ar); ht=min(ht,wd/ar); x=(pos(3)-wd)/2; y=pad;
0125       set(pMid.hLf,ps,[x y 22 htSl]);
0126       set(pMid.hSl,ps,[x+22 y wd-44 htSl]);
0127       set(pMid.hRt,ps,[x+wd-22 y 22 htSl]); y=y+htSl;
0128       set(pMid.hAx,ps,[x y wd ht]); y=y+ht;
0129       set(pTop.h,ps,[x y wd htTop]);
0130       <span class="comment">% position stuff in top panel</span>
0131       x=10;
0132       set(pTop.hPlyLbl,ps,[x 3 40 14]); x=x+40;
0133       set(pTop.hPlySpd,ps,[x 3 40 14]); x=x+40;
0134       set(pTop.hTmLbl,ps,[x 3 30 14]); x=x+30;
0135       set(pTop.hTmVal,ps,[x 3 45 14]); x=x+50;
0136       set(pTop.hFrmLbl,ps,[x 3 35 14]); x=x+35;
0137       set(pTop.hFrmInd,ps,[x 3 50 16]); x=x+50;
0138       set(pTop.hFrmNum,ps,[x 3 60 14]);
0139       <span class="comment">% update display</span>
0140       <span class="keyword">if</span>(~isempty(dispApi)); dispApi.requestUpdate(); <span class="keyword">end</span>;
0141     <span class="keyword">end</span>
0142     
0143     <a name="_sub4" href="#_subfunctions" class="code">function exitProg( h, evnt ) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
0144       menuApi.vidClose();
0145     <span class="keyword">end</span>
0146   <span class="keyword">end</span>
0147 
0148   <a name="_sub5" href="#_subfunctions" class="code">function api = dispMakeApi()</a>
0149     <span class="comment">% create api</span>
0150     [sr, audio, info, nFrame, speed, curInd, hs, <span class="keyword">...</span>
0151       hImg, needUpdate, prevTime, looping ]=deal([]);
0152     api = struct( <span class="string">'setVid'</span>,@<a href="#_sub6" class="code" title="subfunction setVid( sr1 )">setVid</a>, <span class="string">'setAud'</span>,@<a href="#_sub7" class="code" title="subfunction setAud(y,fs,nb)">setAud</a>, <span class="keyword">...</span>
0153       <span class="string">'setSpeedCb'</span>,@<a href="#_sub9" class="code" title="subfunction setSpeedCb( flag )">setSpeedCb</a>, <span class="string">'getInfo'</span>,@<a href="#_sub14" class="code" title="subfunction info1 = getInfo(), info1=info; end">getInfo</a>, <span class="keyword">...</span>
0154       <span class="string">'getFrame'</span>,@<a href="#_sub15" class="code" title="subfunction curInd1 = getFrame(), curInd1=round(curInd); end">getFrame</a>, <span class="string">'requestUpdate'</span>,@requestUpdate );
0155     set(pMid.hSl,    <span class="string">'Callback'</span>,@(h,evnt) <a href="#_sub11" class="code" title="subfunction setFrameCb( flag )">setFrameCb</a>(0));
0156     set(pTop.hFrmInd,<span class="string">'Callback'</span>,@(h,evnt) <a href="#_sub11" class="code" title="subfunction setFrameCb( flag )">setFrameCb</a>(1));
0157     set(pMid.hLf, <span class="string">'Callback'</span>,@(h,evnt) <a href="#_sub9" class="code" title="subfunction setSpeedCb( flag )">setSpeedCb</a>(-1));
0158     set(pMid.hRt, <span class="string">'Callback'</span>,@(h,evnt) <a href="#_sub9" class="code" title="subfunction setSpeedCb( flag )">setSpeedCb</a>(+1));
0159     
0160     <a name="_sub6" href="#_subfunctions" class="code">function setVid( sr1 )</a>
0161       <span class="comment">% reset local variables</span>
0162       <span class="keyword">if</span>(isstruct(sr)), sr=sr.close(); <span class="keyword">end</span>
0163       <span class="keyword">if</span>(~isempty(hs)), delete(hs); hs=[]; <span class="keyword">end</span>
0164       [sr, audio, info, nFrame, speed, curInd, hs, <span class="keyword">...</span>
0165         hImg, needUpdate, prevTime, looping ]=deal([]);
0166       sr=sr1; nFrame=0; looping=0; speed=-1; <a href="#_sub12" class="code" title="subfunction setFrame( curInd1, speed1 )">setFrame</a>( 0, 0 );
0167       <span class="comment">% update GUI</span>
0168       <span class="keyword">if</span>(~isstruct(sr)), cla(pMid.hAx); <span class="keyword">else</span>
0169         info=sr.getinfo(); nFrame=info.numFrames;
0170         sr.seek(0); s=max(1e-6,1/(nFrame-1)); ss={<span class="string">'SliderStep'</span>,[s,s]};
0171         <span class="keyword">if</span>(nFrame&gt;1), set(pMid.hSl,<span class="string">'Max'</span>,nFrame-1,ss{:}); <span class="keyword">end</span>
0172         hImg = imshow( zeros(info.height,info.width,<span class="string">'uint8'</span>) );
0173       <span class="keyword">end</span>
0174       set(pMid.hSl,<span class="string">'Value'</span>,0); v=(nFrame&gt;1)+1;
0175       en={<span class="string">'off'</span>,<span class="string">'on'</span>}; set([pMid.hSl pMid.hLf pMid.hRt],<span class="string">'Enable'</span>,en{v});
0176       en={<span class="string">'inactive'</span>,<span class="string">'on'</span>}; set(pTop.hFrmInd,<span class="string">'Enable'</span>,en{v});
0177       set(pTop.hFrmInd,<span class="string">'String'</span>,<span class="string">'0'</span>); set(pTop.hTmVal,<span class="string">'String'</span>,<span class="string">'0:00'</span>);
0178       set(pTop.hFrmNum,<span class="string">'String'</span>,[<span class="string">' / '</span> int2str(nFrame)]);
0179       <span class="comment">% update display</span>
0180       feval(get(hFig,<span class="string">'ResizeFcn'</span>));
0181       requestUpdate();
0182     <span class="keyword">end</span>
0183     
0184     <a name="_sub7" href="#_subfunctions" class="code">function setAud(y,fs,nb)</a>
0185       a = abs(1 - (length(y)/fs) / (nFrame/info.fps));
0186       <span class="keyword">if</span>(a&gt;.01), error(<span class="string">'Audio/video mismatch.'</span>); <span class="keyword">end</span>
0187       audio.fPlay=audioplayer(y,fs,nb);
0188       audio.bPlay=audioplayer(flipud(y),fs,nb);
0189       audio.fs=fs; audio.ln=length(y); <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>(speed);
0190       requestUpdate();
0191     <span class="keyword">end</span>
0192     
0193     <a name="_sub8" href="#_subfunctions" class="code">function dispLoop()</a>
0194       <span class="keyword">if</span>(looping), <span class="keyword">return</span>; <span class="keyword">end</span>; looping=1; k=0;
0195       <span class="keyword">while</span>( 1 )
0196         <span class="comment">% exit if appropriate, or if vid not loaded do nothing</span>
0197         <span class="keyword">if</span>(~isstruct(sr) || ~isstruct(info)), looping=0; <span class="keyword">return</span>; <span class="keyword">end</span>
0198         
0199         <span class="comment">% stop playing video if at begin/end</span>
0200         <span class="keyword">if</span>((speed&gt;0&amp;&amp;curInd==nFrame-1) || (speed&lt;0&amp;&amp;curInd==0))
0201           <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>(0); needUpdate=1;
0202         <span class="keyword">end</span>
0203         
0204         <span class="comment">% increment/decrement curInd appropriately</span>
0205         <span class="keyword">if</span>( speed~=0 )
0206           t=clock(); eTime=etime(t,prevTime);
0207           del = speed * max(10,info.fps) * min(.1,eTime);
0208           <span class="keyword">if</span>( speed&gt;0 ), del=min(del, nFrame-curInd-1 ); <span class="keyword">end</span>
0209           <span class="keyword">if</span>( speed&lt;0 ), del=max(del, -curInd ); <span class="keyword">end</span>
0210           <a href="#_sub12" class="code" title="subfunction setFrame( curInd1, speed1 )">setFrame</a>(curInd+del, speed); prevTime=t; needUpdate=1;
0211         <span class="keyword">end</span>
0212         
0213         <span class="comment">% update display if necessary</span>
0214         k=k+1; <span class="keyword">if</span>(0 &amp;&amp; ~needUpdate), fprintf(<span class="string">'%i draw events.\n'</span>,k); <span class="keyword">end</span>
0215         <span class="keyword">if</span>(~needUpdate), looping=0; <span class="keyword">return</span>; <span class="keyword">end</span>
0216         sr.seek( round(curInd) ); I=sr.getframe();
0217         <span class="keyword">if</span>(~isempty(hs)), delete(hs); hs=[]; <span class="keyword">end</span>
0218         <span class="keyword">if</span>(~isempty(dispFunc)), hs=dispFunc(round(curInd)); <span class="keyword">end</span>
0219         assert(~isempty(I)); set(hImg,<span class="string">'CData'</span>,I);
0220         set(pMid.hSl,<span class="string">'Value'</span>,curInd); c=round(curInd/info.fps);
0221         set(pTop.hFrmInd,<span class="string">'String'</span>,int2str(round(curInd+1)));
0222         c0=floor(c/3600); c=mod(c,3600); c1=floor(c/60); c2=mod(c,60);
0223         <span class="keyword">if</span>(~c0), set(pTop.hTmVal,<span class="string">'String'</span>,sprintf(<span class="string">'%i:%02i'</span>,c1,c2)); <span class="keyword">else</span>
0224           set(pTop.hTmVal,<span class="string">'String'</span>,sprintf(<span class="string">'%i:%02i:%02i'</span>,c0,c1,c2)); <span class="keyword">end</span>
0225         needUpdate=false; drawnow();
0226       <span class="keyword">end</span>
0227     <span class="keyword">end</span>
0228     
0229     <a name="_sub9" href="#_subfunctions" class="code">function setSpeedCb( flag )</a>
0230       <span class="keyword">if</span>(~isstruct(sr)),<span class="keyword">return</span>; <span class="keyword">end</span>
0231       <span class="keyword">if</span>( flag==0 )
0232         <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>( 0 );
0233       <span class="keyword">elseif</span>( speed==0 )
0234         <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>( flag ); prevTime=clock();
0235       <span class="keyword">elseif</span>( sign(speed)==flag &amp;&amp; abs(speed)&lt;2^12 )
0236         <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>( speed*2 );
0237       <span class="keyword">elseif</span>( sign(speed)~=flag &amp;&amp; abs(speed)&gt;1/8 )
0238         <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>( speed/2 );
0239       <span class="keyword">elseif</span>( sign(speed)~=flag )
0240         <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>( 0 );
0241       <span class="keyword">end</span>
0242       requestUpdate();
0243     <span class="keyword">end</span>
0244     
0245     <a name="_sub10" href="#_subfunctions" class="code">function setSpeed( speed1 )</a>
0246       <span class="keyword">if</span>((speed1&gt;0&amp;&amp;curInd==nFrame-1)||(speed1&lt;0&amp;&amp;curInd==0)),speed1=0;<span class="keyword">end</span>
0247       speed=speed1; p=abs(speed); <span class="keyword">if</span>(speed&lt;0), ss=<span class="string">'-'</span>; <span class="keyword">else</span> ss=<span class="string">''</span>; <span class="keyword">end</span>
0248       <span class="keyword">if</span>(p&lt;1 &amp;&amp; p~=0), s=[<span class="string">'1/'</span> int2str(1/p)]; <span class="keyword">else</span> s=int2str(p); <span class="keyword">end</span>
0249       set(pTop.hPlySpd,<span class="string">'String'</span>,[ss s <span class="string">'x'</span>]);
0250       <span class="keyword">if</span>(~isempty(audio))
0251         stop(audio.fPlay); stop(audio.bPlay); <span class="keyword">if</span>(speed==0), <span class="keyword">return</span>; <span class="keyword">end</span>;
0252         st=curInd/(nFrame-1); <span class="keyword">if</span>(speed&lt;0), st=1-st; <span class="keyword">end</span>; st=st*audio.ln+1;
0253         <span class="keyword">if</span>(speed&gt;0), plr=audio.fPlay; <span class="keyword">else</span> plr=audio.bPlay; <span class="keyword">end</span>;
0254         set(plr,<span class="string">'SampleRate'</span>,audio.fs*p); play(plr,st);
0255       <span class="keyword">end</span>
0256     <span class="keyword">end</span>
0257     
0258     <a name="_sub11" href="#_subfunctions" class="code">function setFrameCb( flag )</a>
0259       <span class="keyword">if</span>( flag==0 )
0260         f=round(get(pMid.hSl,<span class="string">'Value'</span>)); set(pMid.hSl,<span class="string">'Value'</span>,f);
0261       <span class="keyword">elseif</span>(flag==1)
0262         f=str2double(get(pTop.hFrmInd,<span class="string">'String'</span>));
0263         <span class="keyword">if</span>(isnan(f)), requestUpdate(); <span class="keyword">return</span>; <span class="keyword">else</span> f=f-1; <span class="keyword">end</span>
0264       <span class="keyword">end</span>
0265       <a href="#_sub12" class="code" title="subfunction setFrame( curInd1, speed1 )">setFrame</a>(f,0);
0266     <span class="keyword">end</span>
0267     
0268     <a name="_sub12" href="#_subfunctions" class="code">function setFrame( curInd1, speed1 )</a>
0269       curInd=max(0,min(curInd1,nFrame-1));
0270       <span class="keyword">if</span>( speed~=speed1 ), <a href="#_sub10" class="code" title="subfunction setSpeed( speed1 )">setSpeed</a>(speed1); <span class="keyword">end</span>
0271       requestUpdate();
0272     <span class="keyword">end</span>
0273     
0274     <a name="_sub13" href="#_subfunctions" class="code">function requestUpdate(), needUpdate=true; dispLoop(); end</a>
0275     
0276     <a name="_sub14" href="#_subfunctions" class="code">function info1 = getInfo(), info1=info; end</a>
0277     
0278     <a name="_sub15" href="#_subfunctions" class="code">function curInd1 = getFrame(), curInd1=round(curInd); end</a>
0279   <span class="keyword">end</span>
0280 
0281   <a name="_sub16" href="#_subfunctions" class="code">function api = menuMakeApi()</a>
0282     <span class="comment">% create api</span>
0283     fVid=deal([]);
0284     api=struct(<span class="string">'vidClose'</span>,@<a href="#_sub18" class="code" title="subfunction vidClose()">vidClose</a>,<span class="string">'vidOpen'</span>,@<a href="#_sub19" class="code" title="subfunction vidOpen( flag )">vidOpen</a>,<span class="string">'audOpen'</span>,@<a href="#_sub21" class="code" title="subfunction audOpen( fAud )">audOpen</a>);
0285     set(menu.hVidOpn,<span class="string">'Callback'</span>,@(h,envt) <a href="#_sub19" class="code" title="subfunction vidOpen( flag )">vidOpen</a>(1) );
0286     set(menu.hVidsOpn,<span class="string">'Callback'</span>,@(h,envt) <a href="#_sub19" class="code" title="subfunction vidOpen( flag )">vidOpen</a>(2) );
0287     set(menu.hVidCls,<span class="string">'Callback'</span>,@(h,envt) <a href="#_sub18" class="code" title="subfunction vidClose()">vidClose</a>() );
0288     set(menu.hVidInfo,<span class="string">'Callback'</span>,@(h,envt) <a href="#_sub20" class="code" title="subfunction vidInfo()">vidInfo</a>() );
0289     set(menu.hVidAud,<span class="string">'Callback'</span>,@(h,envt) <a href="#_sub21" class="code" title="subfunction audOpen( fAud )">audOpen</a>() );
0290     
0291     <a name="_sub17" href="#_subfunctions" class="code">function updateMenus()</a>
0292       m=menu; <span class="keyword">if</span>(isempty(fVid)), en=<span class="string">'off'</span>; <span class="keyword">else</span> en=<span class="string">'on'</span>; <span class="keyword">end</span>
0293       set([m.hVidCls m.hVidInfo m.hVidAud],<span class="string">'Enable'</span>,en); nm=<span class="string">'Seq Player'</span>;
0294       <span class="keyword">if</span>(~isempty(fVid)), [~,nm1]=fileparts(fVid); nm=[nm <span class="string">' - '</span> nm1]; <span class="keyword">end</span>
0295       set(hFig,<span class="string">'Name'</span>,nm); dispApi.requestUpdate();
0296     <span class="keyword">end</span>
0297     
0298     <a name="_sub18" href="#_subfunctions" class="code">function vidClose()</a>
0299       fVid=[]; dispApi.setVid([]); <a href="#_sub17" class="code" title="subfunction updateMenus()">updateMenus</a>();
0300     <span class="keyword">end</span>
0301     
0302     <a name="_sub19" href="#_subfunctions" class="code">function vidOpen( flag )</a>
0303       <span class="keyword">if</span>(isempty(fVid)), d=<span class="string">'.'</span>; <span class="keyword">else</span> d=fileparts(fVid); <span class="keyword">end</span>
0304       <span class="keyword">if</span>(all(ischar(flag)))
0305         [d,f]=fileparts(flag); <span class="keyword">if</span>(isempty(d)), d=<span class="string">'.'</span>; <span class="keyword">end</span>;
0306         d=[d <span class="string">'/'</span>]; f=[f <span class="string">'.seq'</span>]; flag=1;
0307       <span class="keyword">elseif</span>(iscell(flag)), assert(length(flag)==2);
0308         [d,f]=fileparts(flag{1}); <span class="keyword">if</span>(isempty(d)), d=<span class="string">'.'</span>; <span class="keyword">end</span>;
0309         [d2,f2]=fileparts(flag{2}); <span class="keyword">if</span>(isempty(d2)), d2=<span class="string">'.'</span>; <span class="keyword">end</span>;
0310         d=[d <span class="string">'/'</span>]; f=[f <span class="string">'.seq'</span>]; d2=[d2 <span class="string">'/'</span>]; f2=[f2 <span class="string">'.seq'</span>]; flag=2;
0311       <span class="keyword">elseif</span>( flag==1 )
0312         [f,d]=uigetfile(<span class="string">'*.seq'</span>,<span class="string">'Select video'</span>,[d <span class="string">'/*.seq'</span>]);
0313       <span class="keyword">elseif</span>( flag==2 )
0314         [f,d]=uigetfile(<span class="string">'*.seq'</span>,<span class="string">'Select first video'</span>,[d <span class="string">'/*.seq'</span>]);
0315         [f2,d2]=uigetfile(<span class="string">'*.seq'</span>,<span class="string">'Select second video'</span>,[d <span class="string">'/*.seq'</span>]);
0316         <span class="keyword">if</span>( f2==0 ), <span class="keyword">return</span>; <span class="keyword">end</span>
0317       <span class="keyword">end</span>
0318       <span class="keyword">if</span>( f==0 ), <span class="keyword">return</span>; <span class="keyword">end</span>; <a href="#_sub18" class="code" title="subfunction vidClose()">vidClose</a>(); fVid=[d f];
0319       <span class="keyword">try</span>
0320         <span class="keyword">if</span>( flag==1 ), sr=<a href="seqIo.html" class="code" title="function out = seqIo( fName, action, varargin )">seqIo</a>(fVid,<span class="string">'r'</span>); <span class="keyword">else</span>
0321           sr=<a href="seqIo.html" class="code" title="function out = seqIo( fName, action, varargin )">seqIo</a>({fVid,[d2 f2]},<span class="string">'rdual'</span>); <span class="keyword">end</span>
0322         dispApi.setVid(sr); <a href="#_sub17" class="code" title="subfunction updateMenus()">updateMenus</a>();
0323       <span class="keyword">catch</span> er
0324         errordlg([<span class="string">'Failed to load: '</span> fVid <span class="string">'. '</span> er.message],<span class="string">'Error'</span>);
0325         fVid=[]; <span class="keyword">return</span>;
0326       <span class="keyword">end</span>
0327     <span class="keyword">end</span>
0328     
0329     <a name="_sub20" href="#_subfunctions" class="code">function vidInfo()</a>
0330       info=dispApi.getInfo(); txt=evalc(<span class="string">'disp(info);'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
0331       <span class="keyword">while</span>(txt(end)==10), txt=txt(1:end-1); <span class="keyword">end</span>; txt=[char([10 10]) txt];
0332       pos=get(hFig,<span class="string">'Position'</span>); pos(1:2)=pos(1:2)+100; pos(3:4)=[400 400];
0333       h=figure(<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="string">'Toolbar'</span>,<span class="string">'auto'</span>, <span class="keyword">...</span>
0334         <span class="string">'Color'</span>,<span class="string">'k'</span>, <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="string">'Visible'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0335         <span class="string">'Name'</span>,<span class="string">''</span>, <span class="string">'Resize'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,pos); pos(1:2)=0;
0336       uicontrol(h,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'BackgroundColor'</span>,<span class="string">'w'</span>,<span class="keyword">...</span>
0337         <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>,<span class="string">'Position'</span>,pos,<span class="string">'String'</span>,txt,<span class="keyword">...</span>
0338         <span class="string">'FontName'</span>,<span class="string">'FixedWidth'</span>);
0339     <span class="keyword">end</span>
0340     
0341     <a name="_sub21" href="#_subfunctions" class="code">function audOpen( fAud )</a>
0342       <span class="keyword">if</span>( nargin==0 ), [f,d]=uigetfile(<span class="string">'*.wav'</span>,<span class="string">'Select audio'</span>,<span class="keyword">...</span>
0343           [fVid(1:end-3) <span class="string">'wav'</span>]); <span class="keyword">if</span>(f==0), <span class="keyword">return</span>; <span class="keyword">end</span>; fAud=[d f]; <span class="keyword">end</span>
0344       <span class="keyword">try</span>
0345         [y,fs,nb]=wavread(fAud); dispApi.setAud(y,fs,nb); <span class="comment">%#ok&lt;REMFF1&gt;</span>
0346       <span class="keyword">catch</span> er
0347         errordlg([<span class="string">'Failed to load: '</span> fAud <span class="string">'. '</span> er.message],<span class="string">'Error'</span>);
0348       <span class="keyword">end</span>
0349     <span class="keyword">end</span>
0350     
0351   <span class="keyword">end</span>
0352 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 05-May-2022 15:20:21 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>