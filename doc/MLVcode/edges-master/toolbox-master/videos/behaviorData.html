<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of behaviorData</title>
  <meta name="keywords" content="behaviorData">
  <meta name="description" content="Retrieve and manipulate behavior annotation of a video.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">MLVcode</a> &gt; <a href="../../index.html">edges-master</a> &gt; <a href="#">toolbox-master</a> &gt; <a href="index.html">videos</a> &gt; behaviorData.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for MLVcode\edges-master\toolbox-master\videos&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>behaviorData
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Retrieve and manipulate behavior annotation of a video.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function A = behaviorData( action, fName, nFrame1 ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Retrieve and manipulate behavior annotation of a video.

 Overview: A behavior annotation assigns every frame of a video to one of
 k behaviors. Each consecutive set of frames is a single behavior
 instance, the video is divided into n such behavior instances each with
 its own type. Such a delineation is considered a single stream. To allow
 labeling of overlapping behaviors or simultaneous labeling of behaviors
 for multiple subjects, multiple streams can be used.

 Construction: Calling behaviorData(action,fName,nFrame) creates or loads
 an object A that is used to represent a behavior annotation. The 'action'
 flag controls whether to 'load' a previously saved annotation or to
 'create' a new annotation. If constructing a new annotation, two
 parameters control the annotation created: a configuration file (fName)
 with the number of streams to use and the behavior list (see below) and
 the number of frames in the video (nFrame). If loading a new annotation,
 fName should point to the name of a previously saved annotation (with
 either a .bAnn or .txt extension), nFrame is not needed. The .txt format
 may be preferred as it is human readable (although slightly larger file
 sizes may result). After creation, A is manipulated using object oriented
 syntax, for example A.nFrame() returns the number of frames of the
 underlying video (more details below).

 Config file: should be a text file listing possible behavior types along
 with a single character for each that will serve as a shortcut key. The
 first line should be &quot;nStream [val]&quot; where [val] is the number of
 annotation streams. Each following line should be the behavior name
 followed by a character representing the key. Additionally, the first
 behavior serves as the default behavior initially assigned to the entire
 video, and should be named accordingly. Below is an example config file:
   nStream 2
   other o
   eating e
   grooming g
   drinking d
   sleeping s

 Representation: An annotation of a single stream can be represented as
 n+1 boundaries (bnds) delineating the starts of each behavior, with the
 last bnd being the number of frames, and n integer types representing the
 type of each behavior. For example, bnds=[0 100 nFrame] and types=[1 2]
 would indicate frames 0-99 have type 1 and 100-(nFrame-1) have type 2.
 Each type must have value in 1 to k, and the associated behavior name of
 each type can be retrieved from a string cell array containing the k
 names. Note that consecutive behaviors of the same type are merged.

 Save, recreate, merge:
  save(fName)        - save to file (.bAnn or .txt)
  recreate(cName)    - specify new configuration file
  merge(fName)       - load second annotation, merge streams

 Inspect (always inspect current stream):
  n1 = n()           - number of behavior instances
  k1 = k()           - number of behavior types
  nFrame1 = nFrame() - number of frames in underlying video
  nStrm1 = nStrm()   - number of annotation streams
  types = getTypes() - length n vector of integer types
  bnds = getBnds()   - length n+1 vector of frame boundaries
  names = getNames() - length k cell vector of behavior names
  keys = getKeys()   - length k char vector of key shortcuts
  type = getType(id) - type of behavior for id-th instance
  name = getName(id) - name of behavior for id-th instance
  frm = getStart(id) - start frame for id-th instance
  frm = getEnd(id)   - end frame for id-th instance
  id = getId(frm)    - id of behavior at given frame (1&lt;=id&lt;=n)
  ids = getIds(type) - all ids for behavior of given type
  lbl = getLbls()    - get per frame labeling - [1 x nFrame]

 Alter (always alter current stream):
  setStrm(strm)      - set current stream
  setType(id,type)   - change type of given behavior
  move(id,frame)     - move behavior start (must remain between prev/next)
  add(type, frame)   - add behavior with start at given frame
  delete(id)         - delete behavior by extending prev behavior
  crop(fr0,fr1)      - crop annotation to given range
  insert(frs)        - extend annotation by inserting frames
  setLbls(lbl)       - set per frame labeling - [1 x nFrame]

 USAGE
  A = behaviorData( action, fName, nFrame )

 INPUTS
  action   - 'load' or 'create'
  fName    - location of annotation or config file
  nFrame   - number of frames if creating video

 OUTPUTS
  A        - annotation structure

 EXAMPLE

 See also <a href="behaviorAnnotator.html" class="code" title="function behaviorAnnotator( fName, aName, tName )">behaviorAnnotator</a>

 Piotr's Computer Vision Matlab Toolbox      Version 2.60
 Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]
 Licensed under the Simplified BSD License [see external/bsd.txt]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="behaviorAnnotator.html" class="code" title="function behaviorAnnotator( fName, aName, tName )">behaviorAnnotator</a>	Caltech Behavior Annotator.</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function save1( fName )</a></li><li><a href="#_sub2" class="code">function load1( fName, cName )</a></li><li><a href="#_sub3" class="code">function merge( fName )</a></li><li><a href="#_sub4" class="code">function saveTxt( fName )</a></li><li><a href="#_sub5" class="code">function loadTxt( fName, cName )</a></li><li><a href="#_sub6" class="code">function create( varargin )</a></li><li><a href="#_sub7" class="code">function recreate( cName )</a></li><li><a href="#_sub8" class="code">function n1 = n(), n1=length(types{s}); end</a></li><li><a href="#_sub9" class="code">function k1 = k(), k1=length(names); end</a></li><li><a href="#_sub10" class="code">function nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end</a></li><li><a href="#_sub11" class="code">function nStrm1 = nStrm(), nStrm1=length(bnds); end</a></li><li><a href="#_sub12" class="code">function types1 = getTypes(), types1=types{s}; end</a></li><li><a href="#_sub13" class="code">function bnds1 = getBnds(), bnds1=bnds{s}; end</a></li><li><a href="#_sub14" class="code">function names1 = getNames(), names1=names; end</a></li><li><a href="#_sub15" class="code">function keys1 = getKeys(), keys1=keys; end</a></li><li><a href="#_sub16" class="code">function type = getType( id ), type=types{s}(id); end</a></li><li><a href="#_sub17" class="code">function name = getName( id ), name=names{getType(id)}; end</a></li><li><a href="#_sub18" class="code">function frame = getStart( id ), frame=bnds{s}(id); end</a></li><li><a href="#_sub19" class="code">function frame = getEnd( id ), frame=bnds{s}(id+1)-1; end</a></li><li><a href="#_sub20" class="code">function id = getId( frame ), [~,id]=min(bnds{s}<=frame); id=id-1; end</a></li><li><a href="#_sub21" class="code">function ids = getIds( type ), ids=find(types{s}==type); end</a></li><li><a href="#_sub22" class="code">function lbl = getLbls()</a></li><li><a href="#_sub23" class="code">function setStrm( s1 ), assert(s1>0 && s1<=nStrm); s=s1; end</a></li><li><a href="#_sub24" class="code">function setType( id, type )</a></li><li><a href="#_sub25" class="code">function move( id, frame )</a></li><li><a href="#_sub26" class="code">function add( type, frame )</a></li><li><a href="#_sub27" class="code">function delete( id )</a></li><li><a href="#_sub28" class="code">function crop( fr0, fr1 )</a></li><li><a href="#_sub29" class="code">function insert( frs )</a></li><li><a href="#_sub30" class="code">function setLbls( lbl )</a></li><li><a href="#_sub31" class="code">function condense()</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function A = behaviorData( action, fName, nFrame1 )</a>
0002 <span class="comment">% Retrieve and manipulate behavior annotation of a video.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Overview: A behavior annotation assigns every frame of a video to one of</span>
0005 <span class="comment">% k behaviors. Each consecutive set of frames is a single behavior</span>
0006 <span class="comment">% instance, the video is divided into n such behavior instances each with</span>
0007 <span class="comment">% its own type. Such a delineation is considered a single stream. To allow</span>
0008 <span class="comment">% labeling of overlapping behaviors or simultaneous labeling of behaviors</span>
0009 <span class="comment">% for multiple subjects, multiple streams can be used.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% Construction: Calling behaviorData(action,fName,nFrame) creates or loads</span>
0012 <span class="comment">% an object A that is used to represent a behavior annotation. The 'action'</span>
0013 <span class="comment">% flag controls whether to 'load' a previously saved annotation or to</span>
0014 <span class="comment">% 'create' a new annotation. If constructing a new annotation, two</span>
0015 <span class="comment">% parameters control the annotation created: a configuration file (fName)</span>
0016 <span class="comment">% with the number of streams to use and the behavior list (see below) and</span>
0017 <span class="comment">% the number of frames in the video (nFrame). If loading a new annotation,</span>
0018 <span class="comment">% fName should point to the name of a previously saved annotation (with</span>
0019 <span class="comment">% either a .bAnn or .txt extension), nFrame is not needed. The .txt format</span>
0020 <span class="comment">% may be preferred as it is human readable (although slightly larger file</span>
0021 <span class="comment">% sizes may result). After creation, A is manipulated using object oriented</span>
0022 <span class="comment">% syntax, for example A.nFrame() returns the number of frames of the</span>
0023 <span class="comment">% underlying video (more details below).</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% Config file: should be a text file listing possible behavior types along</span>
0026 <span class="comment">% with a single character for each that will serve as a shortcut key. The</span>
0027 <span class="comment">% first line should be &quot;nStream [val]&quot; where [val] is the number of</span>
0028 <span class="comment">% annotation streams. Each following line should be the behavior name</span>
0029 <span class="comment">% followed by a character representing the key. Additionally, the first</span>
0030 <span class="comment">% behavior serves as the default behavior initially assigned to the entire</span>
0031 <span class="comment">% video, and should be named accordingly. Below is an example config file:</span>
0032 <span class="comment">%   nStream 2</span>
0033 <span class="comment">%   other o</span>
0034 <span class="comment">%   eating e</span>
0035 <span class="comment">%   grooming g</span>
0036 <span class="comment">%   drinking d</span>
0037 <span class="comment">%   sleeping s</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% Representation: An annotation of a single stream can be represented as</span>
0040 <span class="comment">% n+1 boundaries (bnds) delineating the starts of each behavior, with the</span>
0041 <span class="comment">% last bnd being the number of frames, and n integer types representing the</span>
0042 <span class="comment">% type of each behavior. For example, bnds=[0 100 nFrame] and types=[1 2]</span>
0043 <span class="comment">% would indicate frames 0-99 have type 1 and 100-(nFrame-1) have type 2.</span>
0044 <span class="comment">% Each type must have value in 1 to k, and the associated behavior name of</span>
0045 <span class="comment">% each type can be retrieved from a string cell array containing the k</span>
0046 <span class="comment">% names. Note that consecutive behaviors of the same type are merged.</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% Save, recreate, merge:</span>
0049 <span class="comment">%  save(fName)        - save to file (.bAnn or .txt)</span>
0050 <span class="comment">%  recreate(cName)    - specify new configuration file</span>
0051 <span class="comment">%  merge(fName)       - load second annotation, merge streams</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% Inspect (always inspect current stream):</span>
0054 <span class="comment">%  n1 = n()           - number of behavior instances</span>
0055 <span class="comment">%  k1 = k()           - number of behavior types</span>
0056 <span class="comment">%  nFrame1 = nFrame() - number of frames in underlying video</span>
0057 <span class="comment">%  nStrm1 = nStrm()   - number of annotation streams</span>
0058 <span class="comment">%  types = getTypes() - length n vector of integer types</span>
0059 <span class="comment">%  bnds = getBnds()   - length n+1 vector of frame boundaries</span>
0060 <span class="comment">%  names = getNames() - length k cell vector of behavior names</span>
0061 <span class="comment">%  keys = getKeys()   - length k char vector of key shortcuts</span>
0062 <span class="comment">%  type = getType(id) - type of behavior for id-th instance</span>
0063 <span class="comment">%  name = getName(id) - name of behavior for id-th instance</span>
0064 <span class="comment">%  frm = getStart(id) - start frame for id-th instance</span>
0065 <span class="comment">%  frm = getEnd(id)   - end frame for id-th instance</span>
0066 <span class="comment">%  id = getId(frm)    - id of behavior at given frame (1&lt;=id&lt;=n)</span>
0067 <span class="comment">%  ids = getIds(type) - all ids for behavior of given type</span>
0068 <span class="comment">%  lbl = getLbls()    - get per frame labeling - [1 x nFrame]</span>
0069 <span class="comment">%</span>
0070 <span class="comment">% Alter (always alter current stream):</span>
0071 <span class="comment">%  setStrm(strm)      - set current stream</span>
0072 <span class="comment">%  setType(id,type)   - change type of given behavior</span>
0073 <span class="comment">%  move(id,frame)     - move behavior start (must remain between prev/next)</span>
0074 <span class="comment">%  add(type, frame)   - add behavior with start at given frame</span>
0075 <span class="comment">%  delete(id)         - delete behavior by extending prev behavior</span>
0076 <span class="comment">%  crop(fr0,fr1)      - crop annotation to given range</span>
0077 <span class="comment">%  insert(frs)        - extend annotation by inserting frames</span>
0078 <span class="comment">%  setLbls(lbl)       - set per frame labeling - [1 x nFrame]</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% USAGE</span>
0081 <span class="comment">%  A = behaviorData( action, fName, nFrame )</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% INPUTS</span>
0084 <span class="comment">%  action   - 'load' or 'create'</span>
0085 <span class="comment">%  fName    - location of annotation or config file</span>
0086 <span class="comment">%  nFrame   - number of frames if creating video</span>
0087 <span class="comment">%</span>
0088 <span class="comment">% OUTPUTS</span>
0089 <span class="comment">%  A        - annotation structure</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% EXAMPLE</span>
0092 <span class="comment">%</span>
0093 <span class="comment">% See also behaviorAnnotator</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% Piotr's Computer Vision Matlab Toolbox      Version 2.60</span>
0096 <span class="comment">% Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]</span>
0097 <span class="comment">% Licensed under the Simplified BSD License [see external/bsd.txt]</span>
0098 
0099 <span class="comment">% fields for storing annotation</span>
0100 [bnds,types,names,keys,s]=deal([]);
0101 
0102 <span class="comment">% load or initialize</span>
0103 assert(nargin&gt;=2); <span class="keyword">if</span>(nargin&lt;3), nFrame1=[]; <span class="keyword">end</span>
0104 <span class="keyword">switch</span> action
0105   <span class="keyword">case</span> <span class="string">'load'</span>, <a href="#_sub2" class="code" title="subfunction load1( fName, cName )">load1</a>(fName,nFrame1);
0106   <span class="keyword">case</span> <span class="string">'create'</span>, <a href="#_sub6" class="code" title="subfunction create( varargin )">create</a>(fName,nFrame1);
0107 <span class="keyword">end</span>
0108 
0109 <span class="comment">% create API</span>
0110 A = struct( <span class="string">'save'</span>,@<a href="#_sub1" class="code" title="subfunction save1( fName )">save1</a>,<span class="string">'recreate'</span>,@<a href="#_sub7" class="code" title="subfunction recreate( cName )">recreate</a>, <span class="keyword">...</span>
0111   <span class="string">'merge'</span>,@<a href="#_sub3" class="code" title="subfunction merge( fName )">merge</a>, <span class="string">'n'</span>,@<a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>, <span class="string">'k'</span>,@<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>, <span class="string">'nFrame'</span>,@<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>, <span class="string">'nStrm'</span>,@<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>, <span class="keyword">...</span>
0112   <span class="string">'getTypes'</span>,@<a href="#_sub12" class="code" title="subfunction types1 = getTypes(), types1=types{s}; end">getTypes</a>, <span class="string">'getBnds'</span>,@<a href="#_sub13" class="code" title="subfunction bnds1 = getBnds(), bnds1=bnds{s}; end">getBnds</a>, <span class="string">'getNames'</span>,@<a href="#_sub14" class="code" title="subfunction names1 = getNames(), names1=names; end">getNames</a>, <span class="keyword">...</span>
0113   <span class="string">'getKeys'</span>,@<a href="#_sub15" class="code" title="subfunction keys1 = getKeys(), keys1=keys; end">getKeys</a>, <span class="string">'getType'</span>,@<a href="#_sub16" class="code" title="subfunction type = getType( id ), type=types{s}(id); end">getType</a>, <span class="string">'getName'</span>,@<a href="#_sub17" class="code" title="subfunction name = getName( id ), name=names{getType(id)}; end">getName</a>, <span class="keyword">...</span>
0114   <span class="string">'getStart'</span>,@<a href="#_sub18" class="code" title="subfunction frame = getStart( id ), frame=bnds{s}(id); end">getStart</a>, <span class="string">'getEnd'</span>,@<a href="#_sub19" class="code" title="subfunction frame = getEnd( id ), frame=bnds{s}(id+1)-1; end">getEnd</a>, <span class="string">'getId'</span>,@<a href="#_sub20" class="code" title="subfunction id = getId( frame ), [~,id]=min(bnds{s}<=frame); id=id-1; end">getId</a>, <span class="keyword">...</span>
0115   <span class="string">'getIds'</span>,@<a href="#_sub21" class="code" title="subfunction ids = getIds( type ), ids=find(types{s}==type); end">getIds</a>, <span class="string">'getLbls'</span>,@<a href="#_sub22" class="code" title="subfunction lbl = getLbls()">getLbls</a>, <span class="string">'setStrm'</span>,@setStrm, <span class="keyword">...</span>
0116   <span class="string">'setType'</span>,@<a href="#_sub24" class="code" title="subfunction setType( id, type )">setType</a>, <span class="string">'move'</span>,@<a href="#_sub25" class="code" title="subfunction move( id, frame )">move</a>, <span class="string">'add'</span>,@<a href="#_sub26" class="code" title="subfunction add( type, frame )">add</a>, <span class="string">'delete'</span>,@<a href="#_sub27" class="code" title="subfunction delete( id )">delete</a>, <span class="keyword">...</span>
0117   <span class="string">'crop'</span>,@<a href="#_sub28" class="code" title="subfunction crop( fr0, fr1 )">crop</a>, <span class="string">'insert'</span>,@<a href="#_sub29" class="code" title="subfunction insert( frs )">insert</a>, <span class="string">'setLbls'</span>,@<a href="#_sub30" class="code" title="subfunction setLbls( lbl )">setLbls</a> );
0118 
0119 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0120 
0121   <a name="_sub1" href="#_subfunctions" class="code">function save1( fName )</a>
0122     [d,f,ext] = fileparts(fName);
0123     <span class="keyword">if</span>(strcmp(ext,<span class="string">'.txt'</span>)), <a href="#_sub4" class="code" title="subfunction saveTxt( fName )">saveTxt</a>(fName); <span class="keyword">return</span>; <span class="keyword">end</span>
0124     vers=.5; <span class="keyword">if</span>(isempty(d)), d=<span class="string">'.'</span>; <span class="keyword">end</span>; f=[d <span class="string">'/'</span> f <span class="string">'.bAnn'</span>]; <span class="comment">%#ok&lt;NASGU&gt;</span>
0125     save(<span class="string">'-v6'</span>,f,<span class="string">'bnds'</span>,<span class="string">'types'</span>,<span class="string">'names'</span>,<span class="string">'keys'</span>,<span class="string">'vers'</span>);
0126   <span class="keyword">end</span>
0127 
0128   <a name="_sub2" href="#_subfunctions" class="code">function load1( fName, cName )</a>
0129     [d,f,ext] = fileparts(fName); <span class="keyword">if</span>(nargin&lt;2), cName=[]; <span class="keyword">end</span>
0130     <span class="keyword">if</span>(strcmp(ext,<span class="string">'.txt'</span>)), <a href="#_sub5" class="code" title="subfunction loadTxt( fName, cName )">loadTxt</a>(fName,cName); <span class="keyword">return</span>; <span class="keyword">end</span>
0131     vers=.5; <span class="keyword">if</span>(isempty(d)), d=<span class="string">'.'</span>; <span class="keyword">end</span>; f=[d <span class="string">'/'</span> f <span class="string">'.bAnn'</span>];
0132     L=load( <span class="string">'-mat'</span>, f );
0133     <span class="comment">% backward compatibilty w vers=.4</span>
0134     <span class="keyword">if</span>(isfield(L,<span class="string">'vers'</span>) &amp;&amp; L.vers==.4)
0135       L.bnds=L.bndss; L.types=L.typess; L.vers=.5;
0136     <span class="keyword">end</span>
0137     <span class="comment">% check if valid annotation file / correct version</span>
0138     <span class="keyword">if</span>( ~isfield(L,<span class="string">'vers'</span>) || L.vers~=vers || ~isfield(L,<span class="string">'bnds'</span>) );
0139       error(<span class="string">'Not a valid video annotation file or incorrect version.'</span>);
0140     <span class="keyword">end</span>;
0141     <span class="comment">% retrieve variables</span>
0142     bnds=L.bnds; types=L.types; names=L.names; keys=L.keys; s=1;
0143   <span class="keyword">end</span>
0144 
0145   <a name="_sub3" href="#_subfunctions" class="code">function merge( fName )</a>
0146     <span class="comment">% store current annotation data</span>
0147     bs0=bnds; ts0=types; ns0=names; ks0=keys; s0=s; k0=<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>; nFr0=<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>;
0148     <span class="comment">% append new anntation</span>
0149     <a href="#_sub2" class="code" title="subfunction load1( fName, cName )">load1</a>(fName); bnds=[bs0 bnds]; types=[ts0 types]; s=s0;
0150     <span class="comment">% confirm configs are same</span>
0151     <span class="keyword">if</span>( nFr0~=<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a> ), error(<span class="string">'Mismatched frame length.'</span>); <span class="keyword">end</span>
0152     <span class="keyword">if</span>( <a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>~=k0 || ~strcmp(keys,ks0) || ~all(strcmp(names,ns0)) )
0153       error([<span class="string">'Mismatched config files: '</span> fName]);
0154     <span class="keyword">end</span>
0155   <span class="keyword">end</span>
0156 
0157   <a name="_sub4" href="#_subfunctions" class="code">function saveTxt( fName )</a>
0158     <span class="comment">% begin exporting</span>
0159     f=fopen(fName,<span class="string">'wt'</span>); fp=@(varargin) fprintf(f,varargin{:});
0160     fp(<span class="string">'Caltech Behavior Annotator - Annotation File\n\n'</span>);
0161     <span class="comment">% output configuration info</span>
0162     fp(<span class="string">'Configuration file:\n'</span>);
0163     <span class="keyword">for</span> i=1:<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>, fp(<span class="string">'%s %s\n'</span>,names{i},keys(i)); <span class="keyword">end</span>
0164     <span class="comment">% behavior output</span>
0165     s0=s; str=<span class="string">'%8i  %6i    %s\n'</span>;
0166     <span class="keyword">for</span> s1=1:<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>, s=s1;
0167       fp(<span class="string">'\nS%i: start    end     type\n'</span>,s1);
0168       fp(<span class="string">'-----------------------------\n'</span>);
0169       <span class="keyword">for</span> i=1:<a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>, fp(str,<a href="#_sub18" class="code" title="subfunction frame = getStart( id ), frame=bnds{s}(id); end">getStart</a>(i)+1,<a href="#_sub19" class="code" title="subfunction frame = getEnd( id ), frame=bnds{s}(id+1)-1; end">getEnd</a>(i)+1,<a href="#_sub17" class="code" title="subfunction name = getName( id ), name=names{getType(id)}; end">getName</a>(i)); <span class="keyword">end</span>
0170     <span class="keyword">end</span>
0171     s=s0; fclose(f);
0172   <span class="keyword">end</span>
0173 
0174   <a name="_sub5" href="#_subfunctions" class="code">function loadTxt( fName, cName )</a>
0175     <span class="comment">% load annotation from text file created by saveTxt()</span>
0176     <span class="keyword">try</span>
0177       header=<span class="string">'Caltech Behavior Annotator - Annotation File'</span>;
0178       f=fopen(fName,<span class="string">'rt'</span>); s=fgetl(f); header=strcmp(s,header);
0179       <span class="keyword">if</span>(header==0), fseek(f,0,<span class="string">'bof'</span>); assert(~isempty(cName)); <span class="keyword">end</span>
0180       <span class="keyword">if</span>( header )
0181         <span class="comment">% read in rest of header and config file</span>
0182         s=fgetl(f); assert(isempty(s));
0183         s=fgetl(f); assert(strcmp(s,<span class="string">'Configuration file:'</span>));
0184         names=cell(1,1000); keys=char(zeros(1,1000)); <a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>=0;
0185         <span class="keyword">while</span>(1), s=fgetl(f); <span class="keyword">if</span>(~ischar(s) || isempty(s)), <span class="keyword">break</span>; <span class="keyword">end</span>
0186           t=textscan(s,<span class="string">'%s %1c'</span>,1); <a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>=<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>+1; names{<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>}=t{1}{1}; keys(<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>)=t{2};
0187         <span class="keyword">end</span>
0188         names=names(1:<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>); keys=keys(1:<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>);
0189       <span class="keyword">end</span>
0190       <span class="comment">% use names/keys from externally specified config file</span>
0191       <span class="keyword">if</span>(~isempty(cName)), <a href="#_sub6" class="code" title="subfunction create( varargin )">create</a>(cName,1); <span class="keyword">end</span>
0192       <span class="comment">% read in each stream in turn until end of file</span>
0193       bnds0=cell(1,10000); types0=cell(1,10000); nStrm1=0; s=fgetl(f);
0194       <span class="keyword">while</span>( 1 ), nStrm1=nStrm1+1;
0195         t=textscan(s,<span class="string">'S%d: start    end     type\n'</span>); assert(t{1}==nStrm1);
0196         s=fgetl(f); assert(strcmp(s,<span class="string">'-----------------------------'</span>));
0197         bnds1=zeros(1,10000); types1=zeros(1,10000); <a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>=1;
0198         <span class="keyword">while</span>(1), s=fgetl(f); <span class="keyword">if</span>(~ischar(s) || all(isspace(s))), <span class="keyword">break</span>; <span class="keyword">end</span>
0199           t=textscan(s,<span class="string">'%d %d %s'</span>,1); <a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>=<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>+1; type=find(strcmp(t{3},names));
0200           <span class="keyword">if</span>(isempty(type)), error(<span class="string">'undefined behavior %s'</span>,t{3}{1}); <span class="keyword">end</span>
0201           <span class="keyword">if</span>(bnds1(<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>-1)~=t{1}-1), error(<span class="string">'%i~=%i'</span>,bnds1(<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>-1),t{1}-1); <span class="keyword">end</span>
0202           bnds1(<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>)=t{2}; types1(<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>)=type;
0203         <span class="keyword">end</span>
0204         <span class="keyword">if</span>(nStrm1==1), nFrame1=bnds1(<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>); <span class="keyword">end</span>; assert(nFrame1==bnds1(<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>));
0205         bnds0{nStrm1}=bnds1(1:<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>); types0{nStrm1}=types1(2:<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>);
0206         <span class="keyword">while</span>(all(isspace(s))), s=fgetl(f); <span class="keyword">end</span>; <span class="keyword">if</span>(s==-1), <span class="keyword">break</span>; <span class="keyword">end</span>
0207       <span class="keyword">end</span>
0208       <span class="comment">% create annotation</span>
0209       <a href="#_sub6" class="code" title="subfunction create( varargin )">create</a>( nFrame1, nStrm1, names, keys );
0210       bnds=bnds0(1:<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>); types=types0(1:<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>);
0211       <span class="keyword">for</span> s1=nStrm1:-1:1, setStrm(s1); <a href="#_sub31" class="code" title="subfunction condense()">condense</a>(); <span class="keyword">end</span>; fclose(f);
0212     <span class="keyword">catch</span> e, fclose(f); throw(e);
0213     <span class="keyword">end</span>
0214   <span class="keyword">end</span>
0215 
0216   <a name="_sub6" href="#_subfunctions" class="code">function create( varargin )</a>
0217     <span class="comment">% create new annotation (load or use passed in config)</span>
0218     <span class="keyword">if</span>( nargin==2 )
0219       [cName,nFrame1]=deal(varargin{:});
0220       f=fopen(cName,<span class="string">'rt'</span>); t1=textscan(f,<span class="string">'nStream %d'</span>);
0221       t2=textscan(f,<span class="string">'%s %1c'</span>); fclose(f);
0222       nStrm1=t1{1}; names=t2{1}; keys=t2{2};
0223     <span class="keyword">elseif</span>( nargin==4 )
0224       [nFrame1,nStrm1,names,keys]=deal(varargin{:});
0225     <span class="keyword">else</span> assert(false);
0226     <span class="keyword">end</span>
0227     <span class="comment">% error check configuration</span>
0228     k1=length(keys); m=[];
0229     <span class="keyword">if</span>(length(names)~=k1), m=<span class="string">'Name/key mismatch.'</span>; <span class="keyword">end</span>
0230     <span class="keyword">if</span>(~all(keys+0&gt;=48)), m=<span class="string">'Bad key bindings.'</span>; <span class="keyword">end</span>
0231     <span class="keyword">if</span>(length(unique(keys))~=k1), m=<span class="string">'Multiply defined keys.'</span>; <span class="keyword">end</span>
0232     <span class="keyword">if</span>(length(unique(names))~=k1), m=<span class="string">'Multiply defined names.'</span>; <span class="keyword">end</span>
0233     <span class="keyword">if</span>(~isempty(m)), error([<span class="string">'Invalid config file ('</span> cName <span class="string">'): '</span> m]); <span class="keyword">end</span>
0234     <span class="comment">% initialize data structure</span>
0235     bnds=cell(1,nStrm1); types=cell(1,nStrm1); s=1;
0236     <span class="keyword">for</span> s1=1:nStrm1, bnds{s1}=[0 nFrame1]; <span class="keyword">end</span>
0237     <span class="keyword">for</span> s1=1:nStrm1, types{s1}=1; <span class="keyword">end</span>
0238   <span class="keyword">end</span>
0239 
0240   <a name="_sub7" href="#_subfunctions" class="code">function recreate( cName )</a>
0241     <span class="comment">% store current annotation data (except keys and s)</span>
0242     bs0=bnds; ts0=types; ns0=names; k0=<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>(); nStrm0=<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>();
0243     <span class="comment">% create brand new annotation data, copy over old</span>
0244     <a href="#_sub6" class="code" title="subfunction create( varargin )">create</a>(cName,<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>()); mins=min(nStrm0,<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>());
0245     bnds(1:mins)=bs0(1:mins); types(1:mins)=ts0(1:mins);
0246     <span class="comment">% remap types to match new names list (deleted names default to type 1)</span>
0247     map=ones(1,k0);
0248     <span class="keyword">for</span> i=1:k0, m=find(strcmp(ns0{i},names)); <span class="keyword">if</span>(m), map(i)=m; <span class="keyword">end</span>; <span class="keyword">end</span>
0249     <span class="keyword">for</span> i=1:mins, s=i; types{s}=map(types{s}); <a href="#_sub31" class="code" title="subfunction condense()">condense</a>(); <span class="keyword">end</span>; s=1;
0250   <span class="keyword">end</span>
0251 
0252 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0253 
0254   <a name="_sub8" href="#_subfunctions" class="code">function n1 = n(), n1=length(types{s}); end</a>
0255 
0256   <a name="_sub9" href="#_subfunctions" class="code">function k1 = k(), k1=length(names); end</a>
0257 
0258   <a name="_sub10" href="#_subfunctions" class="code">function nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end</a>
0259 
0260   <a name="_sub11" href="#_subfunctions" class="code">function nStrm1 = nStrm(), nStrm1=length(bnds); end</a>
0261 
0262   <a name="_sub12" href="#_subfunctions" class="code">function types1 = getTypes(), types1=types{s}; end</a>
0263 
0264   <a name="_sub13" href="#_subfunctions" class="code">function bnds1 = getBnds(), bnds1=bnds{s}; end</a>
0265 
0266   <a name="_sub14" href="#_subfunctions" class="code">function names1 = getNames(), names1=names; end</a>
0267 
0268   <a name="_sub15" href="#_subfunctions" class="code">function keys1 = getKeys(), keys1=keys; end</a>
0269 
0270   <a name="_sub16" href="#_subfunctions" class="code">function type = getType( id ), type=types{s}(id); end</a>
0271 
0272   <a name="_sub17" href="#_subfunctions" class="code">function name = getName( id ), name=names{getType(id)}; end</a>
0273 
0274   <a name="_sub18" href="#_subfunctions" class="code">function frame = getStart( id ), frame=bnds{s}(id); end</a>
0275 
0276   <a name="_sub19" href="#_subfunctions" class="code">function frame = getEnd( id ), frame=bnds{s}(id+1)-1; end</a>
0277 
0278   <a name="_sub20" href="#_subfunctions" class="code">function id = getId( frame ), [~,id]=min(bnds{s}&lt;=frame); id=id-1; end</a>
0279 
0280   <a name="_sub21" href="#_subfunctions" class="code">function ids = getIds( type ), ids=find(types{s}==type); end</a>
0281 
0282   <a name="_sub22" href="#_subfunctions" class="code">function lbl = getLbls()</a>
0283     lbl=zeros(1,<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>);
0284     <span class="keyword">for</span> i=1:<a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>, lbl(bnds{s}(i)+1:bnds{s}(i+1))=types{s}(i); <span class="keyword">end</span>
0285   <span class="keyword">end</span>
0286 
0287 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0288 
0289   <a name="_sub23" href="#_subfunctions" class="code">function setStrm( s1 ), assert(s1&gt;0 &amp;&amp; s1&lt;=nStrm); s=s1; end</a>
0290 
0291   <a name="_sub24" href="#_subfunctions" class="code">function setType( id, type )</a>
0292     assert(type&gt;0 &amp;&amp; type&lt;=<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>);
0293     types{s}(id)=type; <a href="#_sub31" class="code" title="subfunction condense()">condense</a>();
0294   <span class="keyword">end</span>
0295 
0296   <a name="_sub25" href="#_subfunctions" class="code">function move( id, frame )</a>
0297     assert(id&gt;=1 &amp;&amp; id&lt;=<a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>); <span class="keyword">if</span>(id==1), <span class="keyword">return</span>; <span class="keyword">end</span>
0298     assert(frame&gt;bnds{s}(id-1) &amp;&amp; frame&lt;bnds{s}(id+1));
0299     bnds{s}(id)=frame;
0300   <span class="keyword">end</span>
0301 
0302   <a name="_sub26" href="#_subfunctions" class="code">function add( type, frame )</a>
0303     id=<a href="#_sub20" class="code" title="subfunction id = getId( frame ), [~,id]=min(bnds{s}<=frame); id=id-1; end">getId</a>(frame);
0304     <span class="keyword">if</span>(frame==bnds{s}(id)), <a href="#_sub24" class="code" title="subfunction setType( id, type )">setType</a>(id,type); <span class="keyword">else</span>
0305       bnds{s} = [bnds{s}(1:id) frame bnds{s}(id+1:end)];
0306       types{s} = [types{s}(1:id) type types{s}(id+1:end)];
0307       <a href="#_sub31" class="code" title="subfunction condense()">condense</a>();
0308     <span class="keyword">end</span>
0309   <span class="keyword">end</span>
0310 
0311   <a name="_sub27" href="#_subfunctions" class="code">function delete( id )</a>
0312     assert(all(id&gt;=1 &amp; id&lt;=<a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>)); <span class="keyword">if</span>(<a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>==1), <span class="keyword">return</span>; <span class="keyword">end</span>
0313     kp = setdiff(1:<a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>,id); assert(~isempty(kp));
0314     bnds{s} = bnds{s}([kp <a href="#_sub8" class="code" title="subfunction n1 = n(), n1=length(types{s}); end">n</a>+1]); bnds{s}(1)=0;
0315     types{s} = types{s}(kp); <a href="#_sub31" class="code" title="subfunction condense()">condense</a>();
0316   <span class="keyword">end</span>
0317 
0318   <a name="_sub28" href="#_subfunctions" class="code">function crop( fr0, fr1 )</a>
0319     assert(fr0&gt;=0 &amp;&amp; fr1&lt;<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>()); sOrig=s;
0320     <span class="keyword">for</span> s1=1:<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>, s=s1;
0321       id=<a href="#_sub20" class="code" title="subfunction id = getId( frame ), [~,id]=min(bnds{s}<=frame); id=id-1; end">getId</a>(fr0); types{s}(1:id-1)=<a href="#_sub16" class="code" title="subfunction type = getType( id ), type=types{s}(id); end">getType</a>(id);
0322       id=<a href="#_sub20" class="code" title="subfunction id = getId( frame ), [~,id]=min(bnds{s}<=frame); id=id-1; end">getId</a>(fr1); types{s}(id+1:end)=<a href="#_sub16" class="code" title="subfunction type = getType( id ), type=types{s}(id); end">getType</a>(id);
0323       <a href="#_sub31" class="code" title="subfunction condense()">condense</a>(); bnds{s}=bnds{s}-fr0;
0324       bnds{s}(1)=0; bnds{s}(end)=fr1-fr0+1;
0325     <span class="keyword">end</span>; s=sOrig;
0326   <span class="keyword">end</span>
0327 
0328   <a name="_sub29" href="#_subfunctions" class="code">function insert( frs )</a>
0329     assert(all(frs&gt;=0 &amp; frs&lt;<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>())); sOrig=s; frs0=sort(frs);
0330     <span class="keyword">for</span> s1=1:<a href="#_sub11" class="code" title="subfunction nStrm1 = nStrm(), nStrm1=length(bnds); end">nStrm</a>, s=s1; frs=frs0;
0331       <span class="keyword">for</span> f=1:length(frs)
0332         id=<a href="#_sub20" class="code" title="subfunction id = getId( frame ), [~,id]=min(bnds{s}<=frame); id=id-1; end">getId</a>(frs(f)); frs=frs+1;
0333         bnds{s}(id+1:end)=bnds{s}(id+1:end)+1;
0334       <span class="keyword">end</span>
0335     <span class="keyword">end</span>; s=sOrig;
0336   <span class="keyword">end</span>
0337 
0338   <a name="_sub30" href="#_subfunctions" class="code">function setLbls( lbl )</a>
0339     assert(min(lbl)&gt;=1 &amp;&amp; max(lbl)&lt;=<a href="#_sub9" class="code" title="subfunction k1 = k(), k1=length(names); end">k</a>() &amp;&amp; length(lbl)==<a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>);
0340     ids=find(lbl(1:end-1)~=lbl(2:end));
0341     bnds{s}=[0 ids <a href="#_sub10" class="code" title="subfunction nFrame1 = nFrame(), nFrame1=bnds{s}(n+1); end">nFrame</a>]; types{s}=lbl([0 ids]+1);
0342   <span class="keyword">end</span>
0343 
0344   <a name="_sub31" href="#_subfunctions" class="code">function condense()</a>
0345     <span class="comment">% internal cleanup: merge consecutive behaviors of same type</span>
0346     ids = find(types{s}(1:end-1)==types{s}(2:end));
0347     <span class="keyword">if</span>(~isempty(ids)), <a href="#_sub27" class="code" title="subfunction delete( id )">delete</a>(ids+1); <span class="keyword">end</span>
0348   <span class="keyword">end</span>
0349 
0350 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 05-May-2022 14:52:24 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>