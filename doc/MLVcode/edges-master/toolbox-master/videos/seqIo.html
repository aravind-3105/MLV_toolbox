<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of seqIo</title>
  <meta name="keywords" content="seqIo">
  <meta name="description" content="Utilities for reading and writing seq files.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">MLVcode</a> &gt; <a href="../../index.html">edges-master</a> &gt; <a href="#">toolbox-master</a> &gt; <a href="index.html">videos</a> &gt; seqIo.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for MLVcode\edges-master\toolbox-master\videos&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>seqIo
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Utilities for reading and writing seq files.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function out = seqIo( fName, action, varargin ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Utilities for reading and writing seq files.

 A seq file is a series of concatentated image frames with a fixed size
 header. It is essentially the same as merging a directory of images into
 a single file. seq files are convenient for storing videos because: (1)
 no video codec is required, (2) seek is instant and exact, (3) seq files
 can be read on any operating system. The main drawback is that each frame
 is encoded independently, resulting in increased file size. The advantage
 over storing as a directory of images is that a single large file is
 created. Currently, either uncompressed, jpg or png compressed frames
 are supported. The seq file format is modeled after the Norpix seq format
 (in fact this reader can be used to read some Norpix seq files). The
 actual work of reading/writing seq files is done by seqReaderPlugin and
 seqWriterPlugin (there is no need to call those functions directly).

 seqIo contains a number of utility functions for working with seq files.
 The format for accessing the various utility functions is:
  out = seqIo( fName, 'action', inputs );
 The list of functions and help for each is given below. Also, help on
 individual subfunctions can be accessed by: &quot;help seqIo&gt;action&quot;.

 Create interface sr for reading seq files.
   sr = seqIo( fName, 'reader', [cache] )
 Create interface sw for writing seq files.
   sw = seqIo( fName, 'writer', info )
 Get info about seq file.
   info = seqIo( fName, 'getInfo' )
 Crop sub-sequence from seq file.
   seqIo( fName, 'crop', tName, frames )
 Extract images from seq file to target directory or array.
   Is = seqIo( fName, 'toImgs', [tDir], [skip], [f0], [f1], [ext] )
 Create seq file from an array or directory of images or from an AVI file.
   seqIo( fName, 'frImgs', info, varargin )
 Convert seq file by applying imgFun(I) to each frame I.
   seqIo( fName, 'convert', tName, imgFun, varargin )
 Replace header of seq file with provided info.
   seqIo( fName, 'newHeader', info )
 Create interface sr for reading dual seq files.
   sr = seqIo( fNames, 'readerDual', [cache] )

 USAGE
  out = seqIo( fName, action, varargin )

 INPUTS
  fName      - seq file to open
  action     - controls action (see above)
  varargin   - additional inputs (see above)

 OUTPUTS
  out       - depends on action (see above)

 EXAMPLE

 See also seqIo&gt;reader, seqIo&gt;writer, seqIo&gt;getInfo, seqIo&gt;crop,
 seqIo&gt;toImgs, seqIo&gt;frImgs, seqIo&gt;convert, seqIo&gt;newHeader,
 seqIo&gt;readerDual, <a href="seqPlayer.html" class="code" title="function seqPlayer( fName, dispFunc )">seqPlayer</a>, <a href="seqReaderPlugin.html" class="code" title="function varargout = seqReaderPlugin( cmd, h, varargin )">seqReaderPlugin</a>, <a href="seqWriterPlugin.html" class="code" title="function varargout = seqWriterPlugin( cmd, h, varargin )">seqWriterPlugin</a>

 Piotr's Computer Vision Matlab Toolbox      Version 2.61
 Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]
 Licensed under the Simplified BSD License [see external/bsd.txt]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="seqReaderPlugin.html" class="code" title="function varargout = seqReaderPlugin( cmd, h, varargin )">seqReaderPlugin</a>	Plugin for seqIo and videoIO to allow reading of seq files.</li><li><a href="seqWriterPlugin.html" class="code" title="function varargout = seqWriterPlugin( cmd, h, varargin )">seqWriterPlugin</a>	Plugin for seqIo and videoIO to allow writing of seq files.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="behaviorAnnotator.html" class="code" title="function behaviorAnnotator( fName, aName, tName )">behaviorAnnotator</a>	Caltech Behavior Annotator.</li><li><a href="seqPlayer.html" class="code" title="function seqPlayer( fName, dispFunc )">seqPlayer</a>	Simple GUI to play seq files.</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function sr = reader( fName, cache )</a></li><li><a href="#_sub2" class="code">function [I,t] = getframe()</a></li><li><a href="#_sub3" class="code">function sw = writer( fName, info )</a></li><li><a href="#_sub4" class="code">function info = getInfo( fName )</a></li><li><a href="#_sub5" class="code">function crop( fName, tName, frames )</a></li><li><a href="#_sub6" class="code">function Is = toImgs( fName, tDir, skip, f0, f1, ext )</a></li><li><a href="#_sub7" class="code">function frImgs( fName, info, varargin )</a></li><li><a href="#_sub8" class="code">function convert( fName, tName, imgFun, varargin )</a></li><li><a href="#_sub9" class="code">function newHeader( fName, info )</a></li><li><a href="#_sub10" class="code">function sr = readerDual( fNames, cache )</a></li><li><a href="#_sub11" class="code">function [I,t] = getframe()</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function out = seqIo( fName, action, varargin )</a>
0002 <span class="comment">% Utilities for reading and writing seq files.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% A seq file is a series of concatentated image frames with a fixed size</span>
0005 <span class="comment">% header. It is essentially the same as merging a directory of images into</span>
0006 <span class="comment">% a single file. seq files are convenient for storing videos because: (1)</span>
0007 <span class="comment">% no video codec is required, (2) seek is instant and exact, (3) seq files</span>
0008 <span class="comment">% can be read on any operating system. The main drawback is that each frame</span>
0009 <span class="comment">% is encoded independently, resulting in increased file size. The advantage</span>
0010 <span class="comment">% over storing as a directory of images is that a single large file is</span>
0011 <span class="comment">% created. Currently, either uncompressed, jpg or png compressed frames</span>
0012 <span class="comment">% are supported. The seq file format is modeled after the Norpix seq format</span>
0013 <span class="comment">% (in fact this reader can be used to read some Norpix seq files). The</span>
0014 <span class="comment">% actual work of reading/writing seq files is done by seqReaderPlugin and</span>
0015 <span class="comment">% seqWriterPlugin (there is no need to call those functions directly).</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% seqIo contains a number of utility functions for working with seq files.</span>
0018 <span class="comment">% The format for accessing the various utility functions is:</span>
0019 <span class="comment">%  out = seqIo( fName, 'action', inputs );</span>
0020 <span class="comment">% The list of functions and help for each is given below. Also, help on</span>
0021 <span class="comment">% individual subfunctions can be accessed by: &quot;help seqIo&gt;action&quot;.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Create interface sr for reading seq files.</span>
0024 <span class="comment">%   sr = seqIo( fName, 'reader', [cache] )</span>
0025 <span class="comment">% Create interface sw for writing seq files.</span>
0026 <span class="comment">%   sw = seqIo( fName, 'writer', info )</span>
0027 <span class="comment">% Get info about seq file.</span>
0028 <span class="comment">%   info = seqIo( fName, 'getInfo' )</span>
0029 <span class="comment">% Crop sub-sequence from seq file.</span>
0030 <span class="comment">%   seqIo( fName, 'crop', tName, frames )</span>
0031 <span class="comment">% Extract images from seq file to target directory or array.</span>
0032 <span class="comment">%   Is = seqIo( fName, 'toImgs', [tDir], [skip], [f0], [f1], [ext] )</span>
0033 <span class="comment">% Create seq file from an array or directory of images or from an AVI file.</span>
0034 <span class="comment">%   seqIo( fName, 'frImgs', info, varargin )</span>
0035 <span class="comment">% Convert seq file by applying imgFun(I) to each frame I.</span>
0036 <span class="comment">%   seqIo( fName, 'convert', tName, imgFun, varargin )</span>
0037 <span class="comment">% Replace header of seq file with provided info.</span>
0038 <span class="comment">%   seqIo( fName, 'newHeader', info )</span>
0039 <span class="comment">% Create interface sr for reading dual seq files.</span>
0040 <span class="comment">%   sr = seqIo( fNames, 'readerDual', [cache] )</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% USAGE</span>
0043 <span class="comment">%  out = seqIo( fName, action, varargin )</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% INPUTS</span>
0046 <span class="comment">%  fName      - seq file to open</span>
0047 <span class="comment">%  action     - controls action (see above)</span>
0048 <span class="comment">%  varargin   - additional inputs (see above)</span>
0049 <span class="comment">%</span>
0050 <span class="comment">% OUTPUTS</span>
0051 <span class="comment">%  out       - depends on action (see above)</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% EXAMPLE</span>
0054 <span class="comment">%</span>
0055 <span class="comment">% See also seqIo&gt;reader, seqIo&gt;writer, seqIo&gt;getInfo, seqIo&gt;crop,</span>
0056 <span class="comment">% seqIo&gt;toImgs, seqIo&gt;frImgs, seqIo&gt;convert, seqIo&gt;newHeader,</span>
0057 <span class="comment">% seqIo&gt;readerDual, seqPlayer, seqReaderPlugin, seqWriterPlugin</span>
0058 <span class="comment">%</span>
0059 <span class="comment">% Piotr's Computer Vision Matlab Toolbox      Version 2.61</span>
0060 <span class="comment">% Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]</span>
0061 <span class="comment">% Licensed under the Simplified BSD License [see external/bsd.txt]</span>
0062 
0063 <span class="keyword">switch</span> lower(action)
0064   <span class="keyword">case</span> {<span class="string">'reader'</span>,<span class="string">'r'</span>}, out = <a href="#_sub1" class="code" title="subfunction sr = reader( fName, cache )">reader</a>( fName, varargin{:} );
0065   <span class="keyword">case</span> {<span class="string">'writer'</span>,<span class="string">'w'</span>}, out = <a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>( fName, varargin{:} );
0066   <span class="keyword">case</span> <span class="string">'getinfo'</span>, out = <a href="#_sub4" class="code" title="subfunction info = getInfo( fName )">getInfo</a>( fName );
0067   <span class="keyword">case</span> <span class="string">'crop'</span>, <a href="#_sub5" class="code" title="subfunction crop( fName, tName, frames )">crop</a>( fName, varargin{:} ); out=1;
0068   <span class="keyword">case</span> <span class="string">'toimgs'</span>, out = <a href="#_sub6" class="code" title="subfunction Is = toImgs( fName, tDir, skip, f0, f1, ext )">toImgs</a>( fName, varargin{:} );
0069   <span class="keyword">case</span> <span class="string">'frimgs'</span>, <a href="#_sub7" class="code" title="subfunction frImgs( fName, info, varargin )">frImgs</a>( fName, varargin{:} ); out=1;
0070   <span class="keyword">case</span> <span class="string">'convert'</span>, <a href="#_sub8" class="code" title="subfunction convert( fName, tName, imgFun, varargin )">convert</a>( fName, varargin{:} ); out=1;
0071   <span class="keyword">case</span> <span class="string">'newheader'</span>, <a href="#_sub9" class="code" title="subfunction newHeader( fName, info )">newHeader</a>( fName, varargin{:} ); out=1;
0072   <span class="keyword">case</span> {<span class="string">'readerdual'</span>,<span class="string">'rdual'</span>}, out=<a href="#_sub10" class="code" title="subfunction sr = readerDual( fNames, cache )">readerDual</a>(fName,varargin{:});
0073   <span class="keyword">otherwise</span>, error(<span class="string">'seqIo unknown action: ''%s'''</span>,action);
0074 <span class="keyword">end</span>
0075 <span class="keyword">end</span>
0076 
0077 <a name="_sub1" href="#_subfunctions" class="code">function sr = reader( fName, cache )</a>
0078 <span class="comment">% Create interface sr for reading seq files.</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% Create interface sr to seq file with the following commands:</span>
0081 <span class="comment">%  sr.close();            % Close seq file (sr is useless after).</span>
0082 <span class="comment">%  [I,ts]=sr.getframe();  % Get current frame (returns [] if invalid).</span>
0083 <span class="comment">%  [I,ts]=sr.getframeb(); % Get current frame with no decoding.</span>
0084 <span class="comment">%  ts = sr.getts();       % Return timestamps for all frames.</span>
0085 <span class="comment">%  info = sr.getinfo();   % Return struct with info about video.</span>
0086 <span class="comment">%  [I,ts]=sr.getnext();   % Shortcut for next() followed by getframe().</span>
0087 <span class="comment">%  out = sr.next();       % Go to next frame (out=0 on fail).</span>
0088 <span class="comment">%  out = sr.seek(frame);  % Go to specified frame (out=0 on fail).</span>
0089 <span class="comment">%  out = sr.step(delta);  % Go to current frame+delta (out=0 on fail).</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% If cache&gt;0, reader() will cache frames in memory, so that calls to</span>
0092 <span class="comment">% getframe() can avoid disk IO for cached frames (note that only frames</span>
0093 <span class="comment">% returned by getframe() are cached). This is useful if the same frames are</span>
0094 <span class="comment">% accessed repeatedly. When the cache is full, the frame in the cache</span>
0095 <span class="comment">% accessed least recently is discarded. Memory requirements are</span>
0096 <span class="comment">% proportional to cache size.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% USAGE</span>
0099 <span class="comment">%  sr = seqIo( fName, 'reader', [cache] )</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% INPUTS</span>
0102 <span class="comment">%  fName  - seq file name</span>
0103 <span class="comment">%  cache  - [0] size of cache</span>
0104 <span class="comment">%</span>
0105 <span class="comment">% OUTPUTS</span>
0106 <span class="comment">%  sr     - interface for reading seq file</span>
0107 <span class="comment">%</span>
0108 <span class="comment">% EXAMPLE</span>
0109 <span class="comment">%</span>
0110 <span class="comment">% See also seqIo, seqReaderPlugin</span>
0111 <span class="keyword">if</span>(nargin&lt;2 || isempty(cache)), cache=0; <span class="keyword">end</span>
0112 <span class="keyword">if</span>( cache&gt;0 ), [as, fs, Is, ts, inds]=deal([]); <span class="keyword">end</span>
0113 r=@<a href="seqReaderPlugin.html" class="code" title="function varargout = seqReaderPlugin( cmd, h, varargin )">seqReaderPlugin</a>; s=r(<span class="string">'open'</span>,int32(-1),fName);
0114 sr = struct( <span class="string">'close'</span>,@() r(<span class="string">'close'</span>,s), <span class="string">'getframe'</span>,@<a href="#_sub2  11" class="code" title="subfunction [I,t] = getframe()function [I,t] = getframe()">getframe</a>, <span class="keyword">...</span>
0115   <span class="string">'getframeb'</span>,@() r(<span class="string">'getframeb'</span>,s), <span class="string">'getts'</span>,@() r(<span class="string">'getts'</span>,s), <span class="keyword">...</span>
0116   <span class="string">'getinfo'</span>,@() r(<span class="string">'getinfo'</span>,s), <span class="string">'getnext'</span>,@() r(<span class="string">'getnext'</span>,s), <span class="keyword">...</span>
0117   <span class="string">'next'</span>,@() r(<span class="string">'next'</span>,s), <span class="string">'seek'</span>,@(f) r(<span class="string">'seek'</span>,s,f), <span class="keyword">...</span>
0118   <span class="string">'step'</span>,@(d) r(<span class="string">'step'</span>,s,d));
0119 
0120   <a name="_sub2" href="#_subfunctions" class="code">function [I,t] = getframe()</a>
0121     <span class="comment">% if not using cache simply call 'getframe' and done</span>
0122     <span class="keyword">if</span>(cache&lt;=0), [I,t]=r(<span class="string">'getframe'</span>,s); <span class="keyword">return</span>; <span class="keyword">end</span>
0123     <span class="comment">% if cache initialized and frame in cache perform lookup</span>
0124     f=r(<span class="string">'getinfo'</span>,s); f=f.curFrame; i=find(f==fs,1);
0125     <span class="keyword">if</span>(i), as=as+1; as(i)=0; t=ts(i); I=Is(inds{:},i); <span class="keyword">return</span>; <span class="keyword">end</span>
0126     <span class="comment">% if image not in cache add (and possibly initialize)</span>
0127     [I,t]=r(<span class="string">'getframe'</span>,s); <span class="keyword">if</span>(0), fprintf(<span class="string">'reading frame %i\n'</span>,f); <span class="keyword">end</span>
0128     <span class="keyword">if</span>(isempty(Is)), Is=zeros([size(I) cache],class(I));
0129       as=ones(1,cache); fs=-as; ts=as; inds=repmat({<span class="string">':'</span>},1,ndims(I)); <span class="keyword">end</span>
0130     [~,i]=max(as); as(i)=0; fs(i)=f; ts(i)=t; Is(inds{:},i)=I;
0131   <span class="keyword">end</span>
0132 <span class="keyword">end</span>
0133 
0134 <a name="_sub3" href="#_subfunctions" class="code">function sw = writer( fName, info )</a>
0135 <span class="comment">% Create interface sw for writing seq files.</span>
0136 <span class="comment">%</span>
0137 <span class="comment">% Create interface sw to seq file with the following commands:</span>
0138 <span class="comment">%  sw.close();              % Close seq file (sw is useless after).</span>
0139 <span class="comment">%  sw.addframe(I,[ts]);     % Writes video frame (and timestamp)</span>
0140 <span class="comment">%  sw.addframeb(bytes);     % Writes video frame with no encoding.</span>
0141 <span class="comment">%  info = sw.getinfo();     % Return struct with info about video.</span>
0142 <span class="comment">%</span>
0143 <span class="comment">% The following params must be specified in struct 'info' upon opening:</span>
0144 <span class="comment">%  width          - frame width</span>
0145 <span class="comment">%  height         - frame height</span>
0146 <span class="comment">%  fps            - frames per second</span>
0147 <span class="comment">%  quality        - [80] compression quality (0 to 100)</span>
0148 <span class="comment">%  codec          - string representing codec, options include:</span>
0149 <span class="comment">%   'monoraw'/'imageFormat100'      - black/white uncompressed</span>
0150 <span class="comment">%   'raw'/'imageFormat200'          - color (BGR) uncompressed</span>
0151 <span class="comment">%   'monojpg'/'imageFormat102'      - black/white jpg compressed</span>
0152 <span class="comment">%   'jpg'/'imageFormat201'          - color jpg compressed</span>
0153 <span class="comment">%   'monopng'/'imageFormat001'      - black/white png compressed</span>
0154 <span class="comment">%   'png'/'imageFormat002'          - color png compressed</span>
0155 <span class="comment">%</span>
0156 <span class="comment">% USAGE</span>
0157 <span class="comment">%  sw = seqIo( fName, 'writer', info )</span>
0158 <span class="comment">%</span>
0159 <span class="comment">% INPUTS</span>
0160 <span class="comment">%  fName  - seq file name</span>
0161 <span class="comment">%  info   - see above</span>
0162 <span class="comment">%</span>
0163 <span class="comment">% OUTPUTS</span>
0164 <span class="comment">%  sw     - interface for writing seq file</span>
0165 <span class="comment">%</span>
0166 <span class="comment">% EXAMPLE</span>
0167 <span class="comment">%</span>
0168 <span class="comment">% See also seqIo, seqWriterPlugin</span>
0169 w=@<a href="seqWriterPlugin.html" class="code" title="function varargout = seqWriterPlugin( cmd, h, varargin )">seqWriterPlugin</a>; s=w(<span class="string">'open'</span>,int32(-1),fName,info);
0170 sw = struct( <span class="string">'close'</span>,@() w(<span class="string">'close'</span>,s), <span class="string">'getinfo'</span>,@() w(<span class="string">'getinfo'</span>,s), <span class="keyword">...</span>
0171   <span class="string">'addframe'</span>,@(varargin) w(<span class="string">'addframe'</span>,s,varargin{:}), <span class="keyword">...</span>
0172   <span class="string">'addframeb'</span>,@(varargin) w(<span class="string">'addframeb'</span>,s,varargin{:}) );
0173 <span class="keyword">end</span>
0174 
0175 <a name="_sub4" href="#_subfunctions" class="code">function info = getInfo( fName )</a>
0176 <span class="comment">% Get info about seq file.</span>
0177 <span class="comment">%</span>
0178 <span class="comment">% USAGE</span>
0179 <span class="comment">%  info = seqIo( fName, 'getInfo' )</span>
0180 <span class="comment">%</span>
0181 <span class="comment">% INPUTS</span>
0182 <span class="comment">%  fName  - seq file name</span>
0183 <span class="comment">%</span>
0184 <span class="comment">% OUTPUTS</span>
0185 <span class="comment">%  info   - information struct</span>
0186 <span class="comment">%</span>
0187 <span class="comment">% EXAMPLE</span>
0188 <span class="comment">%</span>
0189 <span class="comment">% See also seqIo</span>
0190 sr=<a href="#_sub1" class="code" title="subfunction sr = reader( fName, cache )">reader</a>(fName); info=sr.getinfo(); sr.close();
0191 <span class="keyword">end</span>
0192 
0193 <a name="_sub5" href="#_subfunctions" class="code">function crop( fName, tName, frames )</a>
0194 <span class="comment">% Crop sub-sequence from seq file.</span>
0195 <span class="comment">%</span>
0196 <span class="comment">% Frame indices are 0 indexed. frames need not be consecutive and can</span>
0197 <span class="comment">% contain duplicates. An index of -1 indicates a blank (all 0) frame. If</span>
0198 <span class="comment">% contiguous subset of frames is cropped timestamps are preserved.</span>
0199 <span class="comment">%</span>
0200 <span class="comment">% USAGE</span>
0201 <span class="comment">%  seqIo( fName, 'crop', tName, frames )</span>
0202 <span class="comment">%</span>
0203 <span class="comment">% INPUTS</span>
0204 <span class="comment">%  fName      - seq file name</span>
0205 <span class="comment">%  tName      - cropped seq file name</span>
0206 <span class="comment">%  frames     - frame indices (0 indexed)</span>
0207 <span class="comment">%</span>
0208 <span class="comment">% OUTPUTS</span>
0209 <span class="comment">%</span>
0210 <span class="comment">% EXAMPLE</span>
0211 <span class="comment">%</span>
0212 <span class="comment">% See also seqIo</span>
0213 sr=<a href="#_sub1" class="code" title="subfunction sr = reader( fName, cache )">reader</a>(fName); info=sr.getinfo(); sw=<a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>(tName,info);
0214 frames=frames(:)'; pad=sr.getnext(); pad(:)=0;
0215 kp=frames&gt;=0 &amp; frames&lt;info.numFrames; <span class="keyword">if</span>(~all(kp)), frames=frames(kp);
0216   warning(<span class="string">'piotr:seqIo:crop'</span>,<span class="string">'%i out of bounds frames'</span>,sum(~kp)); <span class="keyword">end</span>
0217 ordered=all(frames(2:end)==frames(1:end-1)+1);
0218 n=length(frames); k=0; tid=ticStatus;
0219 <span class="keyword">for</span> f=frames
0220   <span class="keyword">if</span>(f&lt;0), sw.addframe(pad); <span class="keyword">continue</span>; <span class="keyword">end</span>
0221   sr.seek(f); [I,ts]=sr.getframeb(); k=k+1; tocStatus(tid,k/n);
0222   <span class="keyword">if</span>(ordered), sw.addframeb(I,ts); <span class="keyword">else</span> sw.addframeb(I); <span class="keyword">end</span>
0223 <span class="keyword">end</span>; sw.close(); sr.close();
0224 <span class="keyword">end</span>
0225 
0226 <a name="_sub6" href="#_subfunctions" class="code">function Is = toImgs( fName, tDir, skip, f0, f1, ext )</a>
0227 <span class="comment">% Extract images from seq file to target directory or array.</span>
0228 <span class="comment">%</span>
0229 <span class="comment">% USAGE</span>
0230 <span class="comment">%  Is = seqIo( fName, 'toImgs', [tDir], [skip], [f0], [f1], [ext] )</span>
0231 <span class="comment">%</span>
0232 <span class="comment">% INPUTS</span>
0233 <span class="comment">%  fName      - seq file name</span>
0234 <span class="comment">%  tDir       - [] target directory (if empty extract images to array)</span>
0235 <span class="comment">%  skip       - [1] skip between written frames</span>
0236 <span class="comment">%  f0         - [0] first frame to write</span>
0237 <span class="comment">%  f1         - [numFrames-1] last frame to write</span>
0238 <span class="comment">%  ext        - [] optionally save as given type (slow, reconverts)</span>
0239 <span class="comment">%</span>
0240 <span class="comment">% OUTPUTS</span>
0241 <span class="comment">%  Is         - if isempty(tDir) outputs image array (else Is=[])</span>
0242 <span class="comment">%</span>
0243 <span class="comment">% EXAMPLE</span>
0244 <span class="comment">%</span>
0245 <span class="comment">% See also seqIo</span>
0246 <span class="keyword">if</span>(nargin&lt;2 || isempty(tDir)), tDir=[]; <span class="keyword">end</span>
0247 <span class="keyword">if</span>(nargin&lt;3 || isempty(skip)), skip=1; <span class="keyword">end</span>
0248 <span class="keyword">if</span>(nargin&lt;4 || isempty(f0)), f0=0; <span class="keyword">end</span>
0249 <span class="keyword">if</span>(nargin&lt;5 || isempty(f1)), f1=inf; <span class="keyword">end</span>
0250 <span class="keyword">if</span>(nargin&lt;6 || isempty(ext)), ext=<span class="string">''</span>; <span class="keyword">end</span>
0251 sr=<a href="#_sub1" class="code" title="subfunction sr = reader( fName, cache )">reader</a>(fName); info=sr.getinfo(); f1=min(f1,info.numFrames-1);
0252 frames=f0:skip:f1; n=length(frames); tid=ticStatus; k=0;
0253 <span class="comment">% output images to array</span>
0254 <span class="keyword">if</span>(isempty(tDir))
0255   I=sr.getnext(); d=ndims(I); assert(d==2 || d==3);
0256   <span class="keyword">try</span> Is=zeros([size(I) n],class(I)); <span class="keyword">catch</span> e; sr.close(); throw(e); <span class="keyword">end</span>
0257   <span class="keyword">for</span> k=1:n, sr.seek(frames(k)); I=sr.getframe(); tocStatus(tid,k/n);
0258     <span class="keyword">if</span>(d==2), Is(:,:,k)=I; <span class="keyword">else</span> Is(:,:,:,k)=I; <span class="keyword">end</span>; <span class="keyword">end</span>
0259   sr.close(); <span class="keyword">return</span>;
0260 <span class="keyword">end</span>
0261 <span class="comment">% output images to directory</span>
0262 <span class="keyword">if</span>(~exist(tDir,<span class="string">'dir'</span>)), mkdir(tDir); <span class="keyword">end</span>; Is=[];
0263 <span class="keyword">for</span> frame=frames
0264   f=[tDir <span class="string">'/I'</span> int2str2(frame,5) <span class="string">'.'</span>]; sr.seek(frame);
0265   <span class="keyword">if</span>(~isempty(ext)), I=sr.getframe(); imwrite(I,[f ext]); <span class="keyword">else</span>
0266     I=sr.getframeb(); f=fopen([f  info.ext],<span class="string">'w'</span>);
0267     <span class="keyword">if</span>(f&lt;=0), sr.close(); assert(false); <span class="keyword">end</span>
0268     fwrite(f,I); fclose(f);
0269   <span class="keyword">end</span>; k=k+1; tocStatus(tid,k/n);
0270 <span class="keyword">end</span>; sr.close();
0271 <span class="keyword">end</span>
0272 
0273 <a name="_sub7" href="#_subfunctions" class="code">function frImgs( fName, info, varargin )</a>
0274 <span class="comment">% Create seq file from an array or directory of images or from an AVI file.</span>
0275 <span class="comment">%</span>
0276 <span class="comment">% For info, if converting from array, only codec (e.g., 'jpg') and fps must</span>
0277 <span class="comment">% be specified while width and height and determined automatically. If</span>
0278 <span class="comment">% converting from AVI, fps is also determined automatically.</span>
0279 <span class="comment">%</span>
0280 <span class="comment">% USAGE</span>
0281 <span class="comment">%  seqIo( fName, 'frImgs', info, varargin )</span>
0282 <span class="comment">%</span>
0283 <span class="comment">% INPUTS</span>
0284 <span class="comment">%  fName      - seq file name</span>
0285 <span class="comment">%  info       - defines codec, etc, see seqIo&gt;writer</span>
0286 <span class="comment">%  varargin   - additional params (struct or name/value pairs)</span>
0287 <span class="comment">%   .aviName    - [] if specified create seq from avi file</span>
0288 <span class="comment">%   .Is         - [] if specified create seq from image array</span>
0289 <span class="comment">%   .sDir       - [] source directory</span>
0290 <span class="comment">%   .skip       - [1] skip between frames</span>
0291 <span class="comment">%   .name       - ['I'] base name of images</span>
0292 <span class="comment">%   .nDigits    - [5] number of digits for filename index</span>
0293 <span class="comment">%   .f0         - [0] first frame to read</span>
0294 <span class="comment">%   .f1         - [10^6] last frame to read</span>
0295 <span class="comment">%</span>
0296 <span class="comment">% OUTPUTS</span>
0297 <span class="comment">%</span>
0298 <span class="comment">% EXAMPLE</span>
0299 <span class="comment">%</span>
0300 <span class="comment">% See also seqIo, seqIo&gt;writer</span>
0301 dfs={<span class="string">'aviName'</span>,<span class="string">''</span>,<span class="string">'Is'</span>,[],<span class="string">'sDir'</span>,[],<span class="string">'skip'</span>,1,<span class="string">'name'</span>,<span class="string">'I'</span>,<span class="keyword">...</span>
0302   <span class="string">'nDigits'</span>,5,<span class="string">'f0'</span>,0,<span class="string">'f1'</span>,10^6};
0303 [aviName,Is,sDir,skip,name,nDigits,f0,f1] <span class="keyword">...</span>
0304   = getPrmDflt(varargin,dfs,1);
0305 <span class="keyword">if</span>(~isempty(aviName))
0306   <span class="keyword">if</span>(exist(<span class="string">'mmread.m'</span>,<span class="string">'file'</span>)==2) <span class="comment">% use external mmread function</span>
0307     <span class="comment">%  mmread requires full pathname, which is obtained via 'which'. But,</span>
0308     <span class="comment">% 'which' can fail (maltab bug), so best to just pass in full pathname</span>
0309     t=which(aviName); <span class="keyword">if</span>(~isempty(t)), aviName=t; <span class="keyword">end</span>
0310     V=mmread(aviName); n=V.nrFramesTotal;
0311     info.height=V.height; info.width=V.width; info.fps=V.rate;
0312     sw=<a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>(fName,info); tid=ticStatus(<span class="string">'creating seq from avi'</span>);
0313     <span class="keyword">for</span> f=1:n, sw.addframe(V.frames(f).cdata); tocStatus(tid,f/n); <span class="keyword">end</span>
0314     sw.close();
0315   <span class="keyword">else</span> <span class="comment">% use matlab mmreader function</span>
0316     emsg=[<span class="string">'mmreader.m failed to load video. In general mmreader.m is '</span> <span class="keyword">...</span>
0317       <span class="string">'known to have many issues, especially on Linux. I suggest '</span> <span class="keyword">...</span>
0318       <span class="string">'installing the similarly named mmread toolbox from Micah '</span> <span class="keyword">...</span>
0319       <span class="string">'Richert, available at Matlab Central. If mmread is installed, '</span> <span class="keyword">...</span>
0320       <span class="string">'seqIo will automatically use mmread instead of mmreader.'</span>];
0321     <span class="keyword">try</span> V=mmreader(aviName); <span class="keyword">catch</span> <span class="comment">%#ok&lt;DMMR,CTCH&gt;</span>
0322       error(<span class="string">'piotr:seqIo:frImgs'</span>,emsg); <span class="keyword">end</span>; n=V.NumberOfFrames;
0323     info.height=V.Height; info.width=V.Width; info.fps=V.FrameRate;
0324     sw=<a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>(fName,info); tid=ticStatus(<span class="string">'creating seq from avi'</span>);
0325     <span class="keyword">for</span> f=1:n, sw.addframe(read(V,f)); tocStatus(tid,f/n); <span class="keyword">end</span>
0326     sw.close();
0327   <span class="keyword">end</span>
0328 <span class="keyword">elseif</span>( isempty(Is) )
0329   assert(exist(sDir,<span class="string">'dir'</span>)==7); sw=<a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>(fName,info); info=sw.getinfo();
0330   frmStr=sprintf(<span class="string">'%s/%s%%0%ii.%s'</span>,sDir,name,nDigits,info.ext);
0331   <span class="keyword">for</span> frame = f0:skip:f1
0332     f=sprintf(frmStr,frame); <span class="keyword">if</span>(~exist(f,<span class="string">'file'</span>)), <span class="keyword">break</span>; <span class="keyword">end</span>
0333     f=fopen(f,<span class="string">'r'</span>);  <span class="keyword">if</span>(f&lt;=0), sw.close(); assert(false); <span class="keyword">end</span>
0334     I=fread(f); fclose(f); sw.addframeb(I);
0335   <span class="keyword">end</span>; sw.close();
0336   <span class="keyword">if</span>(frame==f0), warning(<span class="string">'No images found.'</span>); <span class="keyword">end</span> <span class="comment">%#ok&lt;WNTAG&gt;</span>
0337 <span class="keyword">else</span>
0338   nd=ndims(Is); <span class="keyword">if</span>(nd==2), nd=3; <span class="keyword">end</span>; assert(nd&lt;=4); nFrm=size(Is,nd);
0339   info.height=size(Is,1); info.width=size(Is,2); sw=<a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>(fName,info);
0340   <span class="keyword">if</span>(nd==3), <span class="keyword">for</span> f=1:nFrm, sw.addframe(Is(:,:,f)); <span class="keyword">end</span>; <span class="keyword">end</span>
0341   <span class="keyword">if</span>(nd==4), <span class="keyword">for</span> f=1:nFrm, sw.addframe(Is(:,:,:,f)); <span class="keyword">end</span>; <span class="keyword">end</span>
0342   sw.close();
0343 <span class="keyword">end</span>
0344 <span class="keyword">end</span>
0345 
0346 <a name="_sub8" href="#_subfunctions" class="code">function convert( fName, tName, imgFun, varargin )</a>
0347 <span class="comment">% Convert seq file by applying imgFun(I) to each frame I.</span>
0348 <span class="comment">%</span>
0349 <span class="comment">% USAGE</span>
0350 <span class="comment">%  seqIo( fName, 'convert', tName, imgFun, varargin )</span>
0351 <span class="comment">%</span>
0352 <span class="comment">% INPUTS</span>
0353 <span class="comment">%  fName      - seq file name</span>
0354 <span class="comment">%  tName      - converted seq file name</span>
0355 <span class="comment">%  imgFun     - function to apply to each image</span>
0356 <span class="comment">%  varargin   - additional params (struct or name/value pairs)</span>
0357 <span class="comment">%   .info       - [] info for target seq file</span>
0358 <span class="comment">%   .skip       - [1] skip between frames</span>
0359 <span class="comment">%   .f0         - [0] first frame to read</span>
0360 <span class="comment">%   .f1         - [inf] last frame to read</span>
0361 <span class="comment">%</span>
0362 <span class="comment">% OUTPUTS</span>
0363 <span class="comment">%</span>
0364 <span class="comment">% EXAMPLE</span>
0365 <span class="comment">%</span>
0366 <span class="comment">% See also seqIo</span>
0367 dfs={<span class="string">'info'</span>,[],<span class="string">'skip'</span>,1,<span class="string">'f0'</span>,0,<span class="string">'f1'</span>,inf};
0368 [info,skip,f0,f1]=getPrmDflt(varargin,dfs,1);
0369 assert(~strcmp(tName,fName)); sr=<a href="#_sub1" class="code" title="subfunction sr = reader( fName, cache )">reader</a>(fName); infor=sr.getinfo();
0370 <span class="keyword">if</span>(isempty(info)), info=infor; <span class="keyword">end</span>; n=infor.numFrames; f1=min(f1,n-1);
0371 I=sr.getnext(); I=imgFun(I); info.width=size(I,2); info.height=size(I,1);
0372 sw=<a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>(tName,info); tid=ticStatus(<span class="string">'converting seq'</span>);
0373 frames=f0:skip:f1; n=length(frames); k=0;
0374 <span class="keyword">for</span> f=frames, sr.seek(f); [I,ts]=sr.getframe(); I=imgFun(I);
0375   <span class="keyword">if</span>(skip==1), sw.addframe(I,ts); <span class="keyword">else</span> sw.addframe(I); <span class="keyword">end</span>
0376   k=k+1; tocStatus(tid,k/n);
0377 <span class="keyword">end</span>; sw.close(); sr.close();
0378 <span class="keyword">end</span>
0379 
0380 <a name="_sub9" href="#_subfunctions" class="code">function newHeader( fName, info )</a>
0381 <span class="comment">% Replace header of seq file with provided info.</span>
0382 <span class="comment">%</span>
0383 <span class="comment">% Can be used if the file fName has a corrupt header. Automatically tries</span>
0384 <span class="comment">% to compute number of frames in fName. No guarantees that it will work.</span>
0385 <span class="comment">%</span>
0386 <span class="comment">% USAGE</span>
0387 <span class="comment">%  seqIo( fName, 'newHeader', info )</span>
0388 <span class="comment">%</span>
0389 <span class="comment">% INPUTS</span>
0390 <span class="comment">%  fName      - seq file name</span>
0391 <span class="comment">%  info       - info for target seq file</span>
0392 <span class="comment">%</span>
0393 <span class="comment">% OUTPUTS</span>
0394 <span class="comment">%</span>
0395 <span class="comment">% EXAMPLE</span>
0396 <span class="comment">%</span>
0397 <span class="comment">% See also seqIo</span>
0398 [d,n]=fileparts(fName); <span class="keyword">if</span>(isempty(d)), d=<span class="string">'.'</span>; <span class="keyword">end</span>
0399 fName=[d <span class="string">'/'</span> n]; tName=[fName <span class="string">'-new'</span> datestr(now,30)];
0400 <span class="keyword">if</span>(exist([fName <span class="string">'-seek.mat'</span>],<span class="string">'file'</span>)); delete([fName <span class="string">'-seek.mat'</span>]); <span class="keyword">end</span>
0401 srp=@<a href="seqReaderPlugin.html" class="code" title="function varargout = seqReaderPlugin( cmd, h, varargin )">seqReaderPlugin</a>; hr=srp(<span class="string">'open'</span>,int32(-1),fName,info); tid=ticStatus;
0402 info=srp(<span class="string">'getinfo'</span>,hr); sw=<a href="#_sub3" class="code" title="subfunction sw = writer( fName, info )">writer</a>(tName,info); n=info.numFrames;
0403 <span class="keyword">for</span> f=1:n, srp(<span class="string">'next'</span>,hr); [I,ts]=srp(<span class="string">'getframeb'</span>,hr);
0404   sw.addframeb(I,ts); tocStatus(tid,f/n); <span class="keyword">end</span>
0405 srp(<span class="string">'close'</span>,hr); sw.close();
0406 <span class="keyword">end</span>
0407 
0408 <a name="_sub10" href="#_subfunctions" class="code">function sr = readerDual( fNames, cache )</a>
0409 <span class="comment">% Create interface sr for reading dual seq files.</span>
0410 <span class="comment">%</span>
0411 <span class="comment">% Wrapper for two seq files of the same image dims and roughly the same</span>
0412 <span class="comment">% frame counts that are treated as a single reader object. getframe()</span>
0413 <span class="comment">% returns the concatentation of the two frames. For videos of different</span>
0414 <span class="comment">% frame counts, the first video serves as the &quot;dominant&quot; video and the</span>
0415 <span class="comment">% frame count of the second video is adjusted accordingly. Same general</span>
0416 <span class="comment">% usage as in reader, but the only supported operations are: close(),</span>
0417 <span class="comment">% getframe(), getinfo(), and seek().</span>
0418 <span class="comment">%</span>
0419 <span class="comment">% USAGE</span>
0420 <span class="comment">%  sr = seqIo( fNames, 'readerDual', [cache] )</span>
0421 <span class="comment">%</span>
0422 <span class="comment">% INPUTS</span>
0423 <span class="comment">%  fNames - two seq file names</span>
0424 <span class="comment">%  cache  - [0] size of cache (see seqIo&gt;reader)</span>
0425 <span class="comment">%</span>
0426 <span class="comment">% OUTPUTS</span>
0427 <span class="comment">%  sr     - interface for reading seq file</span>
0428 <span class="comment">%</span>
0429 <span class="comment">% EXAMPLE</span>
0430 <span class="comment">%</span>
0431 <span class="comment">% See also seqIo, seqIo&gt;reader</span>
0432 <span class="keyword">if</span>(nargin&lt;2 || isempty(cache)), cache=0; <span class="keyword">end</span>
0433 s1=<a href="#_sub1" class="code" title="subfunction sr = reader( fName, cache )">reader</a>(fNames{1}, cache); i1=s1.getinfo();
0434 s2=<a href="#_sub1" class="code" title="subfunction sr = reader( fName, cache )">reader</a>(fNames{2}, cache); i2=s2.getinfo();
0435 info=i1; info.width=i1.width+i2.width;
0436 <span class="keyword">if</span>( i1.width~=i2.width || i1.height~=i2.height )
0437   s1.close(); s2.close(); error(<span class="string">'Mismatched videos'</span>); <span class="keyword">end</span>
0438 <span class="keyword">if</span>( i1.numFrames~=i2.numFrames )
0439   warning(<span class="string">'seq files of different lengths'</span>); <span class="keyword">end</span> <span class="comment">%#ok&lt;WNTAG&gt;</span>
0440 frame2=@(f) round(f/(i1.numFrames-1)*(i2.numFrames-1));
0441 
0442 sr=struct(<span class="string">'close'</span>,@() min(s1.close(),s2.close()), <span class="keyword">...</span>
0443   <span class="string">'getframe'</span>,@<a href="#_sub2  11" class="code" title="subfunction [I,t] = getframe()function [I,t] = getframe()">getframe</a>, <span class="string">'getinfo'</span>,@() info, <span class="keyword">...</span>
0444   <span class="string">'seek'</span>,@(f) s1.seek(f) &amp; s2.seek(frame2(f)) );
0445 
0446   <a name="_sub11" href="#_subfunctions" class="code">function [I,t] = getframe()</a>
0447     [I1,t]=s1.getframe(); I2=s2.getframe(); I=[I1 I2]; <span class="keyword">end</span>
0448 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 05-May-2022 14:52:24 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>