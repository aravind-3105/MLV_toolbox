<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fevalDistr</title>
  <meta name="keywords" content="fevalDistr">
  <meta name="description" content="Wrapper for embarrassingly parallel function evaluation.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">MLVcode</a> &gt; <a href="../../index.html">edges-master</a> &gt; <a href="#">toolbox-master</a> &gt; <a href="index.html">matlab</a> &gt; fevalDistr.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for MLVcode\edges-master\toolbox-master\matlab&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>fevalDistr
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Wrapper for embarrassingly parallel function evaluation.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function [out,res] = fevalDistr( funNm, jobs, varargin ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Wrapper for embarrassingly parallel function evaluation.

 Runs &quot;r=feval(funNm,jobs{i}{:})&quot; for each job in a parallel manner. jobs
 should be a cell array of length nJob and each job should be a cell array
 of parameters to pass to funNm. funNm must be a function in the path and
 must return a single value (which may be a dummy value if funNm writes
 results to disk). Different forms of parallelization are supported
 depending on the hardware and Matlab toolboxes available. The type of
 parallelization is determined by the parameter 'type' described below.

 type='LOCAL': jobs are executed using a simple &quot;for&quot; loop. This implies
 no parallelization and is the default fallback option.

 type='PARFOR': jobs are executed using a &quot;parfor&quot; loop. This option is
 only available if the Matlab *Parallel Computing Toolbox* is installed.
 Make sure to setup Matlab workers first using &quot;matlabpool open&quot;.

 type='DISTR': jobs are executed on the Caltech cluster. Distributed
 queuing system must be installed separately. Currently this option is
 only supported on the Caltech cluster but could easily be installed on
 any Linux cluster as it requires only SSH and a shared filesystem.
 Parameter pLaunch is used for controller('launchQueue',pLaunch{:}) and
 determines cluster machines used (e.g. pLaunch={48,401:408}).

 type='COMPILED': jobs are executed locally in parallel by first compiling
 an executable and then running it in background. This option requires the
 *Matlab Compiler* to be installed (but does NOT require the Parallel
 Computing Toolbox). Compiling can take 1-10 minutes, so use this option
 only for large jobs. (On Linux alter startup.m by calling addpath() only
 if ~isdeployed, otherwise will get error about &quot;CTF&quot; after compiling).
 Note that relative paths will not work after compiling so all paths used
 by funNm must be absolute paths.

 type='WINHPC': jobs are executed on a Windows HPC Server 2008 cluster.
 Similar to type='COMPILED', except after compiling, the executable is
 queued to the HPC cluster where all computation occurs. This option
 likewise requires the *Matlab Compiler*. Paths to data, etc., must be
 absolute paths and available from HPC cluster. Parameter pLaunch must
 have two fields 'scheduler' and 'shareDir' that define the HPC Server.
 Extra parameters in pLaunch add finer control, see fedWinhpc for details.
 For example, at MSR one possible cluster is defined by scheduler =
 'MSR-L25-DEV21' and shareDir = '\\msr-arrays\scratch\msr-pool\L25-dev21'.
 Note call to 'job submit' from Matlab will hang unless pwd is saved
 (simply call 'job submit' from cmd prompt and enter pwd).

 USAGE
  [out,res] = fevalDistr( funNm, jobs, [varargin] )

 INPUTS
  funNm      - name of function that will process jobs
  jobs       - [1xnJob] cell array of parameters for each job
  varargin   - additional params (struct or name/value pairs)
   .type       - ['local'], 'parfor', 'distr', 'compiled', 'winhpc'
   .pLaunch    - [] extra params for type='distr' or type='winhpc'
   .group      - [1] send jobs in batches (only relevant if type='distr')

 OUTPUTS
  out        - 1 if jobs completed successfully
  res        - [1xnJob] cell array containing results of each job

 EXAMPLE
  % Note: in this case parallel versions are slower since conv2 is so fast
  n=16; jobs=cell(1,n); for i=1:n, jobs{i}={rand(500),ones(25)}; end
  tic, [out,J1] = fevalDistr('conv2',jobs,'type','local'); toc,
  tic, [out,J2] = fevalDistr('conv2',jobs,'type','parfor'); toc,
  tic, [out,J3] = fevalDistr('conv2',jobs,'type','compiled'); toc
  [isequal(J1,J2), isequal(J1,J3)], figure(1); montage2(cell2array(J1))

 See also matlabpool mcc

 Piotr's Computer Vision Matlab Toolbox      Version 3.26
 Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]
 Licensed under the Simplified BSD License [see external/bsd.txt]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="getPrmDflt.html" class="code" title="function varargout = getPrmDflt( prm, dfs, checkExtra )">getPrmDflt</a>	Helper to set default values (if not already set) of parameter struct.</li><li><a href="int2str2.html" class="code" title="function nstr = int2str2( n, nDigits )">int2str2</a>	Convert integer to string of given length; improved version of int2str.</li><li><a href="ticStatus.html" class="code" title="function id = ticStatus( msg, updateFreq, updateMinT, erasePrev )">ticStatus</a>	Used to display the progress of a long process.</li><li><a href="tocStatus.html" class="code" title="function tocStatus( id, fracDone )">tocStatus</a>	Used to display the progress of a long process.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [out,res] = fedLocal( funNm, jobs, store )</a></li><li><a href="#_sub2" class="code">function [out,res] = fedParfor( funNm, jobs, store )</a></li><li><a href="#_sub3" class="code">function [out,res] = fedDistr( funNm, jobs, pLaunch, group, store )</a></li><li><a href="#_sub4" class="code">function [out,res] = fedCompiled( funNm, jobs, store )</a></li><li><a href="#_sub5" class="code">function [out,res] = fedWinhpc( funNm, jobs, pLaunch, store )</a></li><li><a href="#_sub6" class="code">function tids = hpcSubmit( funNm, ids, tDir, pLaunch )</a></li><li><a href="#_sub7" class="code">function v = hpcParse( msg, key, tonum )</a></li><li><a href="#_sub8" class="code">function tDir = jobSetup( rtDir, funNm, executable, mccOptions )</a></li><li><a href="#_sub9" class="code">function ids = jobFileIds( tDir, type )</a></li><li><a href="#_sub10" class="code">function jobSave( tDir, job, ind )</a></li><li><a href="#_sub11" class="code">function r = jobLoad( tDir, ind, store )</a></li><li><a href="#_sub12" class="code">function msg = system2( cmd, show )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [out,res] = fevalDistr( funNm, jobs, varargin )</a>
0002 <span class="comment">% Wrapper for embarrassingly parallel function evaluation.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Runs &quot;r=feval(funNm,jobs{i}{:})&quot; for each job in a parallel manner. jobs</span>
0005 <span class="comment">% should be a cell array of length nJob and each job should be a cell array</span>
0006 <span class="comment">% of parameters to pass to funNm. funNm must be a function in the path and</span>
0007 <span class="comment">% must return a single value (which may be a dummy value if funNm writes</span>
0008 <span class="comment">% results to disk). Different forms of parallelization are supported</span>
0009 <span class="comment">% depending on the hardware and Matlab toolboxes available. The type of</span>
0010 <span class="comment">% parallelization is determined by the parameter 'type' described below.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% type='LOCAL': jobs are executed using a simple &quot;for&quot; loop. This implies</span>
0013 <span class="comment">% no parallelization and is the default fallback option.</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% type='PARFOR': jobs are executed using a &quot;parfor&quot; loop. This option is</span>
0016 <span class="comment">% only available if the Matlab *Parallel Computing Toolbox* is installed.</span>
0017 <span class="comment">% Make sure to setup Matlab workers first using &quot;matlabpool open&quot;.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% type='DISTR': jobs are executed on the Caltech cluster. Distributed</span>
0020 <span class="comment">% queuing system must be installed separately. Currently this option is</span>
0021 <span class="comment">% only supported on the Caltech cluster but could easily be installed on</span>
0022 <span class="comment">% any Linux cluster as it requires only SSH and a shared filesystem.</span>
0023 <span class="comment">% Parameter pLaunch is used for controller('launchQueue',pLaunch{:}) and</span>
0024 <span class="comment">% determines cluster machines used (e.g. pLaunch={48,401:408}).</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% type='COMPILED': jobs are executed locally in parallel by first compiling</span>
0027 <span class="comment">% an executable and then running it in background. This option requires the</span>
0028 <span class="comment">% *Matlab Compiler* to be installed (but does NOT require the Parallel</span>
0029 <span class="comment">% Computing Toolbox). Compiling can take 1-10 minutes, so use this option</span>
0030 <span class="comment">% only for large jobs. (On Linux alter startup.m by calling addpath() only</span>
0031 <span class="comment">% if ~isdeployed, otherwise will get error about &quot;CTF&quot; after compiling).</span>
0032 <span class="comment">% Note that relative paths will not work after compiling so all paths used</span>
0033 <span class="comment">% by funNm must be absolute paths.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% type='WINHPC': jobs are executed on a Windows HPC Server 2008 cluster.</span>
0036 <span class="comment">% Similar to type='COMPILED', except after compiling, the executable is</span>
0037 <span class="comment">% queued to the HPC cluster where all computation occurs. This option</span>
0038 <span class="comment">% likewise requires the *Matlab Compiler*. Paths to data, etc., must be</span>
0039 <span class="comment">% absolute paths and available from HPC cluster. Parameter pLaunch must</span>
0040 <span class="comment">% have two fields 'scheduler' and 'shareDir' that define the HPC Server.</span>
0041 <span class="comment">% Extra parameters in pLaunch add finer control, see fedWinhpc for details.</span>
0042 <span class="comment">% For example, at MSR one possible cluster is defined by scheduler =</span>
0043 <span class="comment">% 'MSR-L25-DEV21' and shareDir = '\\msr-arrays\scratch\msr-pool\L25-dev21'.</span>
0044 <span class="comment">% Note call to 'job submit' from Matlab will hang unless pwd is saved</span>
0045 <span class="comment">% (simply call 'job submit' from cmd prompt and enter pwd).</span>
0046 <span class="comment">%</span>
0047 <span class="comment">% USAGE</span>
0048 <span class="comment">%  [out,res] = fevalDistr( funNm, jobs, [varargin] )</span>
0049 <span class="comment">%</span>
0050 <span class="comment">% INPUTS</span>
0051 <span class="comment">%  funNm      - name of function that will process jobs</span>
0052 <span class="comment">%  jobs       - [1xnJob] cell array of parameters for each job</span>
0053 <span class="comment">%  varargin   - additional params (struct or name/value pairs)</span>
0054 <span class="comment">%   .type       - ['local'], 'parfor', 'distr', 'compiled', 'winhpc'</span>
0055 <span class="comment">%   .pLaunch    - [] extra params for type='distr' or type='winhpc'</span>
0056 <span class="comment">%   .group      - [1] send jobs in batches (only relevant if type='distr')</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% OUTPUTS</span>
0059 <span class="comment">%  out        - 1 if jobs completed successfully</span>
0060 <span class="comment">%  res        - [1xnJob] cell array containing results of each job</span>
0061 <span class="comment">%</span>
0062 <span class="comment">% EXAMPLE</span>
0063 <span class="comment">%  % Note: in this case parallel versions are slower since conv2 is so fast</span>
0064 <span class="comment">%  n=16; jobs=cell(1,n); for i=1:n, jobs{i}={rand(500),ones(25)}; end</span>
0065 <span class="comment">%  tic, [out,J1] = fevalDistr('conv2',jobs,'type','local'); toc,</span>
0066 <span class="comment">%  tic, [out,J2] = fevalDistr('conv2',jobs,'type','parfor'); toc,</span>
0067 <span class="comment">%  tic, [out,J3] = fevalDistr('conv2',jobs,'type','compiled'); toc</span>
0068 <span class="comment">%  [isequal(J1,J2), isequal(J1,J3)], figure(1); montage2(cell2array(J1))</span>
0069 <span class="comment">%</span>
0070 <span class="comment">% See also matlabpool mcc</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% Piotr's Computer Vision Matlab Toolbox      Version 3.26</span>
0073 <span class="comment">% Copyright 2014 Piotr Dollar.  [pdollar-at-gmail.com]</span>
0074 <span class="comment">% Licensed under the Simplified BSD License [see external/bsd.txt]</span>
0075 dfs={<span class="string">'type'</span>,<span class="string">'local'</span>,<span class="string">'pLaunch'</span>,[],<span class="string">'group'</span>,1};
0076 [type,pLaunch,group]=<a href="getPrmDflt.html" class="code" title="function varargout = getPrmDflt( prm, dfs, checkExtra )">getPrmDflt</a>(varargin,dfs,1); store=(nargout==2);
0077 <span class="keyword">if</span>(isempty(jobs)), res=cell(1,0); out=1; <span class="keyword">return</span>; <span class="keyword">end</span>
0078 <span class="keyword">switch</span> lower(type)
0079   <span class="keyword">case</span> <span class="string">'local'</span>,     [out,res]=<a href="#_sub1" class="code" title="subfunction [out,res] = fedLocal( funNm, jobs, store )">fedLocal</a>(funNm,jobs,store);
0080   <span class="keyword">case</span> <span class="string">'parfor'</span>,    [out,res]=<a href="#_sub2" class="code" title="subfunction [out,res] = fedParfor( funNm, jobs, store )">fedParfor</a>(funNm,jobs,store);
0081   <span class="keyword">case</span> <span class="string">'distr'</span>,     [out,res]=<a href="#_sub3" class="code" title="subfunction [out,res] = fedDistr( funNm, jobs, pLaunch, group, store )">fedDistr</a>(funNm,jobs,pLaunch,group,store);
0082   <span class="keyword">case</span> <span class="string">'compiled'</span>,  [out,res]=<a href="#_sub4" class="code" title="subfunction [out,res] = fedCompiled( funNm, jobs, store )">fedCompiled</a>(funNm,jobs,store);
0083   <span class="keyword">case</span> <span class="string">'winhpc'</span>,    [out,res]=<a href="#_sub5" class="code" title="subfunction [out,res] = fedWinhpc( funNm, jobs, pLaunch, store )">fedWinhpc</a>(funNm,jobs,pLaunch,store);
0084   <span class="keyword">otherwise</span>,        error(<span class="string">'unkown type: ''%s'''</span>,type);
0085 <span class="keyword">end</span>
0086 <span class="keyword">end</span>
0087 
0088 <a name="_sub1" href="#_subfunctions" class="code">function [out,res] = fedLocal( funNm, jobs, store )</a>
0089 <span class="comment">% Run jobs locally using for loop.</span>
0090 nJob=length(jobs); res=cell(1,nJob); out=1;
0091 tid=<a href="ticStatus.html" class="code" title="function id = ticStatus( msg, updateFreq, updateMinT, erasePrev )">ticStatus</a>(<span class="string">'collecting jobs'</span>);
0092 <span class="keyword">for</span> i=1:nJob, r=feval(funNm,jobs{i}{:});
0093   <span class="keyword">if</span>(store), res{i}=r; <span class="keyword">end</span>; <a href="tocStatus.html" class="code" title="function tocStatus( id, fracDone )">tocStatus</a>(tid,i/nJob); <span class="keyword">end</span>
0094 <span class="keyword">end</span>
0095 
0096 <a name="_sub2" href="#_subfunctions" class="code">function [out,res] = fedParfor( funNm, jobs, store )</a>
0097 <span class="comment">% Run jobs locally using parfor loop.</span>
0098 nJob=length(jobs); res=cell(1,nJob); out=1;
0099 parfor i=1:nJob, r=feval(funNm,jobs{i}{:});
0100   <span class="keyword">if</span>(store), res{i}=r; <span class="keyword">end</span>; <span class="keyword">end</span>
0101 <span class="keyword">end</span>
0102 
0103 <a name="_sub3" href="#_subfunctions" class="code">function [out,res] = fedDistr( funNm, jobs, pLaunch, group, store )</a>
0104 <span class="comment">% Run jobs using Linux queuing system.</span>
0105 <span class="keyword">if</span>(~exist(<span class="string">'controller.m'</span>,<span class="string">'file'</span>))
0106   msg=<span class="string">'distributed queuing not installed, switching to type=''local''.'</span>;
0107   warning(msg); [out,res]=<a href="#_sub1" class="code" title="subfunction [out,res] = fedLocal( funNm, jobs, store )">fedLocal</a>(funNm,jobs,store); <span class="keyword">return</span>; <span class="comment">%#ok&lt;WNTAG&gt;</span>
0108 <span class="keyword">end</span>
0109 nJob=length(jobs); res=cell(1,nJob); controller(<span class="string">'launchQueue'</span>,pLaunch{:});
0110 <span class="keyword">if</span>( group&gt;1 )
0111   nJobGrp=ceil(nJob/group); jobsGrp=cell(1,nJobGrp); k=0;
0112   <span class="keyword">for</span> i=1:nJobGrp, k1=min(nJob,k+group);
0113     jobsGrp{i}={funNm,jobs(k+1:k1),<span class="string">'type'</span>,<span class="string">'local'</span>}; k=k1; <span class="keyword">end</span>
0114   nJob=nJobGrp; jobs=jobsGrp; funNm=<span class="string">'fevalDistr'</span>;
0115 <span class="keyword">end</span>
0116 jids=controller(<span class="string">'jobsAdd'</span>,nJob,funNm,jobs); k=0;
0117 fprintf(<span class="string">'Sent %i jobs...\n'</span>,nJob); tid=<a href="ticStatus.html" class="code" title="function id = ticStatus( msg, updateFreq, updateMinT, erasePrev )">ticStatus</a>(<span class="string">'collecting jobs'</span>);
0118 <span class="keyword">while</span>( 1 )
0119   jids1=controller(<span class="string">'jobProbe'</span>,jids);
0120   <span class="keyword">if</span>(isempty(jids1)), pause(.1); <span class="keyword">continue</span>; <span class="keyword">end</span>
0121   jid=jids1(1); [r,err]=controller(<span class="string">'jobRecv'</span>,jid);
0122   <span class="keyword">if</span>(~isempty(err)), disp(<span class="string">'ABORTING'</span>); out=0; <span class="keyword">break</span>; <span class="keyword">end</span>
0123   k=k+1; <span class="keyword">if</span>(store), res{jid==jids}=r; <span class="keyword">end</span>
0124   <a href="tocStatus.html" class="code" title="function tocStatus( id, fracDone )">tocStatus</a>(tid,k/nJob); <span class="keyword">if</span>(k==nJob), out=1; <span class="keyword">break</span>; <span class="keyword">end</span>
0125 <span class="keyword">end</span>; controller(<span class="string">'closeQueue'</span>);
0126 <span class="keyword">end</span>
0127 
0128 <a name="_sub4" href="#_subfunctions" class="code">function [out,res] = fedCompiled( funNm, jobs, store )</a>
0129 <span class="comment">% Run jobs locally in background in parallel using compiled code.</span>
0130 nJob=length(jobs); res=cell(1,nJob); tDir=<a href="#_sub8" class="code" title="subfunction tDir = jobSetup( rtDir, funNm, executable, mccOptions )">jobSetup</a>(<span class="string">'.'</span>,funNm,<span class="string">''</span>,{});
0131 cmd=[tDir <span class="string">'fevalDistrDisk '</span> funNm <span class="string">' '</span> tDir <span class="string">' '</span>]; i=0; k=0;
0132 Q=feature(<span class="string">'numCores'</span>); q=0; tid=<a href="ticStatus.html" class="code" title="function id = ticStatus( msg, updateFreq, updateMinT, erasePrev )">ticStatus</a>(<span class="string">'collecting jobs'</span>);
0133 <span class="keyword">while</span>( 1 )
0134   <span class="comment">% launch jobs until queue is full (q==Q) or all jobs launched (i==nJob)</span>
0135   <span class="keyword">while</span>(q&lt;Q &amp;&amp; i&lt;nJob), q=q+1; i=i+1; <a href="#_sub10" class="code" title="subfunction jobSave( tDir, job, ind ) ">jobSave</a>(tDir,jobs{i},i);
0136     <span class="keyword">if</span>(ispc), <a href="#_sub12" class="code" title="subfunction msg = system2( cmd, show )">system2</a>([<span class="string">'start /B /min '</span> cmd <a href="int2str2.html" class="code" title="function nstr = int2str2( n, nDigits )">int2str2</a>(i,10)],0);
0137     <span class="keyword">else</span> <a href="#_sub12" class="code" title="subfunction msg = system2( cmd, show )">system2</a>([cmd <a href="int2str2.html" class="code" title="function nstr = int2str2( n, nDigits )">int2str2</a>(i,10) <span class="string">' &amp;'</span>],0); <span class="keyword">end</span>
0138   <span class="keyword">end</span>
0139   <span class="comment">% collect completed jobs (k1 of them), release queue slots</span>
0140   done=<a href="#_sub9" class="code" title="subfunction ids = jobFileIds( tDir, type )">jobFileIds</a>(tDir,<span class="string">'done'</span>); k1=length(done); k=k+k1; q=q-k1;
0141   <span class="keyword">for</span> i1=done, res{i1}=<a href="#_sub11" class="code" title="subfunction r = jobLoad( tDir, ind, store )">jobLoad</a>(tDir,i1,store); <span class="keyword">end</span>
0142   pause(1); <a href="tocStatus.html" class="code" title="function tocStatus( id, fracDone )">tocStatus</a>(tid,k/nJob); <span class="keyword">if</span>(k==nJob), out=1; <span class="keyword">break</span>; <span class="keyword">end</span>
0143 <span class="keyword">end</span>
0144 <span class="keyword">for</span> i=1:10, <span class="keyword">try</span> rmdir(tDir,<span class="string">'s'</span>); <span class="keyword">break</span>; <span class="keyword">catch</span>,pause(1),<span class="keyword">end</span>; <span class="keyword">end</span> <span class="comment">%#ok&lt;CTCH&gt;</span>
0145 <span class="keyword">end</span>
0146 
0147 <a name="_sub5" href="#_subfunctions" class="code">function [out,res] = fedWinhpc( funNm, jobs, pLaunch, store )</a>
0148 <span class="comment">% Run jobs using Windows HPC Server.</span>
0149 nJob=length(jobs); res=cell(1,nJob);
0150 dfs={<span class="string">'shareDir'</span>,<span class="string">'REQ'</span>,<span class="string">'scheduler'</span>,<span class="string">'REQ'</span>,<span class="string">'executable'</span>,<span class="string">'fevalDistrDisk'</span>,<span class="keyword">...</span>
0151   <span class="string">'mccOptions'</span>,{},<span class="string">'coresPerTask'</span>,1,<span class="string">'minCores'</span>,1024,<span class="string">'priority'</span>,2000};
0152 p = <a href="getPrmDflt.html" class="code" title="function varargout = getPrmDflt( prm, dfs, checkExtra )">getPrmDflt</a>(pLaunch,dfs,1);
0153 tDir = <a href="#_sub8" class="code" title="subfunction tDir = jobSetup( rtDir, funNm, executable, mccOptions )">jobSetup</a>(p.shareDir,funNm,p.executable,p.mccOptions);
0154 <span class="keyword">for</span> i=1:nJob, <a href="#_sub10" class="code" title="subfunction jobSave( tDir, job, ind ) ">jobSave</a>(tDir,jobs{i},i); <span class="keyword">end</span>
0155 <a href="#_sub6" class="code" title="subfunction tids = hpcSubmit( funNm, ids, tDir, pLaunch )">hpcSubmit</a>(funNm,1:nJob,tDir,p); k=0;
0156 ticId=<a href="ticStatus.html" class="code" title="function id = ticStatus( msg, updateFreq, updateMinT, erasePrev )">ticStatus</a>(<span class="string">'collecting jobs'</span>);
0157 <span class="keyword">while</span>( 1 )
0158   done=<a href="#_sub9" class="code" title="subfunction ids = jobFileIds( tDir, type )">jobFileIds</a>(tDir,<span class="string">'done'</span>); k=k+length(done);
0159   <span class="keyword">for</span> i1=done, res{i1}=<a href="#_sub11" class="code" title="subfunction r = jobLoad( tDir, ind, store )">jobLoad</a>(tDir,i1,store); <span class="keyword">end</span>
0160   pause(5); <a href="tocStatus.html" class="code" title="function tocStatus( id, fracDone )">tocStatus</a>(ticId,k/nJob); <span class="keyword">if</span>(k==nJob), out=1; <span class="keyword">break</span>; <span class="keyword">end</span>
0161 <span class="keyword">end</span>
0162 <span class="keyword">for</span> i=1:10, <span class="keyword">try</span> rmdir(tDir,<span class="string">'s'</span>); <span class="keyword">break</span>; <span class="keyword">catch</span>,pause(5),<span class="keyword">end</span>; <span class="keyword">end</span> <span class="comment">%#ok&lt;CTCH&gt;</span>
0163 <span class="keyword">end</span>
0164 
0165 <a name="_sub6" href="#_subfunctions" class="code">function tids = hpcSubmit( funNm, ids, tDir, pLaunch )</a>
0166 <span class="comment">% Helper: send jobs w given ids to HPC cluster.</span>
0167 n=length(ids); tids=cell(1,n); <span class="keyword">if</span>(n==0), <span class="keyword">return</span>; <span class="keyword">end</span>;
0168 scheduler=[<span class="string">' /scheduler:'</span> pLaunch.scheduler <span class="string">' '</span>];
0169 m=<a href="#_sub12" class="code" title="subfunction msg = system2( cmd, show )">system2</a>([<span class="string">'cluscfg view'</span> scheduler],0);
0170 minCores=(<a href="#_sub7" class="code" title="subfunction v = hpcParse( msg, key, tonum )">hpcParse</a>(m,<span class="string">'total number of nodes'</span>,1) - <span class="keyword">...</span>
0171   <a href="#_sub7" class="code" title="subfunction v = hpcParse( msg, key, tonum )">hpcParse</a>(m,<span class="string">'Unreachable nodes'</span>,1) - 1)*8;
0172 minCores=min([minCores pLaunch.minCores n*pLaunch.coresPerTask]);
0173 m=<a href="#_sub12" class="code" title="subfunction msg = system2( cmd, show )">system2</a>([<span class="string">'job new /numcores:'</span> int2str(minCores) <span class="string">'-*'</span> scheduler <span class="keyword">...</span>
0174   <span class="string">'/priority:'</span> int2str(pLaunch.priority)],1);
0175 jid=<a href="#_sub7" class="code" title="subfunction v = hpcParse( msg, key, tonum )">hpcParse</a>(m,<span class="string">'created job, id'</span>,0);
0176 s=min(ids); e=max(ids); p=n&gt;1 &amp;&amp; isequal(ids,s:e);
0177 <span class="keyword">if</span>(p), jid1=[jid <span class="string">'.1'</span>]; <span class="keyword">else</span> jid1=jid; <span class="keyword">end</span>
0178 <span class="keyword">for</span> i=1:n, tids{i}=[jid1 <span class="string">'.'</span> int2str(i)]; <span class="keyword">end</span>
0179 cmd0=<span class="string">''</span>; <span class="keyword">if</span>(p), cmd0=[<span class="string">'/parametric:'</span> int2str(s) <span class="string">'-'</span> int2str(e)]; <span class="keyword">end</span>
0180 cmd=@(id) [<span class="string">'job add '</span> jid scheduler <span class="string">'/workdir:'</span> tDir <span class="string">' /numcores:'</span> <span class="keyword">...</span>
0181   int2str(pLaunch.coresPerTask) <span class="string">' '</span> cmd0 <span class="string">' /stdout:stdout'</span> id <span class="keyword">...</span>
0182   <span class="string">'.txt '</span> pLaunch.executable <span class="string">' '</span> funNm <span class="string">' '</span> tDir <span class="string">' '</span> id];
0183 <span class="keyword">if</span>(p), ids1=<span class="string">'*'</span>; n=1; <span class="keyword">else</span> ids1=<a href="int2str2.html" class="code" title="function nstr = int2str2( n, nDigits )">int2str2</a>(ids); <span class="keyword">end</span>
0184 <span class="keyword">if</span>(n==1), ids1={ids1}; <span class="keyword">end</span>; <span class="keyword">for</span> i=1:n, <a href="#_sub12" class="code" title="subfunction msg = system2( cmd, show )">system2</a>(cmd(ids1{i}),1); <span class="keyword">end</span>
0185 <a href="#_sub12" class="code" title="subfunction msg = system2( cmd, show )">system2</a>([<span class="string">'job submit /id:'</span> jid scheduler],1); disp(repmat(<span class="string">' '</span>,1,80));
0186 <span class="keyword">end</span>
0187 
0188 <a name="_sub7" href="#_subfunctions" class="code">function v = hpcParse( msg, key, tonum )</a>
0189 <span class="comment">% Helper: extract val corresponding to key in hpc msg.</span>
0190 t=regexp(msg,<span class="string">': |\n'</span>,<span class="string">'split'</span>); t=strtrim(t(1:floor(length(t)/2)*2));
0191 keys=t(1:2:end); vals=t(2:2:end); j=find(strcmpi(key,keys));
0192 <span class="keyword">if</span>(isempty(j)), error(<span class="string">'key ''%s'' not found in:\n %s'</span>,key,msg); <span class="keyword">end</span>
0193 v=vals{j}; <span class="keyword">if</span>(tonum==0), <span class="keyword">return</span>; <span class="keyword">elseif</span>(isempty(v)), v=0; <span class="keyword">return</span>; <span class="keyword">end</span>
0194 <span class="keyword">if</span>(tonum==1), v=str2double(v); <span class="keyword">return</span>; <span class="keyword">end</span>
0195 v=regexp(v,<span class="string">' '</span>,<span class="string">'split'</span>); v=str2double(regexp(v{1},<span class="string">':'</span>,<span class="string">'split'</span>));
0196 <span class="keyword">if</span>(numel(v)==4), v(5)=0; <span class="keyword">end</span>; v=((v(1)*24+v(2))*60+v(3))*60+v(4)+v(5)/1000;
0197 <span class="keyword">end</span>
0198 
0199 <a name="_sub8" href="#_subfunctions" class="code">function tDir = jobSetup( rtDir, funNm, executable, mccOptions )</a>
0200 <span class="comment">% Helper: prepare by setting up temporary dir and compiling funNm</span>
0201 t=clock; t=mod(t(end),1); t=round((t+rand)/2*1e15);
0202 tDir=[rtDir filesep sprintf(<span class="string">'fevalDistr-%015i'</span>,t) filesep]; mkdir(tDir);
0203 <span class="keyword">if</span>(~isempty(executable) &amp;&amp; exist(executable,<span class="string">'file'</span>))
0204   fprintf(<span class="string">'Reusing compiled executable...\n'</span>); copyfile(executable,tDir);
0205 <span class="keyword">else</span>
0206   t=clock; fprintf(<span class="string">'Compiling (this may take a while)...\n'</span>);
0207   [~,f,e]=fileparts(executable); <span class="keyword">if</span>(isempty(f)), f=<span class="string">'fevalDistrDisk'</span>; <span class="keyword">end</span>
0208   mcc(<span class="string">'-m'</span>,<span class="string">'fevalDistrDisk'</span>,<span class="string">'-d'</span>,tDir,<span class="string">'-o'</span>,f,<span class="string">'-a'</span>,funNm,mccOptions{:});
0209   t=etime(clock,t); fprintf(<span class="string">'Compile complete (%.1f seconds).\n'</span>,t);
0210   <span class="keyword">if</span>(~isempty(executable)), copyfile([tDir filesep f e],executable); <span class="keyword">end</span>
0211 <span class="keyword">end</span>
0212 <span class="keyword">end</span>
0213 
0214 <a name="_sub9" href="#_subfunctions" class="code">function ids = jobFileIds( tDir, type )</a>
0215 <span class="comment">% Helper: get list of job files ids on disk of given type</span>
0216 fs=dir([tDir <span class="string">'*-'</span> type <span class="string">'*'</span>]); fs={fs.name}; n=length(fs);
0217 ids=zeros(1,n); <span class="keyword">for</span> i=1:n, ids(i)=str2double(fs{i}(1:10)); <span class="keyword">end</span>
0218 <span class="keyword">end</span>
0219 
0220 <a name="_sub10" href="#_subfunctions" class="code">function jobSave( tDir, job, ind ) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0221 <span class="comment">% Helper: save job to temporary file for use with fevalDistrDisk()</span>
0222 save([tDir <a href="int2str2.html" class="code" title="function nstr = int2str2( n, nDigits )">int2str2</a>(ind,10) <span class="string">'-in'</span>],<span class="string">'job'</span>);
0223 <span class="keyword">end</span>
0224 
0225 <a name="_sub11" href="#_subfunctions" class="code">function r = jobLoad( tDir, ind, store )</a>
0226 <span class="comment">% Helper: load job and delete temporary files from fevalDistrDisk()</span>
0227 f=[tDir <a href="int2str2.html" class="code" title="function nstr = int2str2( n, nDigits )">int2str2</a>(ind,10)];
0228 <span class="keyword">if</span>(store), r=load([f <span class="string">'-out'</span>]); r=r.r; <span class="keyword">else</span> r=[]; <span class="keyword">end</span>
0229 fs={[f <span class="string">'-done'</span>],[f <span class="string">'-in.mat'</span>],[f <span class="string">'-out.mat'</span>]};
0230 delete(fs{:}); pause(.1);
0231 <span class="keyword">for</span> i=1:3, k=0; <span class="keyword">while</span>(exist(fs{i},<span class="string">'file'</span>)==2) <span class="comment">%#ok&lt;ALIGN&gt;</span>
0232     warning(<span class="string">'Waiting to delete %s.'</span>,fs{i}); <span class="comment">%#ok&lt;WNTAG&gt;</span>
0233     delete(fs{i}); pause(5); k=k+1; <span class="keyword">if</span>(k&gt;12), <span class="keyword">break</span>; <span class="keyword">end</span>;
0234   <span class="keyword">end</span>; <span class="keyword">end</span>
0235 <span class="keyword">end</span>
0236 
0237 <a name="_sub12" href="#_subfunctions" class="code">function msg = system2( cmd, show )</a>
0238 <span class="comment">% Helper: wraps system() call</span>
0239 <span class="keyword">if</span>(show), disp(cmd); <span class="keyword">end</span>
0240 [status,msg]=system(cmd); msg=msg(1:end-1);
0241 <span class="keyword">if</span>(status), error(msg); <span class="keyword">end</span>
0242 <span class="keyword">if</span>(show), disp(msg); <span class="keyword">end</span>
0243 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 05-May-2022 15:20:21 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>